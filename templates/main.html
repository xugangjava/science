{% extends "base.html" %}
{%block scripts%}core/main.js{% endblock %}
{%block body%}
<script type="text/javascript">
    function LoginOut(){
        window.parent.location.href="/loginout/";
    }
    
    function ShowPersonalInfo(){
          Ext.Ajax.request({ 
            url:'/user/details/',
            method:"post",
            params:{
                id:Main.UserID
            },
            success:function (response) {
                var json = Ext.util.JSON.decode(response.responseText);
                var win=new XG.Form.SimpelPoupForm({
                    title: '个人信息',
                    width:400,
                    height:270,
                    url:'/user/selfupdate/',
                    items:[
                        XG.UserFields.real_name,
                        XG.UserFields.password,
                        XG.UserFields.email,
                        XG.UserFields.sex,
                        XG.UserFields.phone,
                        XG.UserFields.mobile
                    ],
                    success:function(){
                        alert('修改成功');
                    }
                });
                win.fill(json);
                win.show(this);
            },
            failure:function (form, action) {
                if ('result' in action) {
                    if ('msg' in action.result) {
                        error(action.result.msg);
                    }
                }
                else {
                    error('发生异常!');
                }
            }
        });
    }
        
    function GoBackToWelcome(){
        Main.ClearTab();
        Main.tab_panel.setActiveTab(Main.welcome_tab);
    }
    function showDate(){
        var aa=new Date();
        var bb="今天是";
        bb+=aa.getFullYear()+"年"+(aa.getMonth()+1)+"月"+aa.getDate()+"日  ";
        bb+="星期"+'日一二三四五六'.charAt(aa.getDay())+" ";
        bb+=aa.getHours()+"时"+aa.getMinutes()+"分"+aa.getSeconds()+"秒";
        Ext.get("login_date").dom.innerHTML=bb;
        setTimeout("showDate()",1000);
    }

    Ext.ns('Main');
    Ext.onReady(function () {
        Ext.QuickTips.init();
        Main.UnitName='{{user.unit.name}}';
        Main.AuthLevel = '{{user.unit.level}}';
        Main.UserUnitID='{{user.unit_id}}';
        Main.ProjectTypes='{{project_types}}';
        Main.AdminPhone='{{admin_phone}}';
        Main.AdminRealName='{{admin_real_name}}';

        if(Main.ProjectTypes!='')
        {
            var arry=Main.ProjectTypes.split(';');
            var b;
            Main.ProjectTypes=[];
            for(var i=0;i<arry.length;i++)
            {
                b=arry[i].split(',');
                Main.ProjectTypes.push({
                    pk:parseInt(b[0]),
                    name:b[1]
                });
            }
        }
        Main.UserID='{{user.pk}}';
        var html='<div class="index_head_top_l"><img src="/static/newcss/images/main_logo.png" /></div>';
            html+='<div class="index_head_top_r">';
                html+='<div class="index_head_nav">';
                    html+='<ul>';
                        html+='<a href="javascript:ShowPersonalInfo()"><li class="user_info">个人信息</li></a>';
                        html+='<a href="javascript:GoBackToWelcome()"><li class="go_back">返回首页</li></a>';
                        html+='<a href="javascript:LoginOut()"><li class="quit">注销</li></a>';
                    html+='</ul>';
                html+='</div>';
            html+='</div>';
            html+='<div class="index_head_top_t">';
                html+='<div class="login_userinfo">欢迎<span>[{{user.real_name}}]</span>，您当前的角色为<span>[{{user.role_name}}]</span></div>';
                html+='<div class="login_date" id="login_date">今天是2013年7月24日 星期三  13:25:45</div>';
            html+='</div>';
        Ext.get("index_head").dom.innerHTML =html;
        showDate();
        Main.ShowApprovesWin=function(config){
            var sel= config.grid.getJsonArr();
            if(sel.length!=1){
                alert('请单选需要查看的项目！');
                return;
            }
            var pk=sel[0].json.pk;
            var baseParams={
                pk:pk
            };
            Ext.applyIf(baseParams,config,baseParams);
            var win=new Ext.Window({
                title:'审核历史记录',
                closable:true,
                closeAction:'close',
                modal:true,
                constrain:true,
                width:700,
                height:400,
                layout:'fit',
                items:[
                {
                    xtype:'basegrid',
                    url:config.url,
                    baseParams:baseParams,
                    notbar:true,
                    nocheck:true,
                    columes:config.columes,
                    // customize view config
                    viewConfig: {
                        forceFit:true,
                        enableRowBody:true,
                        showPreview:true,
                        getRowClass : function(record, rowIndex, p, store){
                            if(this.showPreview){
                                p.body = '<p>审核意见: '+record.data[config.option]+'</p>';
                                return 'x-grid3-row-expanded';
                            }
                            return 'x-grid3-row-collapsed';
                        }
                    }
                }]
            });
            win.show(this); 
        };

        Main.ShowProjectApplyApproveHistory=function(grid,hiddenExpert){
            Main.ShowApprovesWin({
                grid:grid,
                url:'/project/apply/approves/',
                columes:[
                    {header:'审核人', dataIndex:'approve__name', flex:1,
                        renderer:function(value, cellmeta, record, rowIndex, columnIndex, store){
                            if(hiddenExpert&&record.data['approve__role__name']=='专家'){
                                return '专家X';
                            }
                            return value;
                        }
                    },
                    {header:'角色', dataIndex:'approve__role__name', flex:1 },
                    {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                    {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                    {header:'审核时间', dataIndex:'approvetime', flex:1 },
                    {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                    {header:'专家评分', dataIndex:'expert_percent', flex:1 },
                    {header:'专家资助意见', dataIndex:'expert_support', flex:1 },
                    {dataIndex:'approve_opinion'}
                ],
                option:'approve_opinion'
            });
        };



        Main.ShowProjectExchangeApproveHistory=function(grid){
            Main.ShowApprovesWin({
                grid:grid,
                url:'/project/exchange/approves/',
                columes:[
                    {header:'审核人', dataIndex:'approve__name', flex:1 },
                    {header:'角色', dataIndex:'approve__role__name', flex:1 },
                    {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                    {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                    {header:'审核时间', dataIndex:'approvetime', flex:1 },
                    {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                    {dataIndex:'approve_opinion'}
                ],
                option:'approve_opinion'
            });
        };

        Main.ShowProjectEndApproveHistroy=function(grid){
            Main.ShowApprovesWin({
                grid:grid,
                url:'/project/end/approves/',
                columes:[
                    {header:'审核人', dataIndex:'approve__name', flex:1 },
                    {header:'角色', dataIndex:'approve__role__name', flex:1 },
                    {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                    {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                    {header:'审核时间', dataIndex:'approvetime', flex:1 },
                    {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                    {dataIndex:'approve_opinion'}
                ],
                option:'approve_opinion'
            });
        };

        Main.ShowProjectRollbackApproveHistroy=function(grid){
            Main.ShowApprovesWin({
                grid:grid,
                url:'/project/back/approves/',
                columes:[
                    {header:'审核人', dataIndex:'approve__name', flex:1 },
                    {header:'角色', dataIndex:'approve__role__name', flex:1 },
                    {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                    {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                    {header:'审核时间', dataIndex:'approvetime', flex:1 },
                    {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                    {dataIndex:'approve_opinion'}
                ],
                option:'approve_opinion'
            });
        };


    });
</script>
{%ifequal user.role.code 'admin'%}
<script type="text/javascript">
Ext.onReady(function () {
    var root = Main.tree.getRootNode();
    var node;
    var pk;
    Ext.TaskMgr.start({
        run: function(){
            Ext.Ajax.request({  
                url:'/user/notify/count/',
                method:'post',  
                success:function(response,options){
                    var res = Ext.util.JSON.decode(response.responseText);  
                    for (var j = root.childNodes.length - 1; j >= 0; j--) {
                        var r=root.childNodes[j];
                        var childrens=r.childNodes;//项目申请
                        for (var i = childrens.length - 1; i >= 0; i--) {
                            var n=childrens[i];
                            if(n.text.indexOf('项目立项')!=-1)
                                n.setText('项目立项('+res.apply+')');
                            else if(n.text.indexOf('项目评审')!=-1)
                                n.setText('项目评审('+res.apply_ask_expert+')');
                            else if(n.text.indexOf('项目变更')!=-1)
                                n.setText('项目变更('+res.exchange+')');
                            else if(n.text.indexOf('项目结项')!=-1)
                                n.setText('项目结项('+res.end+')');
                            else if(n.text.indexOf('项目退回')!=-1)
                                n.setText('项目退回('+res.back+')');
                            else if(n.text.indexOf('项目审查')!=-1)
                                n.setText('项目审查('+res.look+')');
                            else if(n.text.indexOf('用户审核')!=-1)
                                n.setText('用户审核('+res.user_approve+')');
                            else if(n.text.indexOf('单位审核')!=-1)
                                n.setText('单位审核('+res.unit_approve+')');
                        }
                    };
                }
            });
        },
        interval: 3000
    });

    Main.ShowAdminApprovedWin=function(config){
        var win=new Ext.Window({
            title:config.text,
            closable:true,
            closeAction:'close',
            modal:true,
            constrain:true,
            width:700,
            height:400,
            layout:'fit',
            items:[
            {
                xtype:'basegrid',
                url:config.url,
                notbar:true,
                nocheck:true,
                columes:config.columes,
                // customize view config
                viewConfig: {
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p style="word-wrap:break-word;">审核意见: '+record.data[config.option]+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                },
                tbar:config.tbar
            }]
        });
        win.show(this); 
    };

    Main.ShowAdminProjectApplyApproveHistory=function(grid,pass,build,text){
        if(null==pass)pass=-1;
        if(null==build)build=-1;
        var initConfig={
            text:text,
            grid:grid,
            url:'/project/admin/apply/approves/?pass='+pass+'&build='+build,
            columes:[

                {header:'项目名称',dataIndex:'details__project_name',flex:1},
                {header:'项目编号',dataIndex:'details__project_no',flex:1},
                {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                {header:'审核时间', dataIndex:'approvetime', flex:1 },
                {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                {dataIndex:'approve_opinion'}
            ],
            option:'approve_opinion'
        };
        if(build==1){
            initConfig.tbar=[{
                text:'导出Excel',
                iconCls:'Pagewhiteexcel',
                handler:function(){
                    window.open('/project/admin/project/done/xls/export/');
                }
            }]
        }
        Main.ShowAdminApprovedWin(initConfig);
    };

    Main.ShowAdminProjectExchangeApproveHistory=function(grid,pass,text){
        if(pass==null)pass=-1;
        Main.ShowAdminApprovedWin({
            text:text,
            grid:grid,
            url:'/project/admin/exchange/approves/?pass='+pass,
            columes:[
                {header:'项目名称',dataIndex:'details__project__name',flex:1},
                {header:'项目编号',dataIndex:'details__project__no',flex:1},
                {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                {header:'审核时间', dataIndex:'approvetime', flex:1 },
                {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                {dataIndex:'approve_opinion'}
            ],
            option:'approve_opinion'
        });
    };

    Main.ShowAdminProjectEndApproveHistroy=function(grid,pass,text){
        if(pass==null)pass=-1;
        Main.ShowAdminApprovedWin({
            text:text,
            grid:grid,
            url:'/project/admin/end/approves/?pass='+pass,
            columes:[
                {header:'项目名称',dataIndex:'details__project__name',flex:1},
                {header:'项目编号',dataIndex:'details__project__no',flex:1},
                {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                {header:'审核时间', dataIndex:'approvetime', flex:1 },
                {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                {dataIndex:'approve_opinion'}
            ],
            option:'approve_opinion'
        });
    };


    Main.ShowAdminSendApproveHistroy=function(config){
        var win=new Ext.Window({
            title:config.text,
            closable:true,
            closeAction:'close',
            modal:true,
            constrain:true,
            width:700,
            height:400,
            layout:'fit',
            items:[
            {
                xtype:'basegrid',
                url:config.url,
                notbar:true,
                nocheck:true,
                columes:config.columes,
                tbar:config.tbar,
                viewConfig: {
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>送审专家: '+record.data['expert_names']+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                }
            }]
        });
        win.show(this);
    };

    node = {
        text:'项目审核',
        expanded:true,
        leaf:false,
        iconCls:'Monitor',
        children:[]
    };


    if(0==Main.AuthLevel){
        node.children.push({
            text:'项目审查',
            leaf:true,
            iconCls:'Monitorkey',
            list:{
                id:'admin_project_option_gird',
                url:"/project/apply/list/",
                columes:[
                    {
                        header:'项目名称', 
                        dataIndex:'project_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'审核状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {header:'学科分类', dataIndex:'study_type_name', flex:1},
                    {header:'PDF',flex:1,dataIndex:'pk', width:50,
                        renderer:function(value){
                           return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    }
                ],
                tbar:{
                    project_apply_type_combo:{p_types:Main.ProjectTypes},
                    approve_row:{
                        title:"项目审查",
                        url:'/project/apply/approve/', 
                        iconCls:'Useralert',
                        optionText:'审查意见',
                        argreeText:'同意',
                        disargreeText:'拒绝',
                        items:[{xtype:'hidden',name:'wait_admin_look',value:1}]
                    },
                    handlers:[
                        {
                            text:'查看审核历史记录',
                            iconCls:'Bookopen',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                Main.ShowProjectApplyApproveHistory(grid);
                            }
                        },
                        {
                            text:'未通过项目',
                            iconCls:'Bookkey',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                Main.ShowAdminProjectApplyApproveHistory(grid,0,null,this.text);
                            }
                        },
                        {
                            text:'已通过项目',
                            iconCls:'Bookprevious',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                Main.ShowAdminProjectApplyApproveHistory(grid,1,null,this.text);
                            }
                        }
                    ]
                },
                listeners:{
                    cellclick:DefaultCellHanlder({
                        applyPdfIdx:7,
                        applyIdx:1
                    })
                },
                baseParams:{
                    wait_admin_look:0
                }
            }
        });

        node.children.push({
            text:'项目评审',
            leaf:true,
            iconCls:'Monitorlink',
            list:{
                id:'admin_project_option_gird',
                url:"/project/apply/list/",
                columes:[
                    {
                        header:'项目名称', 
                        dataIndex:'project_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'审核状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {header:'学科分类', dataIndex:'study_type_name', flex:1},
                    {header:'接收/送审',flex:1,
                    renderer:function(value, cellmeta, record, rowIndex, columnIndex, store){
                        return record.data['expert_post_num']+'/'+record.data['expert_recv_num']
                    }},
                    {header:'平均分', dataIndex:'expert_percent', flex:1,
                        renderer:function(value){
                            return '<img src="/static/icons/zoom.png"/>'+value;
                        }
                    },
                    {header:'PDF',flex:1,dataIndex:'pk', width:50,
                        renderer:function(value){
                            return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    },
                    {dataIndex:'expert_post_num'},
                    {dataIndex:'expert_recv_num'}
                ],
                tbar:{
                    project_apply_type_combo:{p_types:Main.ProjectTypes},
                    handlers:[
                        {
                            text:'选择专家评审',
                            iconCls:'Useralert',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                var r=grid.getJsonArr();
                                if(r.length<1){
                                    alert('未选中任何项目！');
                                    return;
                                };
                                var type=r[0].data.study_type_name;
                                for(var i=0;i<r.length;i++){
                                    if(type!=r[i].data.study_type_name){
                                        alert('请选择学科代号相同的项目！')
                                        return;
                                    }
                                };
                                win=new Ext.Window({
                                    title:'选择专家评审',
                                    closable:true,
                                    closeAction:'close',
                                    width:350,
                                    minWidth:200,
                                    height:200,
                                    layout:{type:'absolute'},
                                    modal:true,
                                    items:[
                                        {xtype:"label", text:"选择专家:", x:5, y:5},
                                        {
                                            x:65, 
                                            y:5,
                                            name:'expert_ids',
                                            id:'amind_set_extpert_ids',
                                            allowBlank:false,
                                            xtype:'superboxselect',
                                            emptyText: '选择该学科的专家',
                                            resizable: true,
                                            minChars: 2,
                                            store:{
                                                xtype: 'jsonstore',
                                                totalProperty:'total',
                                                idProperty:'pk',
                                                fields:['pk','name'],
                                                root:'items',
                                                url:'/expert/combo/',
                                                baseParams:{
                                                    type:type
                                                }
                                            },
                                            mode: 'remote',
                                            displayField: 'name',
                                            valueField: 'pk',
                                            queryDelay: 0,
                                            triggerAction: 'all'
                                        }
                                    ],
                                    buttons:[{
                                        text:'确定',
                                        handler:function(){
                                            var expert_ids=win.items.itemAt(1).getValue();
                                            if(expert_ids==""||expert_ids.length<1){
                                                alert('请选择专家！')
                                                return;
                                            }
                                            var idArr = grid.getIdArr();
                                            win.close();
                                            mask("正在发送保存并发送邮件提示!<br/>请稍等......");
                                            Ext.Ajax.request({
                                                    url:'/expert/set/',
                                                    method:"post",
                                                    params:{
                                                        ids:idArr.join(),
                                                        expert_ids:expert_ids
                                                    },
                                                    success:function () {
                                                        unmask();
                                                        win.close();
                                                        grid.getStore().load();
                                                        alert('设置成功!等待专家评审');
                                                       
                                                    },
                                                    failure:function (form, action) {
                                                        unmask();
                                                        win.close();
                                                        if ('result' in action) {
                                                            if ('msg' in action.result) {
                                                                error(action.result.msg);
                                                            }
                                                        }
                                                        else {
                                                            error('发生异常!');
                                                        }
                                                    }
                                                });
                                        }
                                    }]
                                });
                                win.show(this);
                            }
                        },
                        {
                            text:'查看审核历史记录',
                            iconCls:'Bookopen',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                Main.ShowProjectApplyApproveHistory(grid);
                            }
                        },
                        {
                            text:'送审项目',
                            iconCls:'Bookprevious',
                            handler:function(){

                                Main.ShowAdminSendApproveHistroy({
                                    text:this.text,
                                    url:'/project/setexpert/apply/list/',
                                    columes:[
                                        {
                                            header:'项目名称', 
                                            dataIndex:'project_name', 
                                            flex:1,
                                            renderer:function(value){
                                               return '<img src="/static/icons/zoom.png"/>'+value;
                                            }.createDelegate(this)
                                        },
                                        {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                                        {header:'项目编号', dataIndex:'project_no', flex:1 },
                                        {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                                        {header:'审核状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                                        {header:'学科分类', dataIndex:'study_type_name', flex:1},
                                        {header:'PDF',flex:1,dataIndex:'pk', width:50,
                                            renderer:function(value){
                                               return '<img src="/static/icons/page_white_acrobat.png"/>';
                                            }.createDelegate(this)
                                        },
                                        {dataIndex:'expert_names'}
                                    ],
                                    listeners:{
                                        cellclick:DefaultCellHanlder({
                                            applyPdfIdx:7,
                                            applyIdx:1
                                        })
                                    }
                                });
                            }
                        },{
                            text:'结束评审',
                            iconCls:'Useralert',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                var idArr=grid.getIdArr();
                                if(idArr.length==0)return;
                 
                                Ext.Ajax.request({
                                    url:'/project/apply/endexperttalk/',
                                    params:{
                                        ids:idArr.join()
                                    },
                                    success:function (response) {
                                        alert('项目已经结束审核,进入立项阶段!');
                                        grid.getStore().reload();
                                    },
                                    failure:function (form, action) {
                                        if ('result' in action){
                                            if ('msg' in action.result){
                                                error(action.result.msg);
                                            }
                                        }else{
                                            error('发生异常!');
                                        }
                                    }
                                });
                            }
                        }
                    ]
                },
                listeners:{
                    cellclick:DefaultCellHanlder({
                        applyPdfIdx:9,
                        applyIdx:1,
                        showExpertIdx:8
                    })
                },
                baseParams:{
                    admin_ask_expert:0
                }
            }
        });
    }

    node.children.push({
        text:'项目立项',
        leaf:true,
        iconCls:'Monitoradd',
        list:{
            id:'admin_project_apply_list',
            url:"/project/apply/list/",
            columes:[
                {
                    header:'项目名称', 
                    dataIndex:'project_name', 
                    flex:1,
                    renderer:function(value){
                       return '<img src="/static/icons/zoom.png"/>'+value;
                    }.createDelegate(this)
                },
                {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                {header:'项目编号', dataIndex:'project_no', flex:1 },
                {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                {header:'审核状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                {header:'学科分类', dataIndex:'study_type_name', flex:1},
                {header:'专家评分', dataIndex:'expert_percent', flex:1},
                
                {header:'PDF',flex:1,dataIndex:'pk', width:50,
                    renderer:function(value){
                       return '<img src="/static/icons/page_white_acrobat.png"/>';
                    }.createDelegate(this)
                }
            ],
            listeners:{
                cellclick:DefaultCellHanlder({
                    applyIdx:1,
                    applyPdfIdx:7
                })
            },
            tbar:{
                project_apply_type_combo:{p_types:Main.ProjectTypes},
                approve_row:{ 
                    title:"审核立项申请",
                    url:'/project/apply/approve/', 
                    iconCls:'Useralert',
                    width:425,
                    height:260,
                    argreeText:'同意立项',
                    items:[
                        {xtype:'hidden',name:'wait_admin_look',value:0},
                        {
                            fieldLabel:'资助结果',
                            xtype:'localcombo',
                            name:'admin_support',
                            hidden:Main.AuthLevel!=0,
                            data:[
                            ['自筹','自筹'],
                            ['资助','资助']]
                        }
                    ]
                },
                handlers:[
                    {
                        text:'查看审核历史记录',
                        iconCls:'Bookopen',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_apply_list');
                            Main.ShowProjectApplyApproveHistory(grid);
                        }
                    },
                    {
                        text:'已立项的项目',
                        iconCls:'Bookkey',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_apply_list');
                            Main.ShowAdminProjectApplyApproveHistory(grid,-1,1,this.text);
                        }
                    },
                    {
                        text:'未立项的项目',
                        iconCls:'Bookprevious',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_apply_list');
                            Main.ShowAdminProjectApplyApproveHistory(grid,-1,0,this.text);
                        }
                    }
                ]
            }
        }
    });
    
    



    node.children.push({
        text:'项目变更',
        leaf:true,
        iconCls:'Monitoredit',
        list:{
            id:'admin_project_exchange_gird',
            url:"/project/exchange/list/",
            columes:[
                {header:'项目名称', dataIndex:'project_name', flex:1},
                {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                {header:'项目编号', dataIndex:'project_no', flex:1 },
                {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                {header:'项目状态', dataIndex:'project_status', flex:1, renderer:XG.Render.ProjectStatus },
                {header:'申请变更状态', dataIndex:'forward_status', flex:1, renderer:XG.Render.ProjectStatus },
                {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                {dataIndex:'applicant_opinion'}
            ],
            tbar:{
                approve_row:{ title:"审核项目变更申请",url:'/project/exchange/approve/', iconCls:'Useralert'},
                handlers:[
                    {
                        text:'查看审核历史记录',
                        iconCls:'Bookopen',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_exchange_gird');
                            Main.ShowProjectExchangeApproveHistory(grid);
                        }
                    },
                    {
                        text:'同意变更',
                        iconCls:'Bookkey',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_exchange_gird');
                            Main.ShowAdminProjectExchangeApproveHistory(grid,1,this.text);
                        }
                    },
                    {
                        text:'不准变更',
                        iconCls:'Bookprevious',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_exchange_gird');
                            Main.ShowAdminProjectExchangeApproveHistory(grid,0,this.text);
                        }
                    }
                ]
            },
            viewConfig:{
                forceFit:true,
                enableRowBody:true,
                showPreview:true,
                getRowClass : function(record, rowIndex, p, store){
                    if(this.showPreview){
                        p.body = '<p>申请原因: '+record.data.applicant_opinion+'</p>';
                        return 'x-grid3-row-expanded';
                    }
                    return 'x-grid3-row-collapsed';
                }
            }
        }
    });

    //科技局管理员 无需审核
    if(0!=Main.AuthLevel)
    {
        node.children.push({
        text:'项目退回',
        leaf:true,
        iconCls:'Monitorlightning',
        list:{
                id:'admin_project_rollback_gird',
                url:"/project/rollback/list/",
                columes:[
                    {header:'项目名称', dataIndex:'project_name', flex:1},
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {dataIndex:'applicant_opinion'}
                ],
                viewConfig:{
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>申请原因: '+record.data.applicant_opinion+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                },
                tbar:{
                    approve_row:{ 
                        title:"审核项目退回申请",
                        url:'/project/rollback/approve/', 
                        iconCls:'Useralert'  
                    },
                    handlers:[
                        {
                            text:'查看审核历史记录',
                            iconCls:'Bookopen',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_rollback_gird');
                                Main.ShowProjectRollbackApproveHistroy(grid);
                            }
                        },
                        {
                            text:'查看已审核的记录',
                            iconCls:'Bookprevious',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_rollback_gird');
                                Main.ShowProjectRollbackApproveHistroy(grid);
                            }
                        }
                    ]
                }
            }
        });
    }

    

    node.children.push({
        text:'项目结项',
        leaf:true,
        iconCls:'Monitorgo',
        list:{
            url:"/project/end/list/",
            id:'admin_project_end_gird',
            columes:[
                {
                    header:'最终成果名称', dataIndex:'final_achieve_name', flex:1,
                    renderer:function(value){
                       return '<img src="/static/icons/zoom.png"/>'+value;
                    }.createDelegate(this)
                },
                {header:'项目编号', dataIndex:'project__no', flex:1},
                {header:'主要参加人', dataIndex:'main_user_name', flex:1 },
                {header:'计划完成时间', dataIndex:'plain_end_time', flex:1 },
                {header:'实际完成时间', dataIndex:'real_end_time', flex:1 },
                {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                {header:'PDF',flex:1,dataIndex:'document_id', width:50,
                    renderer:function(value){
                       return '<img src="/static/icons/page_white_acrobat.png"/>';
                    }.createDelegate(this)
                }
            ],
            listeners:{
                cellclick:DefaultCellHanlder({
                    pdfIdx:7,
                    applyIdx:1
                })
            },
            tbar:{
                approve_row:{
                    title:"审核结项项目申请", 
                    url:'/project/end/approve/', 
                    iconCls:'Useralert'
                },
                handlers:[
                    {
                        text:'查看审核历史记录',
                        iconCls:'Bookopen',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_end_gird');
                            Main.ShowProjectEndApproveHistroy(grid);
                        }
                    },
                    {
                        text:'结项项目',
                        iconCls:'Bookkey',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_end_gird');
                            Main.ShowAdminProjectEndApproveHistroy(grid,1,this.text);
                        }
                    },
                    {
                        text:'未结项目',
                        iconCls:'Bookprevious',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_end_gird');
                            Main.ShowAdminProjectEndApproveHistroy(grid,0,this.text);
                        }
                    }
                ]
            }
        }
    });

    root.appendChild(node);
    node={
        text:'查询统计',
        expanded:true,
        leaf:false,
        iconCls:'Chartbar',
        children:[]
    };
    node.children.push({
        text:'项目检索',
        leaf:true,
        iconCls:'Serverchart',
        list:{
            url:"/project/search/",
            nocheck:true,
            id:'project_search_grid',
            columes:[
                {
                    header:'项目名称',
                    dataIndex:'name', 
                    flex:1,
                    renderer:function(value){
                       return '<img src="/static/icons/zoom.png"/>'+value;
                    }.createDelegate(this)
                },
                {header:'项目类型', dataIndex:'ptype__name', flex:1},
                {header:'项目编号', dataIndex:'no', flex:1 },
                {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                {header:'状态', dataIndex:'status', flex:1, renderer:function(value){
                    var status=Ext.getCmp('project_search_value_status').getValue();
                    if(status==3){
                        return XG.Render.ApproveStatus(value);
                    }
                    else{
                        return XG.Render.ProjectStatus(value);
                    }
                    
                }},
                {
                    header:'PDF',
                    flex:1,
                    dataIndex:'pk',
                    width:50,
                    renderer:function(value){
                       return '<img src="/static/icons/page_white_acrobat.png"/>';
                    }.createDelegate(this)
                }
            ],
            tbar:[
                "搜索条件",
                {   
                    xtype:'localcombo',
                    id:'text_project_search_key',
                    data:[
                    ['name','项目名称'],
                    ['applicant__name','申请人姓名'],
                    ['applicant_time','项目申请时间'],
                    ['unit__name','项目所属单位']],
                    listeners:{
                        select:function(box, record, index){
                            if(index==2){
                                Ext.getCmp('text_project_search_value').hide();
                                Ext.getCmp('project_search_value_start_date').show();
                                Ext.getCmp('project_search_value_end_date').show();
                                Ext.getCmp('project_search_lable').el.dom.innerHTML='起止时间';
                            }else{
                                Ext.getCmp('text_project_search_value').show();
                                Ext.getCmp('project_search_value_start_date').hide();
                                Ext.getCmp('project_search_value_end_date').hide();
                                Ext.getCmp('project_search_lable').el.dom.innerHTML='包含内容';
                            }
                        }
                    }
                },
                "-",
                {
                    xtype:'label',
                    id:'project_search_lable',
                    text:"包含内容"
                },
                {
                    xtype:'textfield',
                    id:'text_project_search_value'
                },

                DefaultDateFeild({
                    id:'project_search_value_start_date',
                    endDateField: 'project_search_value_end_date',
                    width:200,
                    hidden :true,
                    vtype:'daterange'
                }),
                DefaultDateFeild({
                    vtype:'daterange',
                    id:'project_search_value_end_date',
                    width:200,
                    hidden :true,
                    startDateField: 'project_search_value_start_date'
                }),

                "查询类型",
                {
                    xtype:'localcombo',
                    id:"project_search_value_status",
                    data:[
                        [2,'全部'],
                        [0,'正常'],
                        [1,'结项'],
                        [-5,'撤项'],
                        [-6,'延期'],
                        [-7,'退回'],
                        [3,'待审核的项目申请'],
                        [4,'待审核的变更申请'],
                        [5,'待审核的结项申请']
                    ]
                },
                {
                    xtype:'button',
                    text:'搜索',
                    iconCls:'zoom',
                    handler:function(){
                        var value=Ext.getCmp('text_project_search_value').getValue();
                        var key=Ext.getCmp('text_project_search_key').getValue();
                        var start_time=Ext.getCmp('project_search_value_start_date').value;
                        var end_time=Ext.getCmp('project_search_value_end_date').value;
                        var status=Ext.getCmp('project_search_value_status').getValue();
                        if(key=='applicant_time'){
                            if(start_time==""||end_time=="")
                            {
                                alert('请选择完整的起止时间！');
                                return;
                            }
                        }
                        var grid=Ext.getCmp('project_search_grid');
                        grid.getStore().load({
                            params:{
                                key:key,
                                value:value,
                                status:status,
                                start_time:start_time,
                                end_time:end_time,
                                start:0,
                                limit:20
                            }
                        });

                    }
                },
                {
                    text:'导出Excel',
                    iconCls:'Pagewhiteexcel',
                    handler:function(){
                        window.open('/project/admin/project/search/xls/export/');
                    }
                }
            ],
            listeners:{
                cellclick:DefaultCellHanlder({
                    pdf:5,
                    projectIdx:0
                })
            }
        }
    });

    Ext.chart.Chart.CHART_URL = '/static/charts.swf';
    node.children.push({
        text:'项目统计',
        leaf:true,
        iconCls:'Chartpie',
        view:{
            xtype:'panel',
            layout:'fit',
            items:[{
                store: new Ext.data.JsonStore({
                    fields: ['season', 'total'],
                    data: [{
                        season: '正常项目数量',
                        total: 0
                    },{
                        season: '延期项目数量',
                        total: 0
                    },{
                        season: '撤项项目数量',
                        total: 0
                    },{
                        season: '正常项目数量',
                        total: 0
                    }]
                }),
                id:'project_count',
                xtype: 'piechart',
                dataField: 'total',
                categoryField: 'season',
                extraStyle:
                {
                    legend:
                    {
                        display: 'bottom',
                        padding: 5,
                        font:
                        {
                            family: 'Tahoma',
                            size: 13
                        }
                    }
                }
            }],
            tbar:[
                "统计条件",
                {   
                    xtype:'localcombo',
                    id:'text_project_count_key',
                    data:[
                    ['name','项目名称'],
                    ['applicant__name','申请人姓名'],
                    ['applicant_time','项目申请时间'],
                    ['unit__name','项目所属单位']],
                    listeners:{
                        select:function(box, record, index){
                            if(index==2){
                                Ext.getCmp('text_project_count_value').hide();
                                Ext.getCmp('project_count_value_start_date').show();
                                Ext.getCmp('project_count_value_end_date').show();
                                Ext.getCmp('project_count_lable').el.dom.innerHTML='起止时间';
                            }else{
                                Ext.getCmp('text_project_count_value').show();
                                Ext.getCmp('project_count_value_start_date').hide();
                                Ext.getCmp('project_count_value_end_date').hide();
                                Ext.getCmp('project_count_lable').el.dom.innerHTML='包含内容';
                            }
                        }
                    }
                },
                "-",
                {
                    xtype:'label',
                    id:'project_count_lable',
                    text:"包含内容"
                },
                {
                    xtype:'textfield',
                    id:'text_project_count_value'

                },
                DefaultDateFeild({
                    id:'project_count_value_start_date',
                    endDateField: 'project_count_value_end_date',
                    width:200,
                    hidden :true,
                    vtype:'daterange'
                }),
                DefaultDateFeild({
                    vtype:'daterange',
                    id:'project_count_value_end_date',
                    width:200,
                    hidden :true,
                    startDateField: 'project_count_value_start_date'
                }),
                {
                    xtype:'button',
                    text:'统计',
                    iconCls:'zoom',
                    handler:function(){
                        var value=Ext.getCmp('text_project_count_value').getValue();
                        var key=Ext.getCmp('text_project_count_key').getValue();
                        
                        var start_time=Ext.getCmp('project_count_value_start_date').value;
                        var end_time=Ext.getCmp('project_count_value_end_date').value;


                        Ext.Ajax.request({
                            url:'/project/count/',
                            params:{
                                key:key,
                                value:value,
                                start_time:start_time,
                                end_time:end_time
                            },
                            success:function (response) {
                                var json= Ext.util.JSON.decode(response.responseText);
                                var chart=Ext.getCmp('project_count');
                                var data=[{
                                    season: '正常项目数量',
                                    total: json.normal
                                },{
                                    season: '延期项目数量',
                                    total: json.lazy
                                },{
                                    season: '撤项项目数量',
                                    total: json.undo
                                },{
                                    season: '退回项目数量',
                                    total: json.postback
                                }];

                                chart.store.loadData(data);

                            },
                            failure:function (form, action) {
                                if ('result' in action){
                                    if ('msg' in action.result){
                                        error(action.result.msg);
                                    }
                                }else{
                                    error('发生异常!');
                                }
                            }
                        });
                    }
                }
            ]
        }
    });
    root.appendChild(node);


    node = {
        text:'用户管理',
        expanded:true,
        leaf:false,
        iconCls:'Driveuser',
        children:[]
    };


    node.children.push({
        leaf:true,
        text:'用户列表',
        iconCls:'Group',
        list:{
            url:'/user/list/',
            columes:[
                {header:'用户名', dataIndex:'name', flex:1},
                {header:'姓名', dataIndex:'real_name', flex:1},
                {header:'单位', dataIndex:'unit__name', flex:1},
                {dataIndex:'unit__level'},
                {header:'上级单位', dataIndex:'unit__parent_unit__name', flex:1},
                {header:'角色', dataIndex:'role__name', flex:1, renderer:function (value, p, record) {
                    return  XG.Render.UnitLevel(record.get('unit__level')) + value;
                }}],
            tbar:{}
        }
    });
    
    node.children[0].list.tbar.add_row = {
        form:{
            url:"/user/add/",
            title:"添加用户",
            width:500,
            height:420,
            items:[
                XG.UserFields.regname,
                XG.UserFields.password,
                XG.UserFields.real_name,
                {
                    fieldLabel:'所在单位',
                    name:'unit_id',
                    id:'add_user_unit_combo',
                    url:'/unit/combo/?show_parent=1',
                    baseParams:{
                        show_parent:1
                    },
                    xtype:'remotecombo',
                    listeners:{
                        select:function(box, record, index){
                            if(Main.AuthLevel==0)return;
                            var unit=record.json;
                            var role_combo=Ext.getCmp('add_user_role_combo');
                            var role=role_combo.getRawValue();
                            if(unit.pk==Main.UserUnitID&&role=='系统管理员'){
                                alert('无法添加本单位管理员');
                                var data=role_combo.getStore().data.items;
                                for(var i=0;i<data.length;i++){
                                    var json=data[i].json;
                                    if(json.name=='系统管理员')continue;
                                    role_combo.setValue(json.pk);
                                    break;
                                }
                            }
                        }
                    }
                },
                {
                    fieldLabel:'用户角色',
                    name:'role_id',
                    url:'/role/combo/',
                    xtype:'remotecombo',
                    id:'add_user_role_combo',
                    listeners:{
                        select:function(box, record, index){
                            var role=record.json;
                            if(role.name!='专家'){
                                Ext.getCmp('add_user_study_type_name').hide();
                            }else{
                                Ext.getCmp('add_user_study_type_name').show();
                            }
                            if(Main.AuthLevel==0)return;
                            var unit_combo=Ext.getCmp('add_user_unit_combo');
                            var unit_id=unit_combo.getValue();
                            var role_combo=Ext.getCmp('add_user_role_combo');
                            if(role.name=='系统管理员'&&unit_id==Main.UserUnitID){
                                alert('无法添加本单位管理员');
                                var data=role_combo.getStore().data.items;
                                for(var i=0;i<data.length;i++){
                                    var json=data[i].json;
                                    if(json.name=='系统管理员')continue;
                                    role_combo.setValue(json.pk);
                                    break;
                                }
                            }
                        }

                    }
                },
                {fieldLabel:'学科编号', name:'study_type_name',id:'add_user_study_type_name',allowBlank:true},
                XG.UserFields.sex,
                XG.UserFields.phone,
                XG.UserFields.mobile,
                XG.UserFields.remark]
        }
    };

    node.children[0].list.tbar.update_row ={
        form:{
            url:"/user/update/",
            title:"修改用户",
            width:500,
            height:420,
            items:[
                XG.UserFields.pk,
                XG.UserFields.name,
                XG.UserFields.password,
                XG.UserFields.email,
                XG.UserFields.real_name,
                {fieldLabel:'学科编号', name:'study_type_name',id:'update_user_study_type_name',allowBlank:true},
                {
                    fieldLabel:'所在单位',
                    name:'unit_id',
                    id:'edit_user_unit_combo',
                    url:'/unit/combo/?show_parent=1',
                    xtype:'remotecombo',
                    listeners:{
                        select:function(box, record, index){
                            if(Main.AuthLevel==0)return;
                            var unit=record.json;
                            var role_combo=Ext.getCmp('edit_user_role_combo');
                            var role=role_combo.getRawValue();
                            if(unit.pk==Main.UserUnitID&&role=='系统管理员'){
                                alert('无法添加本单位管理员');
                                var data=role_combo.getStore().data.items;
                                for(var i=0;i<data.length;i++){
                                    var json=data[i].json;
                                    if(json.name=='系统管理员')continue;
                                    role_combo.setValue(json.pk);
                                    break;
                                }
                            }
                        }
                    }
                },
                {
                    fieldLabel:'用户角色',
                    name:'role_id',
                    url:'/role/combo/',
                    xtype:'remotecombo',
                    id:'edit_user_role_combo',
                    listeners:{
                        select:function(box, record, index){
                            var role=record.json;
                            if(role.name!='专家'){
                                Ext.getCmp('update_user_study_type_name').hide();
                            }else{
                                Ext.getCmp('update_user_study_type_name').show();
                            }
                            if(Main.AuthLevel==0)return;
                            var unit_combo=Ext.getCmp('edit_user_unit_combo');
                            var unit_id=unit_combo.getValue();
                            var role_combo=Ext.getCmp('edit_user_role_combo');
                            if(role.name=='系统管理员'&&unit_id==Main.UserUnitID){
                                alert('无法添加本单位管理员');
                                var data=role_combo.getStore().data.items;
                                for(var i=0;i<data.length;i++){
                                    var json=data[i].json;
                                    if(json.name=='系统管理员')continue;
                                    role_combo.setValue(json.pk);
                                    break;
                                }
                            }
                        },
                        render:function(){
                            var rolename=Ext.getCmp('edit_user_role_combo').lastSelectionText;
                            if(rolename!='专家'){
                                Ext.getCmp('update_user_study_type_name').hide();
                            }else{
                                Ext.getCmp('update_user_study_type_name').show();
                            }
                        }
                    }
                },
                XG.UserFields.sex,
                XG.UserFields.phone,
                XG.UserFields.mobile,
                XG.UserFields.remark
            ]},
        url:'/user/details/'
    };

    node.children[0].list.tbar.del_row ={
        url:'/user/del/',
        iconCls:'Databasedelete'
    };


    node.children.push({
        leaf:true,
        text:'用户审核',
        iconCls:'Userkey',
        list:{
            url:'/user/list/approve/',
            columes:[
                {header:'用户名', dataIndex:'name', flex:1},
                {header:'姓名', dataIndex:'name', flex:1},
                {header:'单位', dataIndex:'unit__name', flex:2},
                {header:'单位级别', dataIndex:'unit__level', flex:1, renderer:XG.Render.UnitLevel},
                {header:'上级单位', dataIndex:'unit__parent_unit__name', flex:2 },
                {header:'注册时间', dataIndex:'regtime', flex:1 }
            ],
            tbar:{}
        }
    });

    node.children[1].list.tbar.approve_row = {
        title:"审核项目申请人",
        url:'/user/approve/',
        iconCls:'Useralert'
    };

    root.appendChild(node);


    if (0 == Main.AuthLevel) {
        root.appendChild({
            text:'项目类型管理',
            expanded:true,
            iconCls:'Applicationsidetree',
            leaf:false,
            children:[{
                leaf:true,
                text:'项目种类',
                iconCls:'Applicationformedit',
                list:{
                    url:"/projecttype/list/",
                    columes:[
                        {header:'项目类型名称', dataIndex:'name',expend:true},
                        {header:'项目预警天数(距项目期限小于等于天数,系统自动提示申请人)', dataIndex:'waring_day', width:120},
                        {header:'是否允许申报',dataIndex:'allow_apply',width:120,renderer:function(value){return value?'允许':'不允许'}},
                        {header:'最大项目数量', dataIndex:'max_project_num'}
                    ],
                    tbar:{
                        add_row:{
                            form:{
                                url:"/projecttype/add/",
                                title:"添加项目类型",
                                width:400,
                                height:380,
                                items:[
                                    XG.ProjectTypeFields.name,
                                    XG.ProjectTypeFields.waring_day,
                                    XG.ProjectTypeFields.allow_apply,
                                    XG.ProjectTypeFields.max_project_num
                                ]
                            }
                        },
                        update_row:{
                            form:{
                                url:"/projecttype/update/",
                                title:"修改项目类型",
                                width:400,
                                height:280,
                                items:[
                                    XG.ProjectTypeFields.pk,
                                    XG.ProjectTypeFields.name,
                                    XG.ProjectTypeFields.waring_day,
                                    XG.ProjectTypeFields.allow_apply,
                                    XG.ProjectTypeFields.max_project_num
                                ]
                            },
                            url:'/projecttype/details/'
                        },
                        del_row:{
                            url:'/projecttype/del/',
                            iconCls:'Databasedelete'
                        }
                    }
                }
            }]
        });
   
    }
    if(2!=Main.AuthLevel)
    {   
        node = {
            text:'单位管理',
            expanded:true,
            leaf:false,
            iconCls:'House',
            children:[]
        };
        function FuckNo(pid){
                Ext.Ajax.request({
                    url:'/unit/details/?id='+pid,
                    async:false,
                    success:function(response){
                    var unit=Ext.decode(response.responseText);
                    var no=Ext.getCmp('fuckno');
                    if(unit.level==1||unit.level==2){
                        no.setValue(unit.no);
                        no.hide();
                    }else{
                        no.setValue('');
                        no.show();
                    }
                }
            });
        }
        function OwnerUnitChange(pid,reset){
            var limits,curlimit, newData=[];
            Ext.Ajax.request({
                url:'/unit/projecttype/limits/',
                params:{
                    unit_id:pid
                },
                async:false,
                success:function(response){
                    limits=Ext.decode(response.responseText);
                }
            });
            var f=Ext.getCmp('unit_group_ptype_field');
            var store= f.getStore('g__ptype__project_type_id');
            var combos=f.find('hiddenName','g__ptype__project_type_id');
            var textfields=f.find('name','g__ptype__max_project_num');
            var comboRecord=Ext.data.Record.create([
                {name: 'value', mapping: 'value'},
                {name: 'text', mapping: 'text'},
                {name: 'limit', mapping: 'limit'}
            ]);

            store.removeAll();
            for (var i = limits.length - 1; i >= 0; i--) {
                store.add(new comboRecord({
                    value:limits[i].pk,
                    text:limits[i].name,
                    limit:limits[i].limit
                }));
            };
            if(reset){
                var r=store.getAt(0);
                if(r){
                    for (var i = combos.length - 1; i >= 0; i--) {
                        combos[i].fireEvent('select', combos[i], r);
                    };
                }
            }
       
        }
        function ProjectTypeChanged(combo,limit){
            var f=combo.findParentByType('fieldset');
            var maxNum=f.items.items[2];
            if(limit&&limit!='unlimit'){
                limit=parseInt(limit);
                if(limit>0){
                    maxNum.emptyText='该类型项目上限为'+limit;
                }else{
                    maxNum.emptyText='该类型已经超出上限'+limit;
                }
            }else{
                maxNum.emptyText='请输入大于0的正整数';
            }
            maxNum.curlimit=limit;
            maxNum.setRawValue('');
            maxNum.applyEmptyText();
        }
        node.children.push({
            leaf:true,
            text:'单位列表',
            iconCls:'Housestar',
            list:{
                url:'/unit/list/',
                id:'admin_unit_list_grid',
                columes:[
                    {header:'单位名', dataIndex:'name', flex:1 },
                    {header:'所属单位', dataIndex:'parent_unit__name', flex:1},
                    {header:'单位地址', dataIndex:'address', flex:1},
                    {header:'项目最大数量', dataIndex:'max_project', flex:1  },
                    {header:'申报开始时间', dataIndex:'apply_starttime', flex:1  },
                    {header:'申报结束时间', dataIndex:'apply_endtime', flex:1  },
                    {header:'单位编号', dataIndex:'no', flex:1  },
                    {header:'单位级别', dataIndex:'level', flex:1, renderer:XG.Render.UnitLevel}
                ],
                tbar:{
                    handlers:[
                        {
                            text:'添加单位',
                            iconCls:'Groupadd',
                            handler:function(){
                                var form =new XG.Form.SimpelPoupForm({
                                        title:"添加单位",
                                        width:650,
                                        height:500,
                                        url:"/unit/add/",
                                        items:[
                                            XG.UnitFields.name,
                                            {
                                                fieldLabel:'所属单位名称',
                                                name:'parent_unit_id',
                                                url:'/unit/combo/?show_parent='+1,
                                                xtype:'remotecombo',
                                                id:'unit_form_combox',
                                                listeners:{
                                                    select:function(combo,r,index){
                                                        var pid=r.data.pk;
                                                        OwnerUnitChange(pid,true);
                                                        FuckNo(pid);
                                                    },
                                                    render:function(){
                                                        var pid=Ext.getCmp('unit_form_combox').getValue();
                                                        OwnerUnitChange(pid);
                                                        FuckNo(pid);
                                                    }
                                                }
                                            },
                                            XG.UnitFields.address,
                                            {
                                                fieldLabel:'单位名称全拼',
                                                name:'no',
                                                emptyText:'(每个字首字母大写)',
                                                id:'fuckno'
                                            },
                                            XG.UnitFields.phone,
                                            XG.UnitFields.apply_starttime,
                                            XG.UnitFields.apply_endtime,
                                            {
                                                xtype:'onetomanyfields',
                                                anchor:'-10',
                                                gname:'ptype',
                                                id:'unit_group_ptype_field',
                                                citems:
                                                [   
                                                    {
                                                        name:'g__ptype__pk',
                                                        xtype:'hidden'
                                                    },
                                                    {
                                                        fieldLabel : "项目类型",
                                                        url:'/projecttype/combo/',
                                                        xtype:'groupcombo',
                                                        valueField:'pk',
                                                        displayField:'name',
                                                        name:'g__ptype__project_type_id',
                                                        listeners:{
                                                            select:function(combo,r,index){
                                                                var limit=r.data.limit;
                                                                ProjectTypeChanged(combo,limit);
                                                            },
                                                            render:function(){
                                                                var limit=this.getStore().getAt(0).data.limit;
                                                                ProjectTypeChanged(this,limit);
                                                            }
                                                        }
                                                    },
                                                    {
                                                        name:'g__ptype__max_project_num', 
                                                        xtype:'textfield',
                                                        fieldLabel:'最大申请项目数',
                                                        vtype:'positive'
                                                    }
                                                ]
                                            }
                                        ],
                                        vailidate:function(form){
                                            var f=Ext.getCmp('unit_group_ptype_field');
                                            var maxNums=f.find('name','g__ptype__max_project_num'),m,v,passThrough=true;
                                            for (var i = maxNums.length - 1; i >= 0; i--) {
                                                m=maxNums[i];
                                                v=m.getValue();
                                                if(!isNatual(v)||parseInt(v)>m.curlimit){
                                                    ProjectTypeChanged(m,m.curlimit);
                                                    passThrough=false;
                                                }
                                            };
                                            if(!passThrough){
                                                alert('请填写正确的项目数量！');
                                                return false;
                                            }
                                            var values=form.getValues().g__ptype__project_type_id;
                                            if(isArrary(values)&&isHasSameVar(values)){
                                                alert('必须填写不同的项目种类！');
                                                return false
                                            }
                                            return true;
                                        },
                                        success:function(){
                                            Ext.getCmp('admin_unit_list_grid').getStore().reload();
                                            alert('添加成功!');
                                        }

                                });
                                form.show();
                            }
                        },{
                            text:'修改单位',
                            iconCls:'Groupedit',
                            handler:function(){
                                var sels = Main.CurrentGrid().getIdArr();
                                if(sels.length!=1){
                                    alert('请单选需要修改的数据！');
                                    return;
                                }
                                var pk=sels[0];
                                var form =new XG.Form.SimpelPoupForm({
                                        title:"修改单位",
                                        width:650,
                                        height:500,
                                        url:"/unit/update/",
                                        items:[
                                            XG.UnitFields.pk,
                                            XG.UnitFields.name,
                                            {
                                                fieldLabel:'所属单位名称',
                                                name:'parent_unit_id',
                                                url:'/unit/combo/?show_parent=1',
                                                xtype:'remotecombo',
                                                id:'unit_form_combox',
                                                listeners:{
                                                    select:function(combo,r,index){
                                                        var pid=r.data.pk;
                                                        OwnerUnitChange(pid,true);
                                                        FuckNo(pid);
                                                    },
                                                    render:function(){
                                                        var pid=Ext.getCmp('unit_form_combox').getValue();
                                                        OwnerUnitChange(pid);
                                                        //FuckNo(pid);
                                                    }
                                                }
                                            },
                                            XG.UnitFields.address,
                                            {
                                                fieldLabel:'单位名称全拼',
                                                name:'no',
                                                emptyText:'(每个字首字母大写)',
                                                id:'fuckno'
                                            },
                                            XG.UnitFields.phone,
                                            XG.UnitFields.apply_starttime,
                                            XG.UnitFields.apply_endtime,
                                            {
                                                xtype:'onetomanyfields',
                                                anchor:'-10',
                                                gname:'ptype',
                                                id:'unit_group_ptype_field',
                                                citems:
                                                [   
                                                    {
                                                        name:'g__ptype__pk',
                                                        xtype:'hidden'
                                                    },
                                                    {
                                                        fieldLabel : "项目类型",
                                                        url:'/projecttype/combo/',
                                                        xtype:'groupcombo',
                                                        valueField:'pk',
                                                        displayField:'name',
                                                        name:'g__ptype__project_type_id',
                                                        listeners:{
                                                            select:function(combo,r,index){
                                                                var limit=r.data.limit;
                                                                ProjectTypeChanged(combo,limit);
                                                            },
                                                            render:function(){
                                                                var limit=this.getStore().getAt(0).data.limit;
                                   
                                                                ProjectTypeChanged(this,limit);
                                                            }
                                                        }
                                                    },
                                                    {
                                                        name:'g__ptype__max_project_num', 
                                                        xtype:'textfield',
                                                        fieldLabel:'最大申请项目数',
                                                        vtype:'positive'
                                                    }
                                                ]
                                            }
                                        ],
                                        vailidate:function(form){
                                            var f=Ext.getCmp('unit_group_ptype_field');
                                            var maxNums=f.find('name','g__ptype__max_project_num'),m,v,passThrough=true;
                                            for (var i = maxNums.length - 1; i >= 0; i--) {
                                                m=maxNums[i];
                                                v=m.getValue();
                                                if(!isNatual(v)||parseInt(v)>m.curlimit){
                                                    ProjectTypeChanged(m,m.curlimit);
                                                    passThrough=false;
                                                }
                                            };
                                            if(!passThrough){
                                                alert('请填写正确的项目数量！');
                                                return false;
                                            }
                                            var values=form.getValues().g__ptype__project_type_id;
                                            if(isArrary(values)&&isHasSameVar(values)){
                                                alert('必须填写不同的项目种类！');
                                                return false
                                            }
                                            return true;
                                        },
                                        success:function(){
                                            Ext.getCmp('admin_unit_list_grid').getStore().reload();
                                            alert('修改成功!');
                                        }
                                });
                                Ext.Ajax.request({
                                    url:'/unit/details/',
                                    method:"post",
                                    params:{
                                        id:pk
                                    },
                                    success:function (response) {

                                        var json = Ext.util.JSON.decode(response.responseText);
                                     
                                        form.fill(json);

                                       if(json.pk==Main.UserUnitID){
                                           form.setReadOnly(true);
                                        }
                                        form.show();
                                    },
                                    failure:function (form, action) {
                                        if ('result' in action) {
                                            if ('msg' in action.result) {
                                                error(action.result.msg);
                                            }
                                        }
                                        else {
                                            error('发生异常!');
                                        }
                                    }
                                });
                            }
                        }
                    ],
                    del_row:{
                        url:'/unit/del/',
                        iconCls:'Databasedelete'
                    }
                }
            }
        });
      
        node.children.push({
            leaf:true,
            text:'单位审核',
            iconCls:'Housekey',
            list:{
                url:'/unit/list/approve/',
                columes:[
                    {header:'单位名', dataIndex:'name', flex:1},
                    {header:'所属单位', dataIndex:'parent_unit__name', flex:1 },
                    {header:'单位地址', dataIndex:'address', flex:1 },
                    {header:'项目最大数量', dataIndex:'project_type__name', flex:1},
                    {header:'单位级别', dataIndex:'level', flex:1, renderer:XG.Render.UnitLevel },
                    {header:'注册时间', dataIndex:'regtime', flex:1 }
                ],
                tbar:{}
            }
        });

        node.children[1].list.tbar.approve_row = {
            title:'单位审核',
            url:'/unit/approve/',
            argreeText:"同意注册",
            disargreeText:"退回注册",
            iconCls:'Housekey'
        };
        root.appendChild(node);
    }
    




    node={
        text:'消息通知',
        expanded:true,
        leaf:false,
        iconCls:'Usercomment',
        children:[]
    };

    if(0==Main.AuthLevel)
    {
        node.children.push({
            text:'消息发送',
            leaf:true,
            iconCls:'Commentadd',
            defaults:{
                allowBlank:false,
                width:230
            },
            view:{
                xtype:'form',
                id:'message_form',
                labelWidth: 55,
                url:'/message/add/',
                defaultType: 'textfield',
                defaults:{
                    allowBlank:false
                },
                items: [
                {fieldLabel:'接受单位',name:'receiver_unit_id',width:250, url:'/message/message_recvier_combo/',xtype:'remotecombo'},
                {fieldLabel: '标题',name: 'title',anchor:'85%'},
                {fieldLabel: '摘要',name: 'abstract',anchor: '85%'},
                {fieldLabel: '内容',xtype: 'textarea',name: 'content',anchor: '85% -200'}
                ],
                buttons: [{
                    text: '发送',
                    handler:function(){
                        var form=Ext.getCmp('message_form').getForm();
                        form.submit({
                            clientValidation:true,
                            url:'/message/add/',
                            success:function (form, action) {
                                if (action.result.msg != 'OK') {
                                    alert(action.result.msg);
                                }
                                form.reset();
                            },
                            failure:function (form, action) {
                                if (action
                                    && action.hasOwnProperty('result')
                                    && action.result.hasOwnProperty('msg')
                                    && action.result.msg) {
                                    error(action.result.msg);
                                }
                                else {
                                    error('发生异常！');
                                }
                                form.reset();
                            }
                        });
                    }
                },{
                    text: '取消',
                    handler:function(){
                        Ext.get('message_form').getForm().reset();
                    }
                }]
            }
        });
    }
    

    Main.PubMessage=function(pk,data){

        var win=new Ext.Window({
            title:'消息发布',
            closable:true,
            closeAction:'close',
            modal:true,
            width:465,
            height:280,
            layout:'form',
            items:[
                {
                    fieldLabel : "接收对象",
                    url:'/message/message_recvier_combo/',
                    xtype:'remotecombo',
                    id:'message_recv',
                    name:'recv',
                    width:300
                },
                {
                    xtype:'textarea', 
                    fieldLabel : "消息内容",
                    width:300,
                    value:data,
                    editable:false
                }
            ],
            buttons:[
                {
                    text:'发送',handler:function(){
                        var recv=Ext.getCmp('message_recv').getValue();
                        Ext.Ajax.request({
                            url:'/message/pub/',
                            params:{
                                pk:pk,
                                recv:recv
                            },
                            success:function(response){
                                alert('该条消息已经发布！');
                                var grid=Ext.getCmp('wait_pub_message_list');
                                grid.getStore().reload(); 
                                win.close();         
                            }
                       });
                    }
                }
            ]
        });
        win.show(this);
           
    }

    if(0!=Main.AuthLevel)
    {
        node.children.push({
            text:'我收到的消息',
            leaf:true,
            iconCls:'Commentplay',
            list:{
                nocheck:true,
                id:'wait_pub_message_list',
                url:"/message/waitpublist/",
                columes:[
                    {header:'消息标题', dataIndex:'title', flex:1},
                    {header:'消息摘要', dataIndex:'abstract', flex:1 },
                    {header:'发送时间', dataIndex:'send_time', flex:1 },
                    {header:'发送人', dataIndex:'sender_name', flex:1 },
                    {header:'发送人姓名', dataIndex:'sender_real_name', flex:1 },
                    {header:'发送单位', dataIndex:'sender_unit__name', flex:1 },
                    {dataIndex:"content"},
                    {
                        header:'操作', 
                        dataIndex:'pk', 
                        flex:1,
                        renderer:function(value,p,record){
                            return "<a href='#' onclick=\"Main.PubMessage("+value+",'"+record.json.content+"')\">查看</a>"
                        }.createDelegate(this)
                    }
                ],
                viewConfig:{
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                            if(this.showPreview){
                                p.body = '<p>消息内容: '+record.data.content+'</p>';
                                return 'x-grid3-row-expanded';
                            }
                        return 'x-grid3-row-collapsed';
                    }
                }
            }
        });
    }

    node.children.push({
        text:'已发送的消息',
        leaf:true,
        iconCls:'Commentrecord',
        list:{
            nocheck:true,
            url:"/message/sended/list/",
            columes:[
                {header:'消息标题', dataIndex:'title', flex:1},
                {header:'消息摘要', dataIndex:'abstract', flex:1 },
                {header:'发送时间', dataIndex:'send_time', flex:1 },
                {header:'发送人', dataIndex:'sender_name', flex:1 },
                {header:'发送人姓名', dataIndex:'sender_real_name', flex:1 },
                {header:'发送单位', dataIndex:'sender_unit__name', flex:1 },
                {dataIndex:"content"}
            ],
            viewConfig: {
                forceFit:true,
                enableRowBody:true,
                showPreview:true,
                getRowClass : function(record, rowIndex, p, store){
                    if(this.showPreview){
                        p.body = '<p>消息内容: '+record.data.content+'</p>';
                        return 'x-grid3-row-expanded';
                    }
                    return 'x-grid3-row-collapsed';
                }
            }
        }
    });
    root.appendChild(node);
});
</script>
{%endifequal%}
{%ifequal user.role.code 'expert'%}
<script type="text/javascript">

    Ext.onReady(function () {
        var root = Main.tree.getRootNode();
        Ext.TaskMgr.start({
            run: function(){
                Ext.Ajax.request({  
                    url:'/user/notify/count/',
                    method:'post',  
                    success:function(response,options){
                        var res = Ext.util.JSON.decode(response.responseText);  
                        for (var j = root.childNodes.length - 1; j >= 0; j--) {
                            var r=root.childNodes[j];
                            var childrens=r.childNodes;//项目申请
                            for (var i = childrens.length - 1; i >= 0; i--) {
                                var n=childrens[i];
                                if(n.text.indexOf('待评审的项目')!=-1)
                                    n.setText('待评审的项目('+res.waitapprove+')');
                                else if(n.text.indexOf('已评审的项目')!=-1)
                                    n.setText('已评审的项目('+res.approved+')');
                            }
                        };
                    }
                });
            },
            interval: 3000
        });
        var node = {
            text:'项目评审',
            expanded:true,
            iconCls:'Monitorlightning',
            leaf:false,
            children:[
                {
                    text:'待评审的项目',
                    leaf:true,
                    iconCls:'Monitorlink',
                    list:{
                        url:"/project/apply/list/",
                        baseParams:{
                            'waitoption':true
                        },
                        columes:[
                            {
                                header:'项目名称',
                                dataIndex:'project_name',
                                flex:1,
                                renderer:function (value) {
                                    return '<img src="/static/icons/zoom.png"/>' + value;
                                }.createDelegate(this)
                            },
                            {header:'项目类型', dataIndex:'project_type__name', flex:1},
                            {header:'项目编号', dataIndex:'project_no', flex:1 },
                            {header:'申请时间', dataIndex:'applicant_time', flex:1},
                            {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                            {header:'学科分类', dataIndex:'study_type_name', flex:1},
                            {header:'PDF', flex:1, dataIndex:'pk', width:50,
                                renderer:function (value) {
                                    return '<img src="/static/icons/page_white_acrobat.png"/>';
                                }.createDelegate(this)
                            }
                        ],
                        listeners:{
                            cellclick:DefaultCellHanlder({
                                applyPdfIdx:7,
                                applyIdx:1
                            })
                        },
                        tbar:{
                            approve_row:{
                                title:"评审", 
                                url:'/project/apply/approve/', 
                                iconCls:'Useralert',
                                argreeText:"评审",
                                disagreeText:"拒绝评审",
                                optionText:'评审意见',
                                optionAllowBanlk:true,
                                agreeHandler:function(form,win){
                                    form.submit({
                                        url:'/project/apply/approve/',
                                        method:"post",
                                        success:function () {
                                            win.close();
                                            Main.CurrentGrid().getStore().load();
                                            alert('操作成功!');
                                        },
                                        failure:function (form, action) {
                                            win.close();
                                            if ('result' in action) {
                                                if ('msg' in action.result) {
                                                    error(action.result.msg);
                                                }
                                            }
                                            else {
                                                error('发生异常!');
                                            }

                                        }
                                    });
                                },
                                disagreeHandler:function(form,win){
                                    form.submit({
                                        clientValidation: true,
                                        url: '/project/apply/approve/',
                                        success:function () {
                                            win.close();
                                            Main.CurrentGrid().getStore().load();
                                            alert('审核成功!');
                                        },
                                        failure:function (form, action) {
                                            win.close();
                                            if ('result' in action) {
                                                if ('msg' in action.result) {
                                                    error(action.result.msg);
                                                }
                                            }
                                            else {
                                                error('发生异常!');
                                            }
                                        }
                                    });
                                },
                                width:416,
                                height:278,
                                items:[
                                {
                                    fieldLabel:'资助意见',
                                    xtype:'localcombo',
                                    name:'expert_support',
                                    data:[
                                    ['优先资助','优先资助'],
                                    ['可资助','可资助'],
                                    ['不予资助','不予资助']]
                                },
                                {
                                    fieldLabel:'评分(0-100)',
                                    xtype:'textfield',
                                    name:'expert_percent',
                                    vtype:'percent',
                                    allowBlank:true
                                }]
                            }
                        }
                    }
                },{
                    text:'已评审的项目',
                    leaf:true,
                    iconCls:'Monitorgo',
                    list:{
                        url:"/project/apply/list/",
                        columes:[
                            {
                                header:'项目名称',
                                dataIndex:'project_name',
                                flex:1,
                                renderer:function (value) {
                                    return '<img src="/static/icons/zoom.png"/>' + value;
                                }.createDelegate(this)
                            },
                            {header:'项目类型', dataIndex:'project_type__name', flex:1},
                            {header:'项目编号', dataIndex:'project_no', flex:1 },
                            {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                            {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                            {header:'学科分类', dataIndex:'study_type_name', flex:1},
                            {header:'PDF', flex:1, dataIndex:'pk', width:50,
                                renderer:function (value) {
                                    return '<img src="/static/icons/page_white_acrobat.png"/>';
                                }.createDelegate(this)
                            }
                        ],
                        listeners:{
                            cellclick:DefaultCellHanlder({
                                applyPdfIdx:7,
                                applyIdx:1
                            })
                        },
                        tbar:{
                            approve_row:{ title:"审核立项申请", url:'/project/apply/approve/', iconCls:'Useralert'}
                        }
                    }
                }
            ]
        };


        root.appendChild(node);
        node = {
            text:'消息管理',
            expanded:true,
            leaf:false,
            iconCls:'Usercomment',
            children:[]
        };
        

        node.children.push({
            text:'系统消息',
            leaf:true,
            iconCls:'Commentplay',
            list:{
                id:'wait_pub_message_list',
                url:"/message/list/",
                nocheck:true,
                columes:[
                    {header:'消息标题', dataIndex:'title', flex:1},
                    {header:'消息摘要', dataIndex:'abstract', flex:1 },
                    {header:'发送时间', dataIndex:'send_time', flex:1 },
                    {header:'发送人', dataIndex:'sender_name', flex:1 },
                    {header:'发送人姓名', dataIndex:'sender_real_name', flex:1 },
                    {header:'接收单位', dataIndex:'sender_unit__name', flex:1 },
                    {dataIndex:'content'}
                ],
                viewConfig: {
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>消息内容: '+record.data.content+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                }
            }
        });
        root.appendChild(node);
    });
</script>
{%endifequal%}
{%ifequal user.role.code 'applicant'%}
<script type="text/javascript">
    Ext.onReady(function () {
        var root = Main.tree.getRootNode();
        Main.ShowProjectApply=function(data){
            Main.ClearTab();
            var exisTab = Main.tab_panel.findById('项目立项申请');
            if(!exisTab) {
                exisTab = Main.tab_panel.add({
                    closable: true,
                    id: '项目立项申请',
                    title: '项目立项申请',
                    layout: {
                        type: 'fit'
                    },
                    items: [{
                        xtype:'form',
                        id:'prject_apply_add',
                        labelWidth: 55,
                        autoScroll: true,
                        defaultType: 'textfield',
                        items: [
                            {
                                xtype:'fieldset',
                                title: '申请者的承诺',
                                collapsible: true,
                                collapsed:true,
                                autoHeight:true,
                                items :[
                                    {
                                        xtype:'panel',
                                        html:'<p ><h1 align="center">国家民委教育科技司制表</h1></p><p align="center"><strong>&nbsp;</strong></p><p><h2>申请者的承诺：</h2></p><br/><p><strong>&nbsp;&nbsp; </strong>我保证如实填写本表各项内容。如果获准立项，我承诺以本表为有约束力的协议，认真开展研究工作，取得预期研究成果。国家民委教育科技司有权使用本表所有数据和资料。对于国家民委资助研究的项目，其研究成果国家民委有权使用。</p><br/><br/>'
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '填表说明',
                                collapsible: true,
                                collapsed:true,
                                autoHeight:true,
                                items :[
                                    {
                                        xtype:'panel',
                                        html:'<p align="center"><h1 align="center">填  表  说  明 </h1></p><br/><ol><li>本表统一用计算机认真如实填写后并打印。 </li><li>学科分类以所属的一级学科为准，如果跨学科申报，请在&ldquo;学科分类&rdquo;一栏填入&ldquo;跨学科&rdquo;字样，并在其后用括号注明所属的<strong>2</strong>至<strong>3</strong>个一级学科，如&ldquo;跨学科（哲学、经济学）&rdquo;等。 </li><li>数据表中推荐人签名一栏中，是项目负责人为中级职称且未获得博士学位者填写，中级以上职称或获得博士学位的不需填写。 </li><li>本表报送一式<strong>3</strong>份，其中<strong>1</strong>份原件，<strong>2</strong>份复印件。复印请用<strong>A4</strong>复印纸，于左侧装订成册。 </li><br/><br/>'
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '数据表',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                defaults:{
                                    allowBlank:false
                                },
                                items :[
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                               columnWidth :.5, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                    xtype:'combo',
                                                    mode:'local',
                                                    editable:false,
                                                    valueField:'name',
                                                    displayField:   'name',
                                                    fieldLabel : "项目领域",
                                                    triggerAction:  'all',
                                                    forceSelection: true,
                                                    name: 'project_area_name_s',
                                                    hiddenName:'project_area_name',
                                                    anchor:'78%',
                                                    value:'人文社会科学',
                                                    store:new Ext.data.JsonStore({
                                                        fields : ['name'],
                                                        data:[
                                                            {name:'人文社会科学'},
                                                            {name:'自然科学'},
                                                            {name:'文理交叉'},
                                                            {name:'其他'}
                                                        ]
                                                    })
                                               }]
                                            },
                                            {
                                                columnWidth :.5, 
                                                layout : "form", 
                                                border:false,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "项目名称",
                                                  allowBlank:false,
                                                  name:'project_name',
                                                  anchor:'90%'
                                               
                                                }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                               columnWidth :.33, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [
                                                    {
                                                        fieldLabel : "项目类型",
                                                        url:'/projecttype/combo/',
                                                        xtype:'remotecombo',
                                                        name:'project_type_id',
                                                        valueField:'project_type__pk',
                                                        displayField:'project_type__name'
                                                        // baseFields:[
                                                        //     {name:'name', mapping:'project_type__name', type:'string'},
                                                        //     {name:'pk', mapping:'project_type__pk', type:'int'}
                                                        // ]
                                                    }
                                               ]
                                            },{
                                               columnWidth :.33, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [
                                               {
                                                    xtype : "textfield",
                                                    fieldLabel : "学科分类",
                                                    name:'study_type_name',
                                                    emptyText:'请查看国家标准二级学科代码',
                                                    allowBlank:false,
                                                    anchor:'85%'
                                               }
                   
                                               ]
                                            },{
                                               columnWidth :.33, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                                border:false,
                                               items : [{
                                                    xtype:'combo',
                                                    mode:'local',
                                                    editable:false,
                                                    valueField:'name',
                                                    displayField:   'name',
                                                    fieldLabel : "研究类型",
                                                    triggerAction:  'all',
                                                    forceSelection: true,
                                                    name: 'reserch_type_name_s',
                                                    hiddenName:'reserch_type_name',
                                                    anchor:'78%',
                                                    value:'基础研究',
                                                    store:new Ext.data.JsonStore({
                                                        fields : ['name'],
                                                        data:[
                                                            {name:'基础研究'},
                                                            {name:'应用研究'},
                                                            {name:'应用基础研究'},
                                                            {name:'综合研究'},
                                                            {name:'其它研究'}
                                                        ]
                                                    })
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {

                                               columnWidth :.25, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                    fieldLabel: '是否为硕士生导师',
                                                    xtype:'localcombo',
                                                    data:[['否','否'],['是','是']],
                                                    name:'teacher_name_ss',
                                                    anchor:'85%'
                                               }]
                                            },
                                            {
                                               columnWidth :.25, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                  xtype:'localcombo',
                                                  fieldLabel : "是否为博士生导师",
                                                  name:'teacher_name_bs',
                                                  data:[['否','否'],['是','是']],
                                                  anchor:'85%'
                                               }]
                                            },
                                            {
                                                columnWidth :.25, 
                                                layout : "form", 
                                                border:false,
                                                items : [
                                                {
                                                    xtype : "textfield",
                                                    fieldLabel : "工作单位",
                                                    allowBlank:false,
                                                    anchor:'90%',
                                                    value:Main.UnitName,
                                                    name:'teacher_unit',
                                                    readOnly:true
                                               }]
                                            },
                                            {
                                                columnWidth :.25,
                                                layout : "form", 
                                                border:false,
                                                items : [{
                                                    xtype : "textfield",
                                                    fieldLabel : "联系电话",
                                                    allowBlank:false,
                                                    anchor:'90%',
                                                    name:'teacher_phone'
                                                }]
                                            }
                                        ]
                                    },
                                    {
                                        xtype:'textarea',
                                        fieldLabel : "近几年与本课题相关的研究成果(限200字)",
                                        anchor:'90%',
                                        name:'teacher_remark',
                                        allowBlank:false,
                                        height:150,
                                        maxLength:200
                                    },
                                    {
                                        xtype:'onetomanyfields',
                                        title: '课题主要参加者相关情况(限填5项)',
                                        gname:'actor',
                                        max:5,
                                        collapsible:true,
                                        citems:[
                                            {
                                              xtype : "textfield",
                                              fieldLabel:'姓名',
                                              allowBlank:false,
                                              name:'g__actor__name',
                                              anchor:'78%'
                                            },
                                            {
                                                xtype:'combo',
                                                mode:'local',
                                                editable:false,
                                                valueField:'name',
                                                displayField:   'name',
                                                fieldLabel : "职称",
                                                triggerAction:  'all',
                                                forceSelection: true,
                                                name: 'g__actor__job_zc__s',
                                                hiddenName:'g__actor__job_zc',
                                                anchor:'50%',
                                                value:'无',
                                                store:new Ext.data.JsonStore({
                                                    fields : ['name'],
                                                    data:[
                                                        {name:'无'},
                                                        {name:'助教'},
                                                        {name:'讲师'},
                                                        {name:'副研究员'},
                                                        {name:'研究员'},
                                                        {name:'副教授'},
                                                        {name:'教授'}
                                                    ]
                                                })
                                            },
                                            {
                                                xtype:'combo',
                                                mode:'local',
                                                editable:false,
                                                valueField:'name',
                                                displayField:   'name',
                                                fieldLabel : "职务",
                                                triggerAction:  'all',
                                                forceSelection: true,
                                                name: 'g__actor__job_zw__s',
                                                hiddenName:'g__actor__job_zw',
                                                anchor:'50%',
                                                value:'无',
                                                store:new Ext.data.JsonStore({
                                                    fields : ['name'],
                                                    data:[
                                                        {name:'无'},
                                                        {name:'处长'},
                                                        {name:'副处长'},
                                                        {name:'司长'},
                                                        {name:'副司长'},
                                                        {name:'局长'},
                                                        {name:'副局长'},
                                                        {name:'厅长'},
                                                        {name:'副厅长'}
                                                    ]
                                                })
                                            },
                                            {
                                                xtype:'combo',
                                                mode:'local',
                                                editable:false,
                                                valueField:'name',
                                                displayField:   'name',
                                                fieldLabel : "学位",
                                                triggerAction:  'all',
                                                forceSelection: true,
                                                name: 'g__actor__degree__s',
                                                hiddenName:'g__actor__degree',
                                                anchor:'50%',
                                                value:'学士',
                                                store:new Ext.data.JsonStore({
                                                    fields : ['name'],
                                                    data:[
                                                        {name:'学士'},
                                                        {name:'硕士'},
                                                        {name:'博士'}
                                                    ]
                                                })
                                            },
                                            {
                                              xtype : "textarea",
                                              anchor:'78%',
                                              name:'g__actor__desc',
                                              allowBlank:false,
                                              maxLength:200,
                                              fieldLabel:'近几年与本课题相关的研究成果(限200字)'
                                            }
                                        ]
                                    },
                                  
                                    {
                                        xtype:'textarea',
                                        fieldLabel:'预期成果概述',
                                        anchor:'90%',
                                        name:'comple_desc',
                                        allowBlank:false,
                                        maxLength:500
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                               columnWidth :.5, 
                                               layout : "form",
                                               border:false,
                                               labelWidth:100,
                                               items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "申请资助经费(单位:万元）",
                                                  name:'total_money',
                                                  vtype:'positive',
                                                  allowBlank:false,
                                                  anchor:'78%'
                                               }]
                                            },{
                                               columnWidth :.5,
                                               layout : "form",
                                                border:false,
                                                labelWidth:100,
                                               items : [DefaultDateFeild({
                                                
                                                  vtype:'future_date',
                                                  name:'comple_time',
                                                  fieldLabel : "预计完成时间",
                                                  anchor:'78%'
                                               })]
                                            }
                                        ]
                                    }

                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '应用推广或市场分析(限250字)',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                items :[
                                    {
                                        xtype:'textarea',
                                        anchor:'100%',
                                        fieldLabel:'内容',
                                        allowBlank:false,
                                        height:250,
                                        maxLength:500,
                                        name:'marketing_desc'
                                    }
                                ]
                            },
                            {
                                xtype:'onetomanyfields',
                                title: '预期研究成果(限制填10项)',
                                collapsible: true,
                                anchor:'100%',
                                max:10,
                                gname:'levelachive',
                                citems:[
                                    DefaultDateFeild({
                                        name : 'g__levelachive__start_time',
                                        fieldLabel:'研究阶段开始时间'
                                    }),
                                    DefaultDateFeild({
                                        name : 'g__levelachive__end_time',
                                        fieldLabel:'研究阶段结束时间'
                                    }),
                                    {
                                      xtype : "textfield",
                                      fieldLabel:'阶 段 成 果 名 称',
                                      allowBlank:false,
                                      name:'g__levelachive__name',
                                      anchor:'90%'
                                    },
                                    {
                                      xtype : "textarea",
                                      anchor:'90%',
                                      allowBlank:false,
                                      maxLength:200,
                                      name:'g__levelachive__atype',
                                      fieldLabel:'成果形式(限200字)'
                                    },
                                    {
                                      xtype : "textfield",
                                      fieldLabel:'承 担 人',
                                      name:'g__levelachive__apply_user',
                                      allowBlank:false,
                                      anchor:'90%'
                                    }
                                ]
                            },{
                                xtype:'onetomanyfields',
                                title: '最终研究成果(限制填2项)',
                                max:2,
                                collapsible: true,
                                anchor:'100%',
                                gname:'finalachive',
                                citems:[
                                    DefaultDateFeild({
                                      fieldLabel:'完成时间',
                                      name:'g__finalachive__end_time',
                                      anchor:'90%'
                                    })
                                    ,
                                    {
                                      xtype : "textfield",
                                      fieldLabel:'最 终 成 果 名称',
                                      name:'g__finalachive__name',
                                      allowBlank:false,
                                      anchor:'90%'
                                    },
                                    {
                                      xtype : "textarea",
                                      anchor:'90%',
                                      allowBlank:false,
                                      name:'g__finalachive__atype',
                                      fieldLabel:'成果形式'
                                    },
                                    {
                                      xtype : "textfield",
                                      fieldLabel:'预计字数',
                                      name:'g__finalachive__font_num',
                                      allowBlank:false,
                                      vtype:'positive',
                                      anchor:'90%'
                                    },
                                    {
                                      xtype : "textfield",
                                      fieldLabel:'参 加 人',
                                      name:'g__finalachive__actor',
                                      allowBlank:false,
                                      anchor:'90%'
                                    }
                                ]
                            },{
                                xtype:'fieldset',
                                title: '经费预算',
                                collapsible: true,
                               
                                labelWidth:200,
                                autoHeight:true,
                                items :[

                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "资料费金额(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'book_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "资料费描述",
                                                  allowBlank:false,
                                                  name:'book_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                  
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "国内调研差旅费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'reserch_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "国内调研差旅费描述",
                                                  allowBlank:false,
                                                  name:'reserch_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "小型会议费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'meet_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "小型会议费描述",
                                                  allowBlank:false,
                                                  name:'meet_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "计算机使用费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'computer_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "计算机使用费描述",
                                                  allowBlank:false,
                                                  name:'computer_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "印刷补助费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'print_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "印刷补助费描述",
                                                  allowBlank:false,
                                                  name:'print_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "管理费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'manage_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "管理费描述",
                                                  allowBlank:false,
                                                  name:'manage_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "其他费用(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'other_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "其他费用描述",
                                                  allowBlank:false,
                                                  name:'other_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '附件',
                                collapsible: true,
                                labelWidth:300,
                                autoHeight:true,
                                items :[{
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[{
                                            columnWidth :.6, 
                                            layout : "form", 
                                            border:false,
                                            items : [{
                                              xtype : "textfield",
                                              id:'project_apply_file_code',
                                              fieldLabel : '文档编号(上传项目申请书后自动生成)',
                                              allowBlank:false,
                                              width:250,
                                              readOnly:true,
                                              name:'file_code'
                                            }]
                                        },
                                        {
                                            columnWidth :.2, 
                                            layout : "form", 
                                            border:false,
                                            items : [
                                                {
                                                    xtype : "button",
                                                    text : "上传项目申请书",
                                                    handler:function(){
                                                        var form = new Ext.form.FormPanel({
                                                            baseCls: 'x-plain',
                                                            labelWidth: 80,
                                                            fileUpload:true,
                                                            items: [{
                                                                xtype: 'fileuploadfield',
                                                                anchor: '90%',
                                                                name: 'file',  
                                                                allowBlank:false,
                                                                listeners:{ 
                                                                    fileselected:function(input,value){
                                                                        var ext=/\.[^\.]+$/.exec(value);
                                                                        if(ext!='.doc'&&ext!='.docx'){
                                                                             alert('请选择有效的Word文件！');
                                                                             input.reset();
                                                                        }
                                                                       
                                                                    }
                                                                }
                                                            }]
                                                        });

                                                        var win = new Ext.Window({
                                                            title: '上传填写完整的Word文档',
                                                            width: 400,
                                                            height:200,
                                                            minWidth: 300,
                                                            minHeight: 100,
                                                            layout: 'fit',
                                                            plain:true,
                                                            bodyStyle:'padding:5px;',
                                                            items: form,
                                                            buttons: [
                                                                {
                                                                  xtype : "button",
                                                                  text : "上传",
                                                                  handler:function(){
                                                                    if(!form.getForm().isValid())return;
                                                                    var ext=/\.[^\.]+$/.exec(form.items.items[0].value);
                                                                    if(isArrary(ext))ext=ext[0];
                                                                    form.getForm().submit({
                                                                        clientValidation:true,
                                                                        method:"post",
                                                                        params: {
                                                                          'ext':ext,
                                                                          'csrf_token': Ext.util.Cookies.get('csrftoken'),
                                                                          'csrf_name': 'csrftoken',
                                                                          'csrf_xname': 'X-CSRFToken'
                                                                        },
                                                                        url:'/project/apply/doc/upload/',
                                                                        success:function (form, action) {
                                                                            alert('上传成功！');
                                                                            var txt=Ext.getCmp('project_apply_file_code');
                                                                            txt.setValue(action.result.code);
                                                                            
                                                                            form.reset();
                                                                            win.close();
                                                                        },
                                                                        failure:function (form, action) {
                                                                            if (action
                                                                                && action.hasOwnProperty('result')
                                                                                && action.result.hasOwnProperty('msg')
                                                                                && action.result.msg) {
                                                                                error(action.result.msg);
                                                                            }
                                                                            else {
                                                                                error('发生异常！');
                                                                            }
                        
                                                                            form.reset();
                                                                            win.close();
                                                                        }
                                                                    });
                                                                  }  
                                                                },
                                                                {
                                                                    text: '关闭',
                                                                    handler:function(){win.close();}
                                                                }
                                                            ]
                                                        });
                                                        win.show();
                                                    }

                                                } 
                                            ]
                                        } ]
                                }]
                            }
                        ],
                        buttons:[
                            {
                                text: '保存记录',
                                handler:function(){
                                    var frm=Ext.getCmp('prject_apply_add');
                                    var flag=true;
                                    frm.getForm().items.each(function(x) {
                                        if (x.validate === undefined||!flag) {
                                            return;
                                        }
                                        if( x.validate())return;
                                        flag=false;
                                        x.focus(false, 200);
                                        alert('请正确填写红色下划线部分！');
                                    });
                                    
                                    if (!frm.getForm().isValid()) return; 
                                    frm.getForm().submit({
                                         waitMsg: '正在提交数据',
                                         waitTitle: '提示',
                                         url: '/projectapply/add/',
                                         success: function(form, action) {
                                            if (action.result.msg != 'OK') {
                                                alert(action.result.msg);
                                            }
                                            else
                                            {
                                                alert('保存成功！')
                                            }
                                            form.reset();
                                            Main.tab_panel.remove(exisTab.id);
                                         },
                                         failure: function(form, action) {
                                            if (action
                                                && action.hasOwnProperty('result')
                                                && action.result.hasOwnProperty('msg')
                                                && action.result.msg) {
                                                error(action.result.msg);
                                            }
                                            else {
                                                error('发生异常！');
                                            }
                                            // form.reset();
                                            // Main.tab_panel.remove(exisTab.id);
                                         }
                                    });
                                }
                            },
                            {
                                text: '清空表单',
                                handler:function(){
                                    var from=Ext.getCmp('prject_apply_add');
                                    from.getForm().reset();
                                }
                            }
                        ]
                    }]
                });
                exisTab.show();
            }
            Main.tab_panel.setActiveTab(exisTab);
        }
        
        Main.ModifyProjectApply=function(json){
            Main.ClearTab();
            Ext.Ajax.request({
                method:'post',
                url:'/project/apply/details/',
                params:{
                    pk:json.pk
                },
                success:function(response){
                    var json=Ext.decode(response.responseText);
                    var root = Main.tree.getRootNode();
                    Main.ShowProjectApply(obj);
                    var formPanel=Ext.getCmp('prject_apply_add');
                    var form=formPanel.getForm();
                    form.reset();
                    var filed,value;
                    var one2manys=formPanel.find('xtype','onetomanyfields');
                    for(var obj in json){
                        if(isArrary(json[obj])){
                            var jarray=json[obj];
                            var gfield=null;
                            if(!one2manys||one2manys.length==0)continue;
                            for (var i = one2manys.length - 1; i >= 0; i--) {
                                gfield=one2manys[i];
                                if(gfield.gname==obj)
                                {
                                    gfield.setValue(jarray);
                                    break;
                                }
                            };
                           
                        }else{
                            fields=form.findField(obj);
                            if(fields){
                                value = json[obj];
                                if(true==value){
                                    value=1;
                                }
                                else if(false==value){
                                    value=0;    
                                }
                                fields.setValue(value);
                            }
                        }
                    }
                }
            })
        }

        Main.ShowProjectChangeApply=function(json){
            Main.ClearTab();
            var id='项目变更申请';
            var from_id=Ext.id();
            var exisTab = Main.tab_panel.findById(id);
            if(!exisTab) {
                exisTab = Main.tab_panel.add({
                    closable: true,
                    id: id,
                    title: id,
                    layout: {
                        type: 'fit'
                    },
                    items:[{
                        xtype:'form',
                        id:from_id,
                        anchor:'100%',
                        labelWidth: 150,
                        autoScroll: true,
                        autoHeight:true,
                        defaultType: 'textfield',
                        items:[
                            {
                                xtype:'textfield',
                                fieldLabel:'项目名称',
                                value:json.project_name,
                                readOnly:true
                            },
                            {
                                xtype:'textfield',
                                fieldLabel:'项目编号',
                                value:json.project_no,
                                readOnly:true
                            },
                            {
                                xtype:'hidden',
                                name:'pk',
                                value:json.pk,
                                readOnly:true
                            },
                            {
                                fieldLabel: '项目变更状态',
                                xtype:'localcombo',
                                name:'forward_status',
                                data:[[-6,'延期'],
                                    [-5,'撤项'],
                                    [0,'正常']],
                                listeners:{
                                    select:function(box, record, index){
                                        var show=(index==0);
                                        if(show){
                                            Ext.getCmp('project_exchage_add_date').show();
                                         }else{
                                            Ext.getCmp('project_exchage_add_date').hide();
                                         }
                                       
                                    }
                                }
                            },
                            DefaultDateFeild({
                                name : 'project_exchage_add_date',
                                id:'project_exchage_add_date',
                                vtype:'future_date'
                            }),
                            {
                                xtype:'textarea',
                                fieldLabel: '项目变更原因(限200字)',
                                name: 'applicant_opinion',
                                anchor:'85%',
                                maxLength:200
                            }
                        ],
                        buttons:[
                            {
                                text: '提交项目变更申请',
                                handler:function(){
                                    var frm=Ext.getCmp(from_id);
                                    if (!frm.getForm().isValid()) return;
                                    frm.getForm().submit({
                                         waitMsg: '正在提交数据',
                                         waitTitle: '提示',
                                         url: '/project/exchange/add/',
                                         success: function(form, action) {
                                            if (action.result.msg != 'OK') {
                                                alert(action.result.msg);
                                            }
                                            else
                                            {
                                                alert('项目变更申请已经提交');
                                            }
                                            Main.tab_panel.remove(exisTab.id);
                                         },
                                         failure: function(form, action) {
                                            if (action
                                                && action.hasOwnProperty('result')
                                                && action.result.hasOwnProperty('msg')
                                                && action.result.msg) {
                                                error(action.result.msg);
                                            }
                                            else {
                                                error('发生异常！');
                                            }
                                            //form.getForm().reset();
                                         }
                                    });
                                }
                            },
                            {
                                text: '清空表单',
                                handler:function(){
                                    var from=Ext.getCmp('prject_apply_add');
                                    from.getForm().reset();
                                }
                            }
                        ]
                    }]
                   });
                exisTab.show();
            }
            Main.tab_panel.setActiveTab(exisTab);
        }

        Main.ShowProjectRollbackApply=function(json){
            Main.ClearTab();
            var id='项目退回申请';
            var from_id=Ext.id();
            var exisTab = Main.tab_panel.findById(id);
            if(!exisTab) {
                exisTab = Main.tab_panel.add({
                    closable: true,
                    id: id,
                    title: id,
                    layout: {
                        type: 'fit'
                    },
                    items:[{
                        xtype:'form',
                        id:from_id,
                        anchor:'100%',
                        labelWidth: 150,
                        autoScroll: true,
                        autoHeight:true,
                        defaultType: 'textfield',
                        items:[
                            {
                                xtype:'textfield',
                                fieldLabel:'项目名称',
                                value:json.project_name,
                                readOnly:true
                            },
                            {
                                xtype:'textfield',
                                fieldLabel:'项目编号',
                                value:json.project_no,
                                readOnly:true
                            },
                            {
                                xtype:'hidden',
                                name:'pk',
                                value:json.pk,
                                readOnly:true
                            },
                            {
                                xtype:'hidden',
                                name:'forward_status',
                                value:-7,
                                readOnly:true
                            },
                            {
                                xtype:'textarea',
                                fieldLabel: '项目退回原因(限200字)',
                                name: 'applicant_opinion',
                                anchor:'85%',
                                maxLength:200
                            }
                        ],
                        buttons:[
                            {
                                text: '提交项目退回申请',
                                handler:function(){
                                    var frm=Ext.getCmp(from_id);
                                    if (!frm.getForm().isValid()) return;
                                    frm.getForm().submit({
                                         waitMsg: '正在提交数据',
                                         waitTitle: '提示',
                                         url: '/project/rollback/add/',
                                         success: function(form, action) {
                                            if (action.result.msg != 'OK') {
                                                alert(action.result.msg);
                                            }
                                            else
                                            {
                                                alert('项目退回申请已经提交');
                                            }

                                            Main.tab_panel.remove(id);
                                         },
                                         failure: function(form, action) {
                                            if (action
                                                && action.hasOwnProperty('result')
                                                && action.result.hasOwnProperty('msg')
                                                && action.result.msg) {
                                                error(action.result.msg);
                                            }
                                            else {
                                                error('发生异常！');
                                            }
                                         }
                                    });
                                }
                            },
                            {
                                text: '清空表单',
                                handler:function(){
                                    var from=Ext.getCmp('prject_apply_add');
                                    from.getForm().reset();
                                }
                            }
                        ]
                    }]
                   });
                exisTab.show();
            }
            Main.tab_panel.setActiveTab(exisTab);
        }

        Main.ShowProjectEndingApply=function(josn){
            Main.ClearTab();
            var exisTab = Main.tab_panel.findById('项目结项申请');
            if(!exisTab) {
                exisTab = Main.tab_panel.add({
                    closable: true,
                    id: '项目结项申请',
                    title: '项目结项申请',
                    layout: {
                        type: 'fit'
                    },
                    items:[{
                        xtype:'form',
                        id:'prject_ending_add',
                        labelWidth: 100,
                        autoScroll: true,
                        defaultType: 'textfield',
                        items: [
                            {
                                name:'project_apply_id',
                                value:josn.pk,
                                readOnly:true,
                                xtype:'hidden'
                            },
                            {
                                xtype:'fieldset',
                                title: '数据表',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                defaults:{
                                    allowBlank:false
                                },
                                items :[
                                    {
                                       columnWidth :.33, // 该列有整行中所占百分比
                                       layout : "form", // 从上往下的布局
                                       border:false,
                                       items : [{
                                          xtype : "textfield",
                                          fieldLabel : "最终成果名称",
                                          name:'final_achieve_name',
                                          allowBlank:false,
                                          anchor:'75%'
                                       }]
                                    },
                                    {
                                       columnWidth :.33, // 该列有整行中所占百分比
                                       layout : "form", // 从上往下的布局
                                       border:false,
                                       items : [{
                                          xtype : "textfield",
                                          fieldLabel : "主要参加人",
                                          name:'main_user_name',
                                          allowBlank:false,
                                          anchor:'75%'
                                       }]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                                columnWidth :.5,
                                                layout : "form", 
                                                border:false,
                                                items : [{
                                                    xtype : "textfield",
                                                    fieldLabel : "成果形式",
                                                    allowBlank:false,
                                                    anchor:'90%',
                                                    name:'achive_fomat'
                                                }]
                                            },
                                            {
                                                columnWidth :.5, 
                                                layout : "form", 
                                                border:false,
                                                items : [
                                                {
                                                    xtype:'combo',
                                                    mode:'local',
                                                    editable:false,
                                                    valueField:'name',
                                                    displayField:   'name',
                                                    fieldLabel : "研究类别",
                                                    triggerAction:  'all',
                                                    forceSelection: true,
                                                    name: 'study_type_name_s',
                                                    hiddenName:'study_type_name',
                                                    anchor:'55%',
                                                    value:'基础研究',
                                                    store:new Ext.data.JsonStore({
                                                        fields : ['name'],
                                                        data:[
                                                            {name:'基础研究'},
                                                            {name:'应用研究'},
                                                            {name:'综合研究'},
                                                            {name:'其它研究'}
                                                        ]
                                                    })
                                               }]
                                            }
                                           
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                                columnWidth :.5,
                                                layout : "form", 
                                                border:false,
                                                items : [
                                                    DefaultDateFeild({
                                                      vtype:'future_date',
                                                      name:'plain_end_time',
                                                      fieldLabel : "计划完成时间",
                                                      anchor:'78%'
                                                   })]
                                            },
                                            {
                                                columnWidth :.5, 
                                                layout : "form", 
                                                border:false,
                                                items : [
                                                    DefaultDateFeild({
                                                      vtype:'future_date',
                                                      name:'real_end_time',
                                                      fieldLabel : "实际完成时间",
                                                      anchor:'78%'
                                                   })]
                                        }]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                 
                                        items:[
                                            {
                                               columnWidth :.3, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "字数",
                                                  name:'font_num',
                                                  vtype:'positive',
                                                  allowBlank:false,
                                                  anchor:'85%'
                                               }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "出版单位和时间",
                                                  name:'unit_and_time',
                                                  allowBlank:false,
                                                  anchor:'85%'

                                               }]
                                            }
                                            
                                        ]
                                    },
                                    {
                                        xtype:'textarea',
                                        fieldLabel : "使用范围去向(限400字)",
                                        anchor:'90%',
                                        name:'go_where',
                                        allowBlank:false,
                                        height:150,
                                        maxLength:400
                                    },
                                    {   
                                        xtype:'fieldset',
                                        title: '一、项目承担人的主要成果(注：成果形式为“研究报告”者填“使用单位”,限填10项)',
                                        collapsible: true,
                                        anchor:'100%',
                                        layout:"form",
                                        id:'project_end_apply_applicant_achieve_add',
                                        items:[
                                            {
                                                xtype:'fieldset',
                                                title: '成果 1',
                                                anchor:'100%',
                                                items:[
                                                    {
                                                      xtype : "textfield",
                                                      fieldLabel:'成果名称',
                                                      allowBlank:false,
                                                      name:'g__achieves__name__1',
                                                      anchor:'78%'
                                                    },
                                                    {
                                                      xtype : "textfield",
                                                      fieldLabel:'刊物年期、出版社和出版日期、使用单位',
                                                      allowBlank:false,
                                                      name:'g__achieves__unit_and_time__1',
                                                      anchor:'78%'
                                                    },
                                                    {
                                                      xtype : "textarea",
                                                      anchor:'78%',
                                                      name:'g__achieves__desc__1',
                                                      allowBlank:false,
                                                      fieldLabel:'近几年与本课题相关的研究成果'
                                                    }
                                                ]
                                            }
                                        ],
                                        buttons: [{
                                            text: '继续添加',
                                            handler:function(){
                                                var f=Ext.getCmp('project_end_apply_applicant_achieve_add');
                                                var index=f.items.length+1;
                                                if(index>10){
                                                    alert('限填10项,无法继续添加信息了！');
                                                    return;
                                                }
                                                f.add({
                                                    xtype:'fieldset',
                                                    title: '成果 '+index,
                                                    anchor:'80%',
                                                    items:[
                                                        {
                                                            xtype:'fieldset',
                                                            title: '成果 1',
                                                            anchor:'100%',
                                                            items:[
                                                                {
                                                                  xtype : "textfield",
                                                                  fieldLabel:'成果名称',
                                                                  allowBlank:false,
                                                                  name:'g__achieves__name__'+index,
                                                                  anchor:'78%'
                                                                },
                                                                {
                                                                  xtype : "textfield",
                                                                  fieldLabel:'刊物年期、出版社和出版日期、使用单位',
                                                                  allowBlank:false,
                                                                  name:'g__achieves__unit_and_time__'+index,
                                                                  anchor:'78%'
                                                                },
                                                                {
                                                                  xtype : "textarea",
                                                                  anchor:'78%',
                                                                  name:'g__achieves__desc__'+index,
                                                                  allowBlank:false,
                                                                  fieldLabel:'近几年与本课题相关的研究成果'
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                });
                                                f.doLayout(); 
                                            }

                                        },{
                                            text: '移除',
                                            handler:function(){
                                                var f=Ext.getCmp('project_end_apply_applicant_achieve_add');
                                                var index=f.items.length;
                                                if(index<=1)return;
                                                var cmp=f.items.items[index-1];
                                                f.remove(cmp,true);
                                            }
                                        }]
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '二、最终成果内容简介 ',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                items :[
                                    {
                                        xtype:'panel',
                                        border:false,
                                        html:'项目依托单位意见（意见分为四种：A、同意结项；B、未达到要求，不同意结项；C、经项目组申请，延期一年结项； D、建议撤销项目。）'
                                    },
                                    {
                                        xtype:'textarea',
                                        anchor:'100%',
                                        fieldLabel:'内容(限500字)',
                                        allowBlank:false,
                                        height:250,
                                        maxLength:500,
                                        name:'final_desc'
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '国家民委教育科技司意见 ',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                items :[
                                    {
                                        xtype:'textarea',
                                        anchor:'100%',
                                        fieldLabel:'内容(限500字)',
                                        allowBlank:false,
                                        height:250,
                                        maxLength:500,
                                        name:'mingwei_option'
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '附件',
                                collapsible: true,
                                labelWidth:300,
                                autoHeight:true,
                                items :[{
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[{
                                            columnWidth :.6, 
                                            layout : "form", 
                                            border:false,
                                            items : [{
                                              xtype : "textfield",
                                              id:'project_end_apply_file_code',
                                              fieldLabel : '文档编号(上传项目申请书后自动生成)',
                                              allowBlank:false,
                                              width:250,
                                              readOnly:true,
                                              name:'file_code'
                                            }]
                                        },
                                        {
                                            columnWidth :.4, 
                                            layout : "form", 
                                            border:false,
                                            items : [
                                                {
                                                    xtype : "button",
                                                    text : "上传项目结项申请书",
                                                    handler:function(){
                                                        var form = new Ext.form.FormPanel({
                                                            baseCls: 'x-plain',
                                                            labelWidth: 80,
                                                            fileUpload:true,
                                                            items: [{
                                                                xtype: 'fileuploadfield',
                                                                anchor: '90%',
                                                                name: 'file',  
                                                                allowBlank:false,
                                                                listeners:{ 
                                                                    fileselected:function(input,value){
                                                                        var ext=/\.[^\.]+$/.exec(value);
                                                                        if(ext!='.doc'&&ext!='.docx'){
                                                                             alert('请选择有效的Word文件！');
                                                                             input.reset();
                                                                        }
                                                                       
                                                                    }
                                                                }
                                                            }]
                                                        });

                                                        var win = new Ext.Window({
                                                            title: '上传填写完整的Word文档',
                                                            width: 400,
                                                            height:200,
                                                            minWidth: 300,
                                                            minHeight: 100,
                                                            layout: 'fit',
                                                            plain:true,
                                                            bodyStyle:'padding:5px;',
                                                            items: form,
                                                            buttons: [
                                                                {
                                                                  xtype : "button",
                                                                  text : "上传",
                                                                  handler:function(){
                                                                    if(!form.getForm().isValid())return;
                                                                    var ext=/\.[^\.]+$/.exec(form.items.items[0].value);
                                                                    if(isArrary(ext))ext=ext[0];
                                                                    form.getForm().submit({
                                                                        clientValidation:true,
                                                                        method:"post",
                                                                        params: {
                                                                          'ext':ext,
                                                                          'csrf_token': Ext.util.Cookies.get('csrftoken'),
                                                                          'csrf_name': 'csrftoken',
                                                                          'csrf_xname': 'X-CSRFToken'
                                                                        },
                                                                        url:'/project/apply/doc/upload/',
                                                                        success:function (form, action) {
                                                                            alert('上传成功！');
                                                                            var txt=Ext.getCmp('project_end_apply_file_code');
                                                                            txt.setValue(action.result.code);
                                                                            
                                                                            form.reset();
                                                                            win.close();
                                                                        },
                                                                        failure:function (form, action) {
                                                                            if (action
                                                                                && action.hasOwnProperty('result')
                                                                                && action.result.hasOwnProperty('msg')
                                                                                && action.result.msg) {
                                                                                error(action.result.msg);
                                                                            }
                                                                            else {
                                                                                error('发生异常！');
                                                                            }
                        
                                                                            form.reset();
                                                                            win.close();
                                                                        }
                                                                    });
                                                                  }  
                                                                },
                                                                {
                                                                    text: '关闭',
                                                                    handler:function(){win.close();}
                                                                }
                                                            ]
                                                        });
                                                        win.show();
                                                    }
                                                } 
                                            ]
                                        }]
                                }]
                            }
                        ],
                        buttons:[
                            {
                                text: '提交项目结项申请',
                                handler:function(){
                                    var frm=Ext.getCmp('prject_ending_add');
                                    // debugform(frm);
                                    // return;
                                    if (!frm.getForm().isValid()) return; 
                                    frm.getForm().submit({
                                         waitMsg: '正在提交数据',
                                         waitTitle: '提示',
                                         url: '/project/end/add/',
                                         success: function(form, action) {
                                            if (action.result.msg != 'OK') {
                                                alert(action.result.msg);
                                            }
                                            else{
                                                alert('保存成功！')
                                            }
                                            Main.tab_panel.remove(exisTab.id);
                                         },
                                         failure: function(form, action) {
                                            if (action
                                                && action.hasOwnProperty('result')
                                                && action.result.hasOwnProperty('msg')
                                                && action.result.msg) {
                                                error(action.result.msg);
                                            }
                                            else {
                                                error('发生异常！');
                                            }
                                         }
                                    });
                                }
                            },
                            {
                                text: '清空表单',
                                handler:function(){
                                    var from=Ext.getCmp('prject_ending_add');
                                    from.getForm().reset();
                                }
                            }
                        ]
                    }]
                   });
                exisTab.show();
            }
            Main.tab_panel.setActiveTab(exisTab);
        }

        root.appendChild({
            text:'我的项目',
            leaf:true,
            iconCls:'Driveuser',
            list:{
                id:'my_project_grid',
                url:"/project/apply/list/",
                columes:[
                    {
                        header:'项目名称',
                        dataIndex:'project_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {
                        header:'结项时间',
                        dataIndex:'project_comple_time',
                        flex:1,
                        renderer:function(value, cellmeta, record, rowIndex, columnIndex, store){
                            return record.data.status==1?value:'';
                        }
                    },
                    {header:'审核状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {
                        header:'预警状态',
                        dataIndex:'pk',
                        flex:1,
                        renderer:function(value, cellmeta, record, rowIndex, columnIndex, store){
                            for (var i = Main.WaringProjects.length - 1; i >= 0; i--) {
                                if(Main.WaringProjects[i]==value){
                                    return "预警";
                                }
                            };
                        }
                    },
                    {header:'学科分类', dataIndex:'study_type_name', flex:1},
                    {header:'PDF',flex:1,dataIndex:'pk', width:50,
                        renderer:function(value){
                           return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    }
                ],
                listeners:{
                    cellclick:DefaultCellHanlder({
                        applyPdfIdx:7,
                        applyIdx:1
                    })
                },
                tbar:[
                    {
                        text:'项目退回申请',
                        iconCls:'Applicationadd',
                        handler:function () {
                            var grid=Ext.getCmp('my_project_grid');
                            var sel= grid.getJsonArr();
                            if(sel&&sel.length!=1){
                                alert('请单选需要退回的项目！');
                                return;
                            }
                            var json=sel[0].json;
                            if(json.status==-2||json.status==-1)
                            {
                                Main.ShowProjectRollbackApply(sel[0].json);
                            }
                            else
                            {
                                alert('无法对项目执行退回操作！');
                            }
                        }
                    },
                    {
                        text:'项目变更申请',
                        iconCls:'Applicationedit',
                        handler:function () {
                            var grid=Ext.getCmp('my_project_grid');
                            var sel= grid.getJsonArr();
                            if(sel.length!=1){
                                alert('请单选需要变更的项目！');
                                return;
                            }

                            if(sel[0].json.status!=1)
                            {
                                alert('必须立项的项目方可进行该操作！');
                                return;
                            }

                            Main.ShowProjectChangeApply(sel[0].json);
                        }
                    },
                    {
                        text:'项目结项申请',
                        iconCls:'Applicationget',
                        handler:function () {
                            var grid=Ext.getCmp('my_project_grid');
                            var sel= grid.getJsonArr();
                            if(sel.length!=1){
                                alert('请单选需要退回的项目！');
                                return;
                            }

                            if(sel[0].json.status!=1)
                            {
                                alert('必须立项的项目方可进行该操作！');
                                return;
                            }
                            Main.ShowProjectEndingApply(sel[0].json);
                        }
                    },
                    {
                        text:'查看审核历史记录',
                        iconCls:'Bookopen',
                        handler:function(){
                            var grid=Ext.getCmp('my_project_grid');
                            Main.ShowProjectApplyApproveHistory(grid,true);
                        }
                    }
                ]
            }
        });

        root.appendChild({
            text:'新建项目',
            leaf:true,
            iconCls:'Applicationadd',
            list:{
                url:"/project/apply/list/",
                baseParams:{
                    waitsubmit:true
                },
                id:'my_project_apply_id',
                columes:[
                    {
                        header:'项目名称',
                        dataIndex:'project_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {header:'学科分类', dataIndex:'study_type_name', flex:1},
                    {header:'PDF',flex:1,dataIndex:'pk', width:50,
                        renderer:function(value){
                           return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    }
                ],
                listeners:{
                    cellclick:DefaultCellHanlder({
                        applyPdfIdx:7,
                        applyIdx:1
                    })
                },
                tbar:[
                    {
                        text:'项目立项申请',
                        iconCls:'Applicationadd',
                        handler:function () {
                            Main.ShowProjectApply();
                        }
                    },
                    {
                        text:'项目修改',
                        iconCls:'Applicationedit',
                        handler:function () {
                            var grid=Main.CurrentGrid();
                            var sel= grid.getJsonArr();
                            if(sel.length!=1){
                                alert('请单选需要修改的项目！');
                                return;
                            }
                            var json=sel[0].json;
                            Main.ModifyProjectApply(json);
                        }
                    },
                    {
                        text:'提交项目申请',
                        iconCls:'Applicationget',
                        handler:function () {
                            var grid=Main.CurrentGrid();
                            var sel= grid.getIdArr();
                            Ext.Ajax.request({
                                url:"/project/apply/submit/",
                                method:'post',
                                params:{
                                    ids:sel.join()
                                },
                                success:function(response){
                                    alert('项目已经提交，等待二级管理员审核！');
                                    grid.getStore().reload();
                                }
                            });
                        }
                    }
                ]
            }
        });
        
        node = {
            text:'事务记录',
            expanded:true,
            leaf:false,
            iconCls:'Database',
            children:[]
        };

        node.children.push({
            text:'变更',
            leaf:true,
            iconCls:'Databaseedit',
            list:{
                id:'applicant_project_exchange_gird',
                url:"/project/exchange/list/",

                columes:[
          
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'项目状态', dataIndex:'project_status', flex:1, renderer:XG.Render.ProjectStatus },
                    {header:'申请变更状态', dataIndex:'forward_status', flex:1, renderer:XG.Render.ProjectStatus },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {dataIndex:'applicant_opinion'}
                ],

                tbar:[{
                    text:'查看审核历史记录',
                    iconCls:'Bookopen',
                    handler:function(){
                        var grid=Ext.getCmp('applicant_project_exchange_gird');
                        Main.ShowProjectExchangeApproveHistory(grid);
                    }
                }],
                viewConfig:{
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>申请原因: '+record.data.applicant_opinion+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                }
            }
            
        });
        


        node.children.push({
            text:'结项',
            leaf:true,
            iconCls:'Databasegear',
            list:{
                id:'applicant_project_end_gird',
                url:"/project/end/list/",
                columes:[
                    {
                        header:'最终成果名称', 
                        dataIndex:'final_achieve_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目编号', dataIndex:'project__no', flex:1},
                    {header:'主要参加人', dataIndex:'main_user_name', flex:1 },
                    {header:'计划完成时间', dataIndex:'plain_end_time', flex:1 },
                    {header:'实际完成时间', dataIndex:'real_end_time', flex:1 },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {header:'PDF',flex:1,dataIndex:'document_id', width:50,
                        renderer:function(value){
                           return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    }
                ],
                listeners:{
                    cellclick:DefaultCellHanlder({
                        pdfIdx:7,
                        applyIdx:1
                    })
                },
                tbar:[{
                    text:'查看审核历史记录',
                    iconCls:'Bookopen',
                    handler:function(){
                        var grid=Ext.getCmp('applicant_project_end_gird');
                        Main.ShowProjectEndApproveHistroy(grid);
                    }
                }]
            }
        });
        

        node.children.push({
            text:'退回',
            leaf:true,
            iconCls:'Databasego',
            list:{
                id:'applicant_project_back_gird',
                url:"/project/rollback/list/",
                columes:[
                    {header:'项目名称', dataIndex:'project_name', flex:1},
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {dataIndex:'applicant_opinion'}
                ],

                viewConfig:{
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>申请原因: '+record.data.applicant_opinion+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                },
                tbar:[{
                    text:'查看审核历史记录',
                    iconCls:'Bookopen',
                    handler:function(){
                        var grid=Ext.getCmp('applicant_project_back_gird');
                        Main.ShowProjectRollbackApproveHistroy(grid);
                    }
                }]
            }
        });

        root.appendChild(node);

        node = {
            text:'消息管理',
            expanded:true,
            leaf:false,
            iconCls:'Comments',
            children:[]
        };

   

        node.children.push({
            text:'系统消息',
            leaf:true,
            iconCls:'Computer',
            list:{
                id:'wait_pub_message_list',
                url:"/message/list/",
                columes:[
                    {header:'消息标题', dataIndex:'title', flex:1},
                    {header:'消息摘要', dataIndex:'abstract', flex:1 },
                    {header:'发送时间', dataIndex:'send_time', flex:1 },
                    {header:'发送人', dataIndex:'sender_name', flex:1 },
                    {header:'发送人姓名', dataIndex:'sender_real_name', flex:1 },
                    {header:'发送人单位', dataIndex:'sender_unit__name', flex:1 },
                    {dataIndex:'content'}
                ],
                viewConfig: {
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>消息内容: '+record.data.content+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                }
            }
        });

        root.appendChild(node);
    });
</script>
{%endifequal%}
{% endblock %}

