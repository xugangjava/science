{% extends "base.html" %}
{%block scripts%}core/main.js{% endblock %}
{%block body%}
<script type="text/javascript">
    Ext.ns('Main');
    Ext.onReady(function () {
        Ext.QuickTips.init();
        Main.UnitName='{{user.unit.name}}';
        Main.AuthLevel = '{{user.unit.level}}';
        Main.UserUnitID='{{user.unit_id}}';
        Main.ProjectTypes='{{project_types}}';
        if(Main.ProjectTypes!='')
        {
            var arry=Main.ProjectTypes.split(';');
            var b;
            Main.ProjectTypes=[];
            for(var i=0;i<arry.length;i++)
            {
                b=arry[i].split(',');
                Main.ProjectTypes.push({
                    pk:parseInt(b[0]),
                    name:b[1]
                });
            }
        }
        Main.UserID='{{user.pk}}';
        Ext.get("head_info").dom.innerHTML =
        "<h1 style='font-size:21;font-family: sans-serif;'>欢迎<{{user.real_name}}>，您当前的角色为<{{user.role_name}}></h1>";
        Main.ShowApprovesWin=function(config){
            var sel= config.grid.getJsonArr();
            if(sel.length!=1){
                alert('请单选需要查看的项目！');
                return;
            }
            var pk=sel[0].json.pk;
            var baseParams={
                pk:pk
            };
            Ext.applyIf(baseParams,config,baseParams);
            var win=new Ext.Window({
                title:'审核历史记录',
                closable:true,
                closeAction:'close',
                modal:true,
                constrain:true,
                width:640,
                height:400,
                layout:'fit',
                items:[
                {
                    xtype:'basegrid',
                    url:config.url,
                    baseParams:baseParams,
                    notbar:true,
                    nocheck:true,
                    columes:config.columes,
                    // customize view config
                    viewConfig: {
                        forceFit:true,
                        enableRowBody:true,
                        showPreview:true,
                        getRowClass : function(record, rowIndex, p, store){
                            if(this.showPreview){
                                p.body = '<p>审核意见: '+record.data[config.option]+'</p>';
                                return 'x-grid3-row-expanded';
                            }
                            return 'x-grid3-row-collapsed';
                        }
                    }
                }]
            });
            win.show(this); 
        };

        Main.ShowProjectApplyApproveHistory=function(grid){
            Main.ShowApprovesWin({
                grid:grid,
                url:'/project/apply/approves/',
                columes:[
                    {header:'审核人', dataIndex:'approve__name', flex:1 },
                    {header:'角色', dataIndex:'approve__role__name', flex:1 },
                    {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                    {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                    {header:'审核时间', dataIndex:'approvetime', flex:1 },
                    {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                    {dataIndex:'approve_opinion'}
                ],
                option:'approve_opinion'
            });
        };

        Main.ShowProjectExchangeApproveHistory=function(grid){
            Main.ShowApprovesWin({
                grid:grid,
                url:'/project/exchange/approves/',
                columes:[
                    {header:'审核人', dataIndex:'approve__name', flex:1 },
                    {header:'角色', dataIndex:'approve__role__name', flex:1 },
                    {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                    {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                    {header:'审核时间', dataIndex:'approvetime', flex:1 },
                    {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                    {dataIndex:'approve_opinion'}
                ],
                option:'approve_opinion'
            });
        };

        Main.ShowProjectEndApproveHistroy=function(grid){
            Main.ShowApprovesWin({
                grid:grid,
                url:'/project/end/approves/',
                columes:[
                    {header:'审核人', dataIndex:'approve__name', flex:1 },
                    {header:'角色', dataIndex:'approve__role__name', flex:1 },
                    {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                    {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                    {header:'审核时间', dataIndex:'approvetime', flex:1 },
                    {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                    {dataIndex:'approve_opinion'}
                ],
                option:'approve_opinion'
            });
        };

        Main.ShowProjectRollbackApproveHistroy=function(grid){
            Main.ShowApprovesWin({
                grid:grid,
                url:'/project/back/approves/',
                columes:[
                    {header:'审核人', dataIndex:'approve__name', flex:1 },
                    {header:'角色', dataIndex:'approve__role__name', flex:1 },
                    {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                    {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                    {header:'审核时间', dataIndex:'approvetime', flex:1 },
                    {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                    {dataIndex:'approve_opinion'}
                ],
                option:'approve_opinion'
            });
        };





    });
</script>
{%ifequal user.role.code 'admin'%}
<script type="text/javascript">
Ext.onReady(function () {
    var root = Main.tree.getRootNode();
    var node;
    var pk;
    Ext.TaskMgr.start({
        run: function(){
            Ext.Ajax.request({  
                url:'/user/notify/count/',
                method:'post',  
                success:function(response,options){
                    var res = Ext.util.JSON.decode(response.responseText);  
                    var root= Main.tree.getRootNode();
                    var r=root.childNodes[0];
                    var childrens=r.childNodes;//项目申请
                    for (var i = childrens.length - 1; i >= 0; i--) {
                        var n=childrens[i];
                        if(n.text.indexOf('项目申请')!=-1)
                            n.setText('项目申请('+res.apply+')');
                        else if(n.text.indexOf('项目评审')!=-1)
                            n.setText('项目评审('+res.apply_ask_expert+')');
                        else if(n.text.indexOf('项目变更')!=-1)
                            n.setText('项目变更('+res.exchange+')');
                        else if(n.text.indexOf('项目结项')!=-1)
                            n.setText('项目结项('+res.end+')');
                    }
                }
            });
        },
        interval: 3000
    });
    Main.ShowAdminApprovedWin=function(config){

        var win=new Ext.Window({
            title:'历史记录',
            closable:true,
            closeAction:'close',
            modal:true,
            constrain:true,
            width:700,
            height:400,
            layout:'fit',
            items:[
            {
                xtype:'basegrid',
                url:config.url,
                notbar:true,
                nocheck:true,
                columes:config.columes,
                // customize view config
                viewConfig: {
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>审核意见: '+record.data[config.option]+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                },
                tbar:config.tbar
            }]
        });
        win.show(this); 
    };
    Main.ShowAdminProjectApplyApproveHistory=function(grid,pass,build){
        if(null==pass)pass=-1;
        if(null==build)build=-1;
        var initConfig={
            grid:grid,
            url:'/project/admin/apply/approves/?pass='+pass+'&build='+build,
            columes:[

                {header:'项目名称',dataIndex:'details__project_name',flex:1},
                {header:'项目编号',dataIndex:'details__project_no',flex:1},
                {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                {header:'审核时间', dataIndex:'approvetime', flex:1 },
                {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                {dataIndex:'approve_opinion'}
            ],
            option:'approve_opinion'
        };
        if(build==1){
            initConfig.tbar=[{
                text:'导出Excel',
                iconCls:'Pagewhiteexcel',
                handler:function(){
                    window.open('/project/admin/project/done/xls/export/');
                }
            }]
        }
        Main.ShowAdminApprovedWin(initConfig);
    };

    Main.ShowAdminProjectExchangeApproveHistory=function(grid,pass){
        if(pass==null)pass=-1;
        Main.ShowAdminApprovedWin({
            grid:grid,
            url:'/project/admin/exchange/approves/?pass='+pass,
            columes:[
                {header:'项目名称',dataIndex:'details__project__name',flex:1},
                {header:'项目编号',dataIndex:'details__project__no',flex:1},
                {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                {header:'审核时间', dataIndex:'approvetime', flex:1 },
                {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                {dataIndex:'approve_opinion'}
            ],
            option:'approve_opinion'
        });
    };

    Main.ShowAdminProjectEndApproveHistroy=function(grid,pass){
        if(pass==null)pass=-1;
        Main.ShowAdminApprovedWin({
            grid:grid,
            url:'/project/admin/end/approves/?pass='+pass,
            columes:[
                {header:'项目名称',dataIndex:'details__project__name',flex:1},
                {header:'项目编号',dataIndex:'details__project__no',flex:1},
                {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                {header:'审核时间', dataIndex:'approvetime', flex:1 },
                {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                {dataIndex:'approve_opinion'}
            ],
            option:'approve_opinion'
        });
    };

    Main.ShowAdminProjectRollbackApproveHistroy=function(grid){
        Main.ShowAdminApprovedWin({
            grid:grid,
            url:'/project/admin/back/approves/',
            columes:[
                {header:'项目名称',dataIndex:'details__project__name',flex:1},
                {header:'项目编号',dataIndex:'details__project__no',flex:1},
                {header:'审核单位', dataIndex:'approve__unit__name', flex:1},
                {header:'单位级别', dataIndex:'approve__unit__level', flex:1,renderer:XG.Render.UnitLevel},
                {header:'审核时间', dataIndex:'approvetime', flex:1 },
                {header:'审核结果', dataIndex:'success', flex:1, renderer:function(value){return value?'通过':'退回'}},
                {dataIndex:'approve_opinion'}
            ],
            option:'approve_opinion'
        });
    };



    node = {
        text:'项目审核',
        expanded:true,
        leaf:false,
        children:[]
    };


    if(0==Main.AuthLevel){
        node.children.push({
            text:'项目审查',
            leaf:true,
            list:{
                id:'admin_project_option_gird',
                url:"/project/apply/list/",
                columes:[
                    {
                        header:'项目名称', 
                        dataIndex:'project_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'审核状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {header:'学科分类', dataIndex:'study_type_name', flex:1},
                    {header:'PDF',flex:1,dataIndex:'pk', width:50,
                        renderer:function(value){
                           return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    }
                ],
                tbar:{
                    project_apply_type_combo:{p_types:Main.ProjectTypes},
                    approve_row:{
                        title:"项目审查",
                        url:'/project/apply/approve/', 
                        iconCls:'Useralert',
                        optionText:'审查意见',
                        argreeText:'同意',
                        disargreeText:'拒绝',
                        items:[{xtype:'hidden',name:'wait_admin_look',value:1}]
                    },
                    handlers:[
                        // "学科代号",
                        // {
                        //     xtype:'textfield',
                        //     id:'tbar_study_type_name'
                        // },
                        // {
                        //     text:'学科分类',
                        //     iconCls:'Applicationviewlist',
                        //     handler:function(){
                        //         var txt=Ext.getCmp('tbar_study_type_name');
                        //         txt=txt.getValue();
                        //         if(''==txt){
                        //             alert('请填写学科代号!');
                        //             return;
                        //         }
                        //         var grid=Ext.getCmp('admin_project_option_gird');
                        //         grid.getStore().load({
                        //             params:{
                        //                 study_type_name:txt,
                        //                 start:0,
                        //                 limit:20
                        //             }
                        //         });
                        //     }
                        // },
          
                        {
                            text:'查看审核历史记录',
                            iconCls:'Bookopen',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                Main.ShowProjectApplyApproveHistory(grid);
                            }
                        },
                        {
                            text:'未通过项目',
                            iconCls:'Bookkey',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                Main.ShowAdminProjectApplyApproveHistory(grid,0);
                            }
                        },
                        {
                            text:'已通过项目',
                            iconCls:'Bookprevious',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                Main.ShowAdminProjectApplyApproveHistory(grid,1);
                            }
                        }

                    ]
                },
                listeners:{
                    cellclick:DefaultCellHanlder({
                        applyPdfIdx:7,
                        applyIdx:1
                    })
                },
                baseParams:{
                    wait_admin_look:0
                }
            }
        });

        node.children.push({
            text:'项目评审',
            leaf:true,
            list:{
                id:'admin_project_option_gird',
                url:"/project/apply/list/",
                columes:[
                    {
                        header:'项目名称', 
                        dataIndex:'project_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'审核状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {header:'学科分类', dataIndex:'study_type_name', flex:1},
                    {header:'PDF',flex:1,dataIndex:'pk', width:50,
                        renderer:function(value){
                           return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    }
                ],
                tbar:{
                    project_apply_type_combo:{p_types:Main.ProjectTypes},
                    handlers:[

                        // "学科代号",
                        // {
                        //     xtype:'textfield',
                        //     id:'tbar_study_type_name'
                        // },
                        // {
                        //     text:'学科分类',
                        //     iconCls:'Applicationviewlist',
                        //     handler:function(){
                        //         var txt=Ext.getCmp('tbar_study_type_name');
                        //         txt=txt.getValue();
                        //         if(''==txt){
                        //             alert('请填写学科代号!');
                        //             return;
                        //         }
                        //         var grid=Ext.getCmp('admin_project_option_gird');
                        //         grid.getStore().load({
                        //             params:{
                        //                 study_type_name:txt,
                        //                 start:0,
                        //                 limit:20
                        //             }
                        //         });
                        //     }
                        // },
                        {
                            text:'选择专家评审',
                            iconCls:'Useralert',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                var r=grid.getStore().data.items;
                                if(r.length<1){
                                    alert('未选中任何项目！');
                                    return;
                                };
                                var type=r[0].data.study_type_name;
                                for(var i=0;i<r.length;i++){
                                    if(type!=r[i].data.study_type_name){
                                        alert('请选择学科代号相同的项目！')
                                        return;
                                    }
                                };
                                win=new Ext.Window({
                                    title:'选择专家评审',
                                    closable:true,
                                    closeAction:'close',
                                    width:350,
                                    minWidth:200,
                                    height:200,
                                    layout:{type:'absolute'},
                                    modal:true,
                                    items:[
                                        {xtype:"label", text:"选择专家:", x:5, y:5},
                                        {
                                            x:65, 
                                            y:5,
                                            name:'expert_ids',
                                            id:'amind_set_extpert_ids',
                                            allowBlank:false,
                                            xtype:'superboxselect',
                                            emptyText: '选择该学科的专家',
                                            resizable: true,
                                            minChars: 2,
                                            store:{
                                                xtype: 'jsonstore',
                                                totalProperty:'total',
                                                idProperty:'pk',
                                                fields:['pk','name'],
                                                root:'items',
                                                url:'/expert/combo/',
                                                baseParams:{
                                                    type:type
                                                }
                                            },
                                            mode: 'remote',
                                            displayField: 'name',
                                            valueField: 'pk',
                                            queryDelay: 0,
                                            triggerAction: 'all'
                                        }
                                    ],
                                    buttons:[{
                                        text:'确定',
                                        handler:function(){
                                            var expert_ids=win.items.itemAt(1).getValue();
                                            if(expert_ids==""||expert_ids.length<1){
                                                alert('请选择专家！')
                                                return;
                                            }
                                            var idArr = grid.getIdArr();
                                            win.close();
                                            Ext.Ajax.request({
                                                    url:'/expert/set/',
                                                    method:"post",
                                                    params:{
                                                        ids:idArr.join(),
                                                        expert_ids:expert_ids
                                                    },
                                                    success:function () {
                                                        win.close();
                                                        grid.getStore().load();
                                                        alert('设置成功!等待专家评审');
                                                    },
                                                    failure:function (form, action) {
                                                        win.close();
                                                        if ('result' in action) {
                                                            if ('msg' in action.result) {
                                                                error(action.result.msg);
                                                            }
                                                        }
                                                        else {
                                                            error('发生异常!');
                                                        }
                                                    }
                                                });
                                        }
                                    }]
                                });
                                win.show(this);
                            }
                        },
                        {
                            text:'查看审核历史记录',
                            iconCls:'Bookopen',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                Main.ShowProjectApplyApproveHistory(grid);
                            }
                        },
                        {
                            text:'送审项目',
                            iconCls:'Bookprevious',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_option_gird');
                                Main.ShowAdminProjectApplyApproveHistory(grid);
                            }
                        }

                    ]
                },
                listeners:{
                    cellclick:DefaultCellHanlder({
                        applyPdfIdx:7,
                        applyIdx:1
                    })
                },
                baseParams:{
                    admin_ask_expert:0
                }
            }
        });
    }

    node.children.push({
        text:'项目立项',
        leaf:true,
        list:{
            id:'admin_project_apply_list',
            url:"/project/apply/list/",
            columes:[
                {
                    header:'项目名称', 
                    dataIndex:'project_name', 
                    flex:1,
                    renderer:function(value){
                       return '<img src="/static/icons/zoom.png"/>'+value;
                    }.createDelegate(this)
                },
                {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                {header:'项目编号', dataIndex:'project_no', flex:1 },
                {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                {header:'审核状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                {header:'学科分类', dataIndex:'study_type_name', flex:1},
                {header:'PDF',flex:1,dataIndex:'pk', width:50,
                    renderer:function(value){
                       return '<img src="/static/icons/page_white_acrobat.png"/>';
                    }.createDelegate(this)
                }
            ],
            listeners:{
                cellclick:DefaultCellHanlder({
                    applyIdx:1,
                    applyPdfIdx:7
                })
            },
            tbar:{
                project_apply_type_combo:{p_types:Main.ProjectTypes},
                approve_row:{ 
                    title:"审核立项申请",
                    url:'/project/apply/approve/', 
                    iconCls:'Useralert',
                    items:[{xtype:'hidden',name:'wait_admin_look',value:0}]
                },
                handlers:[
                    {
                        text:'查看审核历史记录',
                        iconCls:'Bookopen',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_apply_list');
                            Main.ShowProjectApplyApproveHistory(grid);
                        }
                    },
                    {
                        text:'已立项的项目',
                        iconCls:'Bookkey',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_apply_list');
                            Main.ShowAdminProjectApplyApproveHistory(grid,-1,1);
                        }
                    },
                    {
                        text:'未立项的项目',
                        iconCls:'Bookprevious',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_apply_list');
                            Main.ShowAdminProjectApplyApproveHistory(grid,-1,0);
                        }
                    }
                ]
            }
        }
    });
    
    



    node.children.push({
        text:'项目变更',
        leaf:true,
        list:{
            id:'admin_project_exchange_gird',
            url:"/project/exchange/list/",
            columes:[
                {header:'项目名称', dataIndex:'project_name', flex:1},
                {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                {header:'项目编号', dataIndex:'project_no', flex:1 },
                {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                {header:'项目状态', dataIndex:'project_status', flex:1, renderer:XG.Render.ProjectStatus },
                {header:'申请变更状态', dataIndex:'forward_status', flex:1, renderer:XG.Render.ProjectStatus },
                {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                {dataIndex:'applicant_opinion'}
            ],
            tbar:{
                approve_row:{ title:"审核项目变更申请",url:'/project/exchange/approve/', iconCls:'Useralert'},
                handlers:[
                    {
                        text:'查看审核历史记录',
                        iconCls:'Bookopen',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_exchange_gird');
                            Main.ShowProjectExchangeApproveHistory(grid);
                        }
                    },
                    {
                        text:'同意变更',
                        iconCls:'Bookkey',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_exchange_gird');
                            Main.ShowAdminProjectExchangeApproveHistory(grid,1);
                        }
                    },
                    {
                        text:'不准变更',
                        iconCls:'Bookprevious',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_exchange_gird');
                            Main.ShowAdminProjectExchangeApproveHistory(grid,0);
                        }
                    }
                ]
            },
            viewConfig:{
                forceFit:true,
                enableRowBody:true,
                showPreview:true,
                getRowClass : function(record, rowIndex, p, store){
                    if(this.showPreview){
                        p.body = '<p>申请原因: '+record.data.applicant_opinion+'</p>';
                        return 'x-grid3-row-expanded';
                    }
                    return 'x-grid3-row-collapsed';
                }
            }
        }
    });

    //科技局管理员 无需审核
    if(0!=Main.AuthLevel)
    {
        node.children.push({
        text:'项目退回',
        leaf:true,
        list:{
                id:'admin_project_rollback_gird',
                url:"/project/rollback/list/",
                columes:[
                    {header:'项目名称', dataIndex:'project_name', flex:1},
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {dataIndex:'applicant_opinion'}
                ],
                viewConfig:{
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>申请原因: '+record.data.applicant_opinion+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                },
                tbar:{
                    approve_row:{ 
                        title:"审核项目退回申请",
                        url:'/project/rollback/approve/', 
                        iconCls:'Useralert'  
                    },
                    handlers:[
                        {
                            text:'查看审核历史记录',
                            iconCls:'Bookopen',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_rollback_gird');
                                Main.ShowProjectRollbackApproveHistroy(grid);
                            }
                        },
                        {
                            text:'查看已审核的记录',
                            iconCls:'Bookprevious',
                            handler:function(){
                                var grid=Ext.getCmp('admin_project_rollback_gird');
                                Main.ShowProjectRollbackApproveHistroy(grid);
                            }
                        }
                    ]
                }
            }
        });
    }

    

    node.children.push({
        text:'项目结项',
        leaf:true,
        list:{
            url:"/project/end/list/",
            id:'admin_project_end_gird',
            columes:[
                {
                    header:'最终成果名称', dataIndex:'final_achieve_name', flex:1,
                    renderer:function(value){
                       return '<img src="/static/icons/zoom.png"/>'+value;
                    }.createDelegate(this)
                },
                {header:'项目编号', dataIndex:'project__no', flex:1},
                {header:'主要参加人', dataIndex:'main_user_name', flex:1 },
                {header:'计划完成时间', dataIndex:'plain_end_time', flex:1 },
                {header:'实际完成时间', dataIndex:'real_end_time', flex:1 },
                {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                {header:'PDF',flex:1,dataIndex:'document_id', width:50,
                    renderer:function(value){
                       return '<img src="/static/icons/page_white_acrobat.png"/>';
                    }.createDelegate(this)
                }
            ],
            listeners:{
                cellclick:DefaultCellHanlder({
                    pdfIdx:7,
                    applyIdx:1
                })
            },
            tbar:{
                approve_row:{
                    title:"审核结项项目申请", 
                    url:'/project/end/approve/', 
                    iconCls:'Useralert'
                },
                handlers:[
                    {
                        text:'查看审核历史记录',
                        iconCls:'Bookopen',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_end_gird');
                            Main.ShowProjectEndApproveHistroy(grid);
                        }
                    },
                    {
                        text:'结项项目',
                        iconCls:'Bookkey',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_end_gird');
                            Main.ShowAdminProjectEndApproveHistroy(grid,1);
                        }
                    },
                    {
                        text:'未结项目',
                        iconCls:'Bookprevious',
                        handler:function(){
                            var grid=Ext.getCmp('admin_project_end_gird');
                            Main.ShowAdminProjectEndApproveHistroy(grid,0);
                        }
                    }
                ]
            }
        }
    });

    root.appendChild(node);
    node={
        text:'查询统计',
        expanded:true,
        leaf:false,
        children:[]
    };
    node.children.push({
        text:'项目检索',
        leaf:true,
        list:{
            url:"/project/search/",
            nocheck:true,
            id:'project_search_grid',
            columes:[
                {
                    header:'项目名称',
                    dataIndex:'name', 
                    flex:1,
                    renderer:function(value){
                       return '<img src="/static/icons/zoom.png"/>'+value;
                    }.createDelegate(this)
                },
                {header:'项目类型', dataIndex:'ptype__name', flex:1},
                {header:'项目编号', dataIndex:'no', flex:1 },
                {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                {header:'状态', dataIndex:'status', flex:1, renderer:function(value){
                    var status=Ext.getCmp('project_search_value_status').getValue();
                    if(status==3){
                        return XG.Render.ApproveStatus(value);
                    }
                    else{
                        return XG.Render.ProjectStatus(value);
                    }
                    
                }},
                {
                    header:'PDF',
                    flex:1,
                    dataIndex:'pk',
                    width:50,
                    renderer:function(value){
                       return '<img src="/static/icons/page_white_acrobat.png"/>';
                    }.createDelegate(this)
                }
            ],
            tbar:[
                "搜索条件",
                {   
                    xtype:'localcombo',
                    id:'text_project_search_key',
                    data:[
                    ['name','项目名称'],
                    ['applicant__name','申请人姓名'],
                    ['applicant_time','项目申请时间'],
                    ['unit__name','项目所属部门']],
                    listeners:{
                        select:function(box, record, index){
                            if(index==2){
                                Ext.getCmp('text_project_search_value').hide();
                                Ext.getCmp('project_search_value_start_date').show();
                                Ext.getCmp('project_search_value_end_date').show();
                                Ext.getCmp('project_search_lable').el.dom.innerHTML='起止时间';
                            }else{
                                Ext.getCmp('text_project_search_value').show();
                                Ext.getCmp('project_search_value_start_date').hide();
                                Ext.getCmp('project_search_value_end_date').hide();
                                Ext.getCmp('project_search_lable').el.dom.innerHTML='包含内容';
                            }
                        }
                    }
                },
                "-",
                {
                    xtype:'label',
                    id:'project_search_lable',
                    text:"包含内容"
                },
                {
                    xtype:'textfield',
                    id:'text_project_search_value'
                },

                DefaultDateFeild({
                    id:'project_search_value_start_date',
                    endDateField: 'project_search_value_end_date',
                    width:200,
                    hidden :true,
                    vtype:'daterange'
                }),
                DefaultDateFeild({
                    vtype:'daterange',
                    id:'project_search_value_end_date',
                    width:200,
                    hidden :true,
                    startDateField: 'project_search_value_start_date'
                }),

                "查询类型",
                {
                    xtype:'localcombo',
                    id:"project_search_value_status",
                    data:[
                        [2,'全部'],
                        [0,'正常'],
                        [1,'结项'],
                        [-5,'撤项'],
                        [-6,'延期'],
                        [-7,'退回'],
                        [3,'待审核的项目申请'],
                        [4,'待审核的变更申请'],
                        [5,'待审核的结项申请']
                    ]
                },
                {
                    xtype:'button',
                    text:'搜索',
                    iconCls:'zoom',
                    handler:function(){
                        var value=Ext.getCmp('text_project_search_value').getValue();
                        var key=Ext.getCmp('text_project_search_key').getValue();
                        var start_time=Ext.getCmp('project_search_value_start_date').value;
                        var end_time=Ext.getCmp('project_search_value_end_date').value;
                        var status=Ext.getCmp('project_search_value_status').getValue();
                        if(key=='applicant_time'){
                            if(start_time==""||end_time=="")
                            {
                                alert('请选择完整的起止时间！');
                                return;
                            }
                        }
                        var grid=Ext.getCmp('project_search_grid');
                        grid.getStore().load({
                            params:{
                                key:key,
                                value:value,
                                status:status,
                                start_time:start_time,
                                end_time:end_time,
                                start:0,
                                limit:20
                            }
                        });

                    }
                }
            ],
            listeners:{
                cellclick:DefaultCellHanlder({
                    pdf:5,
                    projectIdx:0
                })
            }
        }
    });

    Ext.chart.Chart.CHART_URL = '/static/charts.swf';
    node.children.push({
        text:'项目统计',
        leaf:true,
        view:{
            xtype:'panel',
            layout:'fit',
            items:[{
                store: new Ext.data.JsonStore({
                    fields: ['season', 'total'],
                    data: [{
                        season: '正常项目数量',
                        total: 0
                    },{
                        season: '延期项目数量',
                        total: 0
                    },{
                        season: '撤项项目数量',
                        total: 0
                    },{
                        season: '正常项目数量',
                        total: 0
                    }]
                }),
                id:'project_count',
                xtype: 'piechart',
                dataField: 'total',
                categoryField: 'season',
                extraStyle:
                {
                    legend:
                    {
                        display: 'bottom',
                        padding: 5,
                        font:
                        {
                            family: 'Tahoma',
                            size: 13
                        }
                    }
                }
            }],
            tbar:[
                "统计条件",
                {   
                    xtype:'localcombo',
                    id:'text_project_count_key',
                    data:[
                    ['name','项目名称'],
                    ['applicant__name','申请人姓名'],
                    ['applicant_time','项目申请时间'],
                    ['unit__name','项目所属部门']],
                    listeners:{
                        select:function(box, record, index){
                            if(index==2){
                                Ext.getCmp('text_project_count_value').hide();
                                Ext.getCmp('project_count_value_start_date').show();
                                Ext.getCmp('project_count_value_end_date').show();
                                Ext.getCmp('project_count_lable').el.dom.innerHTML='起止时间';
                            }else{
                                Ext.getCmp('text_project_count_value').show();
                                Ext.getCmp('project_count_value_start_date').hide();
                                Ext.getCmp('project_count_value_end_date').hide();
                                Ext.getCmp('project_count_lable').el.dom.innerHTML='包含内容';
                            }
                        }
                    }
                },
                "-",
                {
                    xtype:'label',
                    id:'project_count_lable',
                    text:"包含内容"
                },
                {
                    xtype:'textfield',
                    id:'text_project_count_value'

                },
                DefaultDateFeild({
                    id:'project_count_value_start_date',
                    endDateField: 'project_count_value_end_date',
                    width:200,
                    hidden :true,
                    vtype:'daterange'
                }),
                DefaultDateFeild({
                    vtype:'daterange',
                    id:'project_count_value_end_date',
                    width:200,
                    hidden :true,
                    startDateField: 'project_count_value_start_date'
                }),
                {
                    xtype:'button',
                    text:'统计',
                    iconCls:'zoom',
                    handler:function(){
                        var value=Ext.getCmp('text_project_count_value').getValue();
                        var key=Ext.getCmp('text_project_count_key').getValue();
                        
                        var start_time=Ext.getCmp('project_count_value_start_date').value;
                        var end_time=Ext.getCmp('project_count_value_end_date').value;


                        Ext.Ajax.request({
                            url:'/project/count/',
                            params:{
                                key:key,
                                value:value,
                                start_time:start_time,
                                end_time:end_time
                            },
                            success:function (response) {
                                var json= Ext.util.JSON.decode(response.responseText);
                                var chart=Ext.getCmp('project_count');
                                var data=[{
                                    season: '正常项目数量',
                                    total: json.normal
                                },{
                                    season: '延期项目数量',
                                    total: json.lazy
                                },{
                                    season: '撤项项目数量',
                                    total: json.undo
                                },{
                                    season: '退回项目数量',
                                    total: json.postback
                                }];
                                // chart.store.data.items[0].json.total=json.normal;
                                // chart.store.data.items[1].json.total=json.lazy;
                                // chart.store.data.items[2].json.total=json.undo;
                                // chart.store.data.items[3].json.total=json.postback;
                                // chart.refresh()
                                chart.store.loadData(data);

                            },
                            failure:function (form, action) {
                                if ('result' in action){
                                    if ('msg' in action.result){
                                        error(action.result.msg);
                                    }
                                }else{
                                    error('发生异常!');
                                }
                            }
                        });
                    }
                }
            ]
        }
    });
    root.appendChild(node);


    node = {
        text:'用户管理',
        expanded:true,
        leaf:false,
        children:[]
    };
    node.children.push({
        leaf:true,
        text:'用户列表',
        list:{
            url:'/user/list/',
            columes:[
                {header:'用户名', dataIndex:'name', flex:1},
                {header:'姓名', dataIndex:'real_name', flex:1},
                {header:'部门', dataIndex:'unit__name', flex:1},
                {dataIndex:'unit__level'},
                {header:'上级部门', dataIndex:'unit__parent_unit__name', flex:1},
                {header:'角色', dataIndex:'role__name', flex:1, renderer:function (value, p, record) {
                    return  XG.Render.UnitLevel(record.get('unit__level')) + value;
                }}],
            tbar:{}
        }
    });
    
    node.children[0].list.tbar.add_row = {
        form:{
            url:"/user/add/",
            title:"添加用户",
            width:400,
            height:380,
            items:[
                XG.UserFields.regname,
                XG.UserFields.password,
                XG.UserFields.real_name,
                {
                    fieldLabel:'所在单位',
                    name:'unit_id',
                    id:'add_user_unit_combo',
                    url:'/unit/combo/',
                    xtype:'remotecombo',
                    listeners:{
                        select:function(box, record, index){
                            if(Main.AuthLevel==0)return;
                            var unit=record.json;
                            var role_combo=Ext.getCmp('add_user_role_combo');
                            var role=role_combo.getRawValue();
                            if(unit.pk==Main.UserUnitID&&role=='系统管理员'){
                                alert('无法添加本单位管理员');
                                var data=role_combo.getStore().data.items;
                                for(var i=0;i<data.length;i++){
                                    var json=data[i].json;
                                    if(json.name=='系统管理员')continue;
                                    role_combo.setValue(json.pk);
                                    break;
                                }
                            }
                        }
                    }
                },
                {
                    fieldLabel:'用户角色',
                    name:'role_id',
                    url:'/role/combo/',
                    xtype:'remotecombo',
                    id:'add_user_role_combo',
                    listeners:{
                        select:function(box, record, index){
                            if(Main.AuthLevel==0)return;
                            var role=record.json;
                            var unit_combo=Ext.getCmp('add_user_unit_combo');
                            var unit_id=unit_combo.getValue();
                            var role_combo=Ext.getCmp('add_user_role_combo');
                            if(role.name=='系统管理员'&&unit_id==Main.UserUnitID){
                                alert('无法添加本单位管理员');
                                var data=role_combo.getStore().data.items;
                                for(var i=0;i<data.length;i++){
                                    var json=data[i].json;
                                    if(json.name=='系统管理员')continue;
                                    role_combo.setValue(json.pk);
                                    break;
                                }
                            }
                        }
                    }
                },
                XG.UserFields.study_type_name,
                XG.UserFields.sex,
                XG.UserFields.phone,
                XG.UserFields.mobile,
                XG.UserFields.remark]
        }
    };

    node.children[0].list.tbar.update_row ={
        form:{
            url:"/user/update/",
            title:"修改用户",
            width:400,
            height:380,
            items:[
                XG.UserFields.pk,
                XG.UserFields.name,
                XG.UserFields.password,
                XG.UserFields.email,
                XG.UserFields.real_name,
                XG.UserFields.study_type_name,
                {
                    fieldLabel:'所在单位',
                    name:'unit_id',
                    id:'edit_user_unit_combo',
                    url:'/unit/combo/',
                    xtype:'remotecombo',
                    listeners:{
                        select:function(box, record, index){
                            if(Main.AuthLevel==0)return;
                            var unit=record.json;
                            var role_combo=Ext.getCmp('edit_user_role_combo');
                            var role=role_combo.getRawValue();
                            if(unit.pk==Main.UserUnitID&&role=='系统管理员'){
                                alert('无法添加本单位管理员');
                                var data=role_combo.getStore().data.items;
                                for(var i=0;i<data.length;i++){
                                    var json=data[i].json;
                                    if(json.name=='系统管理员')continue;
                                    role_combo.setValue(json.pk);
                                    break;
                                }
                            }
                        }
                    }
                },
                {
                    fieldLabel:'用户角色',
                    name:'role_id',
                    url:'/role/combo/',
                    xtype:'remotecombo',
                    id:'edit_user_role_combo',
                    listeners:{
                        select:function(box, record, index){
                            if(Main.AuthLevel==0)return;
                            var role=record.json;
                            var unit_combo=Ext.getCmp('edit_user_unit_combo');
                            var unit_id=unit_combo.getValue();
                            var role_combo=Ext.getCmp('edit_user_role_combo');
                            if(role.name=='系统管理员'&&unit_id==Main.UserUnitID){
                                alert('无法添加本单位管理员');
                                var data=role_combo.getStore().data.items;
                                for(var i=0;i<data.length;i++){
                                    var json=data[i].json;
                                    if(json.name=='系统管理员')continue;
                                    role_combo.setValue(json.pk);
                                    break;
                                }
                            }
                        }
                    }
                },
                XG.UserFields.sex,
                XG.UserFields.phone,
                XG.UserFields.mobile,
                XG.UserFields.remark
            ]},
        url:'/user/details/'
    };

    node.children[0].list.tbar.del_row ={
        url:'/user/del/',
        iconCls:'Databasedelete'
    };


    node.children.push({
        leaf:true,
        text:'项目申请人审核',
        list:{
            url:'/user/list/approve/',
            columes:[
                {header:'用户名', dataIndex:'name', flex:1},
                {header:'姓名', dataIndex:'name', flex:1},
                {header:'部门', dataIndex:'unit__name', flex:2},
                {header:'单位级别', dataIndex:'unit__level', flex:1, renderer:XG.Render.UnitLevel},
                {header:'上级部门', dataIndex:'unit__parent_unit__name', flex:2 },
                {header:'注册时间', dataIndex:'regtime', flex:1 }
            ],
            tbar:{}
        }
    });

    node.children[1].list.tbar.approve_row = {
        title:"审核项目申请人",
        url:'/user/approve/',
        iconCls:'Useralert'
    };

    root.appendChild(node);


    if (0 == Main.AuthLevel) {
        root.appendChild({
            text:'项目类型管理',
            expanded:true,
            leaf:false,
            children:[{
                leaf:true,
                text:'项目种类',
                list:{
                    url:"/projecttype/list/",
                    columes:[
                        {header:'项目类型名称', dataIndex:'name',expend:true},
                        {header:'项目预警天数(距项目期限小于等于天数,系统自动提示申请人)', dataIndex:'waring_day', width:120},
                        {header:'是否允许申报',dataIndex:'allow_apply',width:120,renderer:function(value){return value?'允许':'不允许'}},
                        {header:'最大项目数量', dataIndex:'max_project_num'}
                    ],
                    tbar:{
                        add_row:{
                            form:{
                                url:"/unit/add/",
                                title:"添加项目类型",
                                width:400,
                                height:380,
                                items:[
                                    XG.ProjectTypeFields.name,
                                    XG.ProjectTypeFields.waring_day,
                                    XG.ProjectTypeFields.allow_apply,
                                    XG.ProjectTypeFields.max_project_num
                                ]
                            }
                        },
                        update_row:{
                            form:{
                                url:"/projecttype/update/",
                                title:"修改项目类型",
                                width:400,
                                height:280,
                                items:[
                                    XG.ProjectTypeFields.pk,
                                    XG.ProjectTypeFields.name,
                                    XG.ProjectTypeFields.waring_day,
                                    XG.ProjectTypeFields.allow_apply,
                                    XG.ProjectTypeFields.max_project_num
                                ]
                            },
                            url:'/projecttype/details/'
                        }
                    }
                }
            }]
        });
   
    }
    if(2!=Main.AuthLevel)
    {
        node = {
            text:'单位管理',
            expanded:true,
            leaf:false,
            children:[]
        };
        node.children.push({
            leaf:true,
            text:'单位列表',
            list:{
                url:'/unit/list/',
                columes:[
                    {header:'单位名', dataIndex:'name', flex:1 },
                    {header:'所属单位', dataIndex:'parent_unit__name', flex:1},
                    {header:'单位地址', dataIndex:'address', flex:1},
                    {header:'项目最大数量', dataIndex:'max_project', flex:1  },
                    {header:'申报开始时间', dataIndex:'apply_starttime', flex:1  },
                    {header:'申报结束时间', dataIndex:'apply_endtime', flex:1  },
                    {header:'单位编号', dataIndex:'no', flex:1  },
                    {header:'单位级别', dataIndex:'level', flex:1, renderer:XG.Render.UnitLevel}
                ],
                tbar:{}
            }
        });
        node.children[0].list.tbar.add_row = {
            form:{
                url:"/unit/add/",
                title:"添加单位",
                width:500,
                height:450,
                items:[
                    XG.UnitFields.name,
                    XG.UnitFields.parent_unit_id,
                    XG.UnitFields.address,
                    XG.UnitFields.no,
                    XG.UnitFields.project_type_id,
                    XG.UnitFields.max_project,
                    XG.UnitFields.phone]}
        };

        node.children[0].list.tbar.update_row = {
            form:{
                url:"/unit/update/",
                title:"修改单位",
                width:400,
                height:380,
                items:[
                    XG.UnitFields.pk,
                    XG.UnitFields.name,
                    XG.UnitFields.parent_unit_id,
                    XG.UnitFields.address,
                    XG.UnitFields.project_type_id,
                    XG.UnitFields.max_project,
                    XG.UnitFields.no,
                    XG.UnitFields.apply_starttime,
                    XG.UnitFields.apply_endtime,
                    XG.UnitFields.phone
                ]},
            url:'/unit/details/'

        };
        node.children[0].list.tbar.del_row ={
            url:'/unit/del/',
            iconCls:'Databasedelete'
        };


        node.children.push({
            leaf:true,
            text:'单位审核',
            list:{
                url:'/unit/list/approve/',
                columes:[
                    {header:'单位名', dataIndex:'name', flex:1},
                    {header:'所属单位', dataIndex:'parent_unit__name', flex:1 },
                    {header:'单位地址', dataIndex:'address', flex:1 },
                    {header:'项目类型名称', dataIndex:'project_type__name', flex:1},
                    {header:'单位级别', dataIndex:'level', flex:1, renderer:XG.Render.UnitLevel },
                    {header:'注册时间', dataIndex:'regtime', flex:1 }
                ],
                tbar:{}
            }
        });
        node.children[1].list.tbar.approve_row = {
            title:'单位审核',
            url:'/unit/approve/',
            iconCls:'Housekey'
        };
        root.appendChild(node);
    }
    




    node={
        text:'消息通知',
        expanded:true,
        leaf:false,
        children:[]
    };

    if(0==Main.AuthLevel)
    {
        node.children.push({
            text:'消息发送',
            leaf:true,
            defaults:{
                allowBlank:false,
                width:230
            },
            view:{
                xtype:'form',
                id:'message_form',
                labelWidth: 55,
                url:'/message/add/',
                defaultType: 'textfield',
                defaults:{
                    allowBlank:false
                },
                items: [
                {fieldLabel:'接受部门',name:'receiver_unit_id',width:250, url:'/message/message_recvier_combo/',xtype:'remotecombo'},
                {fieldLabel: '标题',name: 'title',anchor:'85%'},
                {fieldLabel: '摘要',name: 'abstract',anchor: '85%'},
                {fieldLabel: '内容',xtype: 'textarea',name: 'content',anchor: '85% -200'}
                ],
                buttons: [{
                    text: '发送',
                    handler:function(){
                        var form=Ext.getCmp('message_form').getForm();
                        form.submit({
                            clientValidation:true,
                            url:'/message/add/',
                            success:function (form, action) {
                                if (action.result.msg != 'OK') {
                                    alert(action.result.msg);
                                }
                                form.reset();
                            },
                            failure:function (form, action) {
                                if (action
                                    && action.hasOwnProperty('result')
                                    && action.result.hasOwnProperty('msg')
                                    && action.result.msg) {
                                    error(action.result.msg);
                                }
                                else {
                                    error('发生异常！');
                                }
                                form.reset();
                            }
                        });
                    }
                },{
                    text: '取消',
                    handler:function(){
                        Ext.get('message_form').getForm().reset();
                    }
                }]
            }
        });
    }
    

    Main.PubMessage=function(pk,data){

        var win=new Ext.Window({
            title:'消息发布',
            closable:true,
            closeAction:'close',
            modal:true,
            width:465,
            height:280,
            layout:'form',
            items:[
                {
                    fieldLabel : "接收对象",
                    url:'/message/message_recvier_combo/',
                    xtype:'remotecombo',
                    id:'message_recv',
                    name:'recv',
                    width:300
                },
                {
                    xtype:'textarea', 
                    fieldLabel : "消息内容",
                    width:300,
                    value:data,
                    editable:false
                }
            ],
            buttons:[
                {
                    text:'发送',handler:function(){
                        var recv=Ext.getCmp('message_recv').getValue();
                        Ext.Ajax.request({
                            url:'/message/pub/',
                            params:{
                                pk:pk,
                                recv:recv
                            },
                            success:function(response){
                                alert('该条消息已经发布！');
                                var grid=Ext.getCmp('wait_pub_message_list');
                                grid.getStore().reload(); 
                                win.close();         
                            }
                       });
                    }
                }
            ]
        });
        win.show(this);
           
    }

    if(0!=Main.AuthLevel)
    {
        node.children.push({
            text:'我收到的消息',
            leaf:true,
           
            list:{
                nocheck:true,
                id:'wait_pub_message_list',
                url:"/message/waitpublist/",
                columes:[
                    {header:'消息标题', dataIndex:'title', flex:1},
                    {header:'消息摘要', dataIndex:'abstract', flex:1 },
                    {header:'发送时间', dataIndex:'send_time', flex:1 },
                    {header:'发送人', dataIndex:'sender_name', flex:1 },
                    {header:'发送人姓名', dataIndex:'sender_real_name', flex:1 },
                    {header:'发送部门', dataIndex:'sender_unit__name', flex:1 },
                    {dataIndex:"content"},
                    {
                        header:'操作', 
                        dataIndex:'pk', 
                        flex:1,
                        renderer:function(value,p,record){
                            return "<a href='#' onclick=\"Main.PubMessage("+value+",'"+record.json.content+"')\">查看</a>"
                        }.createDelegate(this)
                    }
                ],
                viewConfig: {
                forceFit:true,
                enableRowBody:true,
                showPreview:true,
                getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>消息内容: '+record.data.content+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                }
            }
        });
    }
    

    node.children.push({
        text:'已发送的消息',
        leaf:true,
        list:{
            nocheck:true,
            url:"/message/sended/list/",
            columes:[
                {header:'消息标题', dataIndex:'title', flex:1},
                {header:'消息摘要', dataIndex:'abstract', flex:1 },
                {header:'发送时间', dataIndex:'send_time', flex:1 },
                {header:'发送人', dataIndex:'sender_name', flex:1 },
                {header:'发送人姓名', dataIndex:'sender_real_name', flex:1 },
                {header:'发送部门', dataIndex:'sender_unit__name', flex:1 },
                {dataIndex:"content"}
            ],
            viewConfig: {
                forceFit:true,
                enableRowBody:true,
                showPreview:true,
                getRowClass : function(record, rowIndex, p, store){
                    if(this.showPreview){
                        p.body = '<p>消息内容: '+record.data.content+'</p>';
                        return 'x-grid3-row-expanded';
                    }
                    return 'x-grid3-row-collapsed';
                }
            }
        }
    });
    root.appendChild(node);
});
</script>
{%endifequal%}
{%ifequal user.role.code 'expert'%}
<script type="text/javascript">
    Ext.onReady(function () {
        var root = Main.tree.getRootNode();
        var node = {
            text:'项目评审',
            expanded:true,
            leaf:false,
            children:[
                {
                    text:'待评审的项目',
                    leaf:true,
                    list:{
                        url:"/project/apply/list/",
                        baseParams:{
                            'waitoption':true
                        },
                        columes:[
                            {
                                header:'项目名称',
                                dataIndex:'project_name',
                                flex:1,
                                renderer:function (value) {
                                    return '<img src="/static/icons/zoom.png"/>' + value;
                                }.createDelegate(this)
                            },
                            {header:'项目类型', dataIndex:'project_type__name', flex:1},
                            {header:'项目编号', dataIndex:'project_no', flex:1 },
                            {header:'申请时间', dataIndex:'applicant_time', flex:1},
                            {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                            {header:'学科分类', dataIndex:'study_type_name', flex:1},
                            {header:'PDF', flex:1, dataIndex:'pk', width:50,
                                renderer:function (value) {
                                    return '<img src="/static/icons/page_white_acrobat.png"/>';
                                }.createDelegate(this)
                            }
                        ],
                        listeners:{
                            cellclick:DefaultCellHanlder({
                                applyPdfIdx:7,
                                applyIdx:1
                            })
                        },
                        tbar:{
                            approve_row:{
                                title:"评审", 
                                url:'/project/apply/approve/', 
                                iconCls:'Useralert',
                                width:350,
                                height:200,
                                items:[
                                {
                                    fieldLabel:'评分(0-100)',
                                    xtype:'textfield',
                                    name:'expert_percent',
                                    vtype:'percent'
                                }]
                            }
                        }
                    }
                },{
                    text:'已评审的项目',
                    leaf:true,
                    list:{
                        url:"/project/apply/list/",
                        columes:[
                            {
                                header:'项目名称',
                                dataIndex:'project_name',
                                flex:1,
                                renderer:function (value) {
                                    return '<img src="/static/icons/zoom.png"/>' + value;
                                }.createDelegate(this)
                            },
                            {header:'项目类型', dataIndex:'project_type__name', flex:1},
                            {header:'项目编号', dataIndex:'project_no', flex:1 },
                            {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                            {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                            {header:'学科分类', dataIndex:'study_type_name', flex:1},
                            {header:'PDF', flex:1, dataIndex:'pk', width:50,
                                renderer:function (value) {
                                    return '<img src="/static/icons/page_white_acrobat.png"/>';
                                }.createDelegate(this)
                            }
                        ],
                        listeners:{
                            cellclick:DefaultCellHanlder({
                                applyPdfIdx:7,
                                applyIdx:1
                            })
                        },
                        tbar:{
                            approve_row:{ title:"审核立项申请", url:'/project/apply/approve/', iconCls:'Useralert'}
                        }
                    }
                }
            ]
        };


        root.appendChild(node);
        node = {
            text:'消息管理',
            expanded:true,
            leaf:false,
            children:[]
        };
        

        node.children.push({
            text:'系统消息',
            leaf:true,

            list:{
                id:'wait_pub_message_list',
                url:"/message/list/",
                nocheck:true,
                columes:[
                    {header:'消息标题', dataIndex:'title', flex:1},
                    {header:'消息摘要', dataIndex:'abstract', flex:1 },
                    {header:'发送时间', dataIndex:'send_time', flex:1 },
                    {header:'发送人', dataIndex:'sender_name', flex:1 },
                    {header:'发送人姓名', dataIndex:'sender_real_name', flex:1 },
                    {header:'接收部门', dataIndex:'sender_unit__name', flex:1 },
                    {dataIndex:'content'}
                ],
                viewConfig: {
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>消息内容: '+record.data.content+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                }
            }
        });
        root.appendChild(node);
    });
</script>
{%endifequal%}
{%ifequal user.role.code 'applicant'%}
<script type="text/javascript">
    Ext.onReady(function () {
        var root = Main.tree.getRootNode();
        Main.ShowProjectApply=function(data){
            Main.ClearTab();
            var exisTab = Main.tab_panel.findById('项目立项申请');
            if(!exisTab) {
                exisTab = Main.tab_panel.add({
                    closable: true,
                    id: '项目立项申请',
                    title: '项目立项申请',
                    layout: {
                        type: 'fit'
                    },
                    items: [{
                        xtype:'form',
                        id:'prject_apply_add',
                        labelWidth: 55,
                        autoScroll: true,
                        defaultType: 'textfield',
                        items: [
                            {
                                xtype:'fieldset',
                                title: '申请者的承诺',
                                collapsible: true,
                                collapsed:true,
                                autoHeight:true,
                                items :[
                                    {
                                        xtype:'panel',
                                        html:'<p ><h1 align="center">国家民委教育科技司制表</h1></p><p align="center"><strong>&nbsp;</strong></p><p><h2>申请者的承诺：</h2></p><br/><p><strong>&nbsp;&nbsp; </strong>我保证如实填写本表各项内容。如果获准立项，我承诺以本表为有约束力的协议，认真开展研究工作，取得预期研究成果。国家民委教育科技司有权使用本表所有数据和资料。对于国家民委资助研究的项目，其研究成果国家民委有权使用。</p><br/><br/>'
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '填表说明',
                                collapsible: true,
                                collapsed:true,
                                autoHeight:true,
                                items :[
                                    {
                                        xtype:'panel',
                                        html:'<p align="center"><h1 align="center">填  表  说  明 </h1></p><br/><ol><li>本表统一用计算机认真如实填写后并打印。 </li><li>学科分类以所属的一级学科为准，如果跨学科申报，请在&ldquo;学科分类&rdquo;一栏填入&ldquo;跨学科&rdquo;字样，并在其后用括号注明所属的<strong>2</strong>至<strong>3</strong>个一级学科，如&ldquo;跨学科（哲学、经济学）&rdquo;等。 </li><li>数据表中推荐人签名一栏中，是项目负责人为中级职称且未获得博士学位者填写，中级以上职称或获得博士学位的不需填写。 </li><li>本表报送一式<strong>3</strong>份，其中<strong>1</strong>份原件，<strong>2</strong>份复印件。复印请用<strong>A4</strong>复印纸，于左侧装订成册。 </li><br/><br/>'
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '数据表',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                defaults:{
                                    allowBlank:false
                                },
                                items :[
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                               columnWidth :.5, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                    xtype:'combo',
                                                    mode:'local',
                                                    editable:false,
                                                    valueField:'name',
                                                    displayField:   'name',
                                                    fieldLabel : "项目领域",
                                                    triggerAction:  'all',
                                                    forceSelection: true,
                                                    name: 'project_area_name_s',
                                                    hiddenName:'project_area_name',
                                                    anchor:'78%',
                                                    value:'数学',
                                                    store:new Ext.data.JsonStore({
                                                        fields : ['name'],
                                                        data:[
                                                            {name:'人文社会科学'},
                                                            {name:'自然科学'},
                                                            {name:'文理交叉'},
                                                            {name:'其他'}
                                                        ]
                                                    })
                                               }]
                                            },
                                            {
                                                columnWidth :.5, 
                                                layout : "form", 
                                                border:false,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "项目名称",
                                                  allowBlank:false,
                                                  name:'project_name',
                                                  anchor:'90%'
                                               
                                                }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                               columnWidth :.33, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [
                                                    {
                                                        fieldLabel : "项目类型",
                                                        url:'/projecttype/combo/',
                                                        xtype:'remotecombo',
                                                        name:'project_type_id',
                                                        baseFields:[
                                                            {name:'name', mapping:'project_type__name', type:'string'},
                                                            {name:'pk', mapping:'project_type__pk', type:'int'}
                                                        ]
                                                    }
                                               ]
                                            },{
                                               columnWidth :.33, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [
                                               {
                                                    xtype : "textfield",
                                                    fieldLabel : "学科分类",
                                                    name:'study_type_name',
                                                    emptyText:'请查看国家标准二级学科代码',
                                                    allowBlank:false,
                                                    anchor:'85%'
                                               }
                   
                                               ]
                                            },{
                                               columnWidth :.33, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                                border:false,
                                               items : [{
                                                    xtype:'combo',
                                                    mode:'local',
                                                    editable:false,
                                                    valueField:'name',
                                                    displayField:   'name',
                                                    fieldLabel : "研究类型",
                                                    triggerAction:  'all',
                                                    forceSelection: true,
                                                    name: 'reserch_type_name_s',
                                                    hiddenName:'reserch_type_name',
                                                    anchor:'78%',
                                                    value:'基础研究',
                                                    store:new Ext.data.JsonStore({
                                                        fields : ['name'],
                                                        data:[
                                                            {name:'基础研究'},
                                                            {name:'应用研究'},
                                                            {name:'应用基础研究'},
                                                            {name:'综合研究'},
                                                            {name:'其它研究'}
                                                        ]
                                                    })
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                 
                                        items:[
                                            {
                                               columnWidth :.25, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "硕士生导师",
                                                  name:'teacher_name_ss',
                                                  allowBlank:false,
                                                  anchor:'85%'
                                               }]
                                            },
                                            {
                                               columnWidth :.25, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "博士生导师",
                                                  name:'teacher_name_bs',
                                                  allowBlank:false,
                                                  anchor:'85%'
                                               }]
                                            },
                                            {
                                                columnWidth :.25, 
                                                layout : "form", 
                                                border:false,
                                                items : [
                                                {
                                                    xtype : "textfield",
                                                    fieldLabel : "工作单位",
                                                    allowBlank:false,
                                                    anchor:'90%',
                                                    value:Main.UnitName,
                                                    name:'teacher_unit',
                                                    readOnly:true
                                               }]
                                            },
                                            {
                                                columnWidth :.25,
                                                layout : "form", 
                                                border:false,
                                                items : [{
                                                    xtype : "textfield",
                                                    fieldLabel : "联系电话",
                                                    allowBlank:false,
                                                    anchor:'90%',
                                                    name:'teacher_phone'
                                                }]
                                            }
                                        ]
                                    },
                                    {
                                        xtype:'textarea',
                                        fieldLabel : "近几年与本课题相关的研究成果(限200字)",
                                        anchor:'90%',
                                        name:'teacher_remark',
                                        allowBlank:false,
                                        height:150,
                                        maxLength:200
                                    },
                                    {   
                                        xtype:'fieldset',
                                        title: '课题主要参加者相关情况(限填5项)',
                                        
                                        collapsible: true,
                                        anchor:'100%',
                                        layout:"form",
                                        id:'project_apply_user_add',
                                        items:[
                                            {
                                                xtype:'fieldset',
                                                title: '参加者信息 1',
                                                anchor:'100%',
                                                items:[
                                                    {
                                                      xtype : "textfield",
                                                      fieldLabel:'姓名',
                                                      allowBlank:false,
                                                      name:'g__actor__name__1',
                                                      anchor:'78%'
                                                    },
                                                    {
                                                        xtype:'combo',
                                                        mode:'local',
                                                        editable:false,
                                                        valueField:'name',
                                                        displayField:   'name',
                                                        fieldLabel : "职称",
                                                        triggerAction:  'all',
                                                        forceSelection: true,
                                                        name: 'g__actor__job_zc__s',
                                                        hiddenName:'g__actor__job_zc__1',
                                                        anchor:'50%',
                                                        value:'讲师',
                                                        store:new Ext.data.JsonStore({
                                                            fields : ['name'],
                                                            data:[
                                                                {name:'讲师'},
                                                                {name:'副研究员'},
                                                                {name:'研究员'},
                                                                {name:'副教授'},
                                                                {name:'教授'}
                                                            ]
                                                        })
                                                    },
                                                    {
                                                        xtype:'combo',
                                                        mode:'local',
                                                        editable:false,
                                                        valueField:'name',
                                                        displayField:   'name',
                                                        fieldLabel : "职务",
                                                        triggerAction:  'all',
                                                        forceSelection: true,
                                                        name: 'g__actor__job_zw__s',
                                                        hiddenName:'g__actor__job_zw__1',
                                                        anchor:'50%',
                                                        value:'讲师',
                                                        store:new Ext.data.JsonStore({
                                                            fields : ['name'],
                                                            data:[
                                                                {name:'司长'},
                                                                {name:'副司长'},
                                                                {name:'局长'},
                                                                {name:'副局长'},
                                                                {name:'厅长'},
                                                                {name:'副厅长'}
                                                            ]
                                                        })
                                                    },
                                                    {
                                                        xtype:'combo',
                                                        mode:'local',
                                                        editable:false,
                                                        valueField:'name',
                                                        displayField:   'name',
                                                        fieldLabel : "学位",
                                                        triggerAction:  'all',
                                                        forceSelection: true,
                                                        name: 'g__actor__degree__s',
                                                        hiddenName:'g__actor__degree__1',
                                                        anchor:'50%',
                                                        value:'学士',
                                                        store:new Ext.data.JsonStore({
                                                            fields : ['name'],
                                                            data:[
                                                                {name:'学士'},
                                                                {name:'硕士'},
                                                                {name:'博士'},
                                                                {name:'博士后'}
                                                            ]
                                                        })
                                                    },
                                                    {
                                                      xtype : "textarea",
                                                      anchor:'78%',
                                                      name:'g__actor__desc__1',
                                                      allowBlank:false,
                                                      fieldLabel:'近几年与本课题相关的研究成果'
                                                    }
                                                ]
                                            }
                                        ],
                                        buttons: [{
                                            text: '继续添加',
                                            handler:function(){
                                                var f=Ext.getCmp('project_apply_user_add');
                                                var index=f.items.length+1;
                                                if(index>5){
                                                    alert('限填5项,无法继续添加信息了！');
                                                    return;
                                                }
                                                f.add({
                                                    xtype:'fieldset',
                                                    title: '参加者信息 '+index,
                                                    anchor:'80%',
                                                    items:[
                                                        {
                                                          xtype : "textfield",
                                                          fieldLabel:'姓名',
                                                          allowBlank:false,
                                                          name:'g__actor__name__'+index,
                                                          anchor:'90%'
                                                        },
                                                        {
                                                            xtype:'combo',
                                                            mode:'local',
                                                            editable:false,
                                                            valueField:'name',
                                                            displayField:   'name',
                                                            fieldLabel : "职称",
                                                            triggerAction:  'all',
                                                            forceSelection: true,
                                                            name: 'g__actor__job_zc__s'+index,
                                                            hiddenName:'g__actor__job_zc__'+index,
                                                            anchor:'50%',
                                                            value:'讲师',
                                                            store:new Ext.data.JsonStore({
                                                                fields : ['name'],
                                                                data:[
                                                                    {name:'讲师'},
                                                                    {name:'副研究员'},
                                                                    {name:'研究员'},
                                                                    {name:'副教授'},
                                                                    {name:'教授'}
                                                                ]
                                                            })
                                                        },

                                                        {
                                                            xtype:'combo',
                                                            mode:'local',
                                                            editable:false,
                                                            valueField:'name',
                                                            displayField:   'name',
                                                            fieldLabel : "职务",
                                                            triggerAction:  'all',
                                                            forceSelection: true,
                                                            name: 'g__actor__job_zw__s'+index,
                                                            hiddenName:'g__actor__job_zw__'+index,
                                                            anchor:'50%',
                                                            value:'讲师',
                                                            store:new Ext.data.JsonStore({
                                                                fields : ['name'],
                                                                data:[
                                                                    {name:'司长'},
                                                                    {name:'副司长'},
                                                                    {name:'局长'},
                                                                    {name:'副局长'},
                                                                    {name:'厅长'},
                                                                    {name:'副厅长'}
                                                                ]
                                                            })
                                                        },
                                                        {
                                                            xtype:'combo',
                                                            mode:'local',
                                                            editable:false,
                                                            valueField:'name',
                                                            displayField:   'name',
                                                            fieldLabel : "学位",
                                                            triggerAction:  'all',
                                                            forceSelection: true,
                                                            name: 'g__actor__degree__s'+index,
                                                            hiddenName:'g__actor__degree__'+index,
                                                            anchor:'50%',
                                                            value:'学士',
                                                            store:new Ext.data.JsonStore({
                                                                fields : ['name'],
                                                                data:[
                                                                    {name:'学士'},
                                                                    {name:'硕士'},
                                                                    {name:'博士'},
                                                                    {name:'博士后'}
                                                                ]
                                                            })
                                                        },
                                                        {
                                                          xtype : "textarea",
                                                          anchor:'90%',
                                                          name:'g__actor__desc__'+index,
                                                          allowBlank:false,
                                                          fieldLabel:'近几年与本课题相关的研究成果'
                                                        }
                                                    ]
                                                });
                                                f.doLayout(); 
                                            }

                                        },{
                                            text: '移除',
                                            handler:function(){
                                                var f=Ext.getCmp('project_apply_user_add');
                                                var index=f.items.length;
                                                if(index<=1)return;
                                                var cmp=f.items.items[index-1];
                                                f.remove(cmp,true);

                                            }
                                        }]
                                    },
                                    {
                                        xtype:'textarea',
                                        fieldLabel:'预期成果概述',
                                        anchor:'90%',
                                        name:'comple_desc',
                                        allowBlank:false,
                                        maxLength:500
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                               columnWidth :.5, 
                                               layout : "form",
                                               border:false,
                                               labelWidth:100,
                                               items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "申请资助经费(单位:万元）",
                                                  name:'total_money',
                                                  vtype:'positive',
                                                  allowBlank:false,
                                                  anchor:'78%'
                                               }]
                                            },{
                                               columnWidth :.5,
                                               layout : "form",
                                                border:false,
                                                labelWidth:100,
                                               items : [DefaultDateFeild({
                                                
                                                  vtype:'future_date',
                                                  name:'comple_time',
                                                  fieldLabel : "预计完成时间",
                                                  anchor:'78%'
                                               })]
                                            }
                                        ]
                                    }

                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '应用推广或市场分析(限250字)',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                items :[
                                    {
                                        xtype:'textarea',
                                        anchor:'100%',
                                        fieldLabel:'内容',
                                        allowBlank:false,
                                        height:250,
                                        maxLength:500,
                                        name:'marketing_desc'
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '预期研究成果(限制填10项)',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                id:'project_apply_pre_process_add',
                                items:[
                                        {
                                            xtype:'fieldset',
                                            title: '阶段性成果 1',
                                            anchor:'80%',
                                            items:[
                                                {
                                                    xtype: 'compositefield',
                                                    fieldLabel: '研究阶段(起止时间)',
                                                    msgTarget : 'side',
                                                    anchor    : '-20',
                                                    defaults: {
                                                        flex: 1
                                                    },
                                                    items: [
                                                        DefaultDateFeild({
                                                            name : 'g__levelachive__start_time__1',
                                                            id:'g__levelachive__start_time__1',
                                                            endDateField: 'g__levelachive__end_time__1',
                                                            vtype:'daterange'
                                                        }),
                                                        DefaultDateFeild({
                                                            vtype:'daterange',
                                                            id:'g__levelachive__end_time__1',
                                                            startDateField: 'g__levelachive__start_time__1',
                                                            name : 'g__levelachive__end_time__1'
                                                        })
                                                        
                                                    ]
                                                },
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'阶 段 成 果 名 称',
                                                  allowBlank:false,
                                                  name:'g__levelachive__name__1',
                                                  anchor:'90%'
                                                },
                                                {
                                                  xtype : "textarea",
                                                  anchor:'90%',
                                                  allowBlank:false,
                                                  maxLength:200,
                                                  name:'g__levelachive__atype__1',
                                                  fieldLabel:'成果形式(限200字)'
                                                },
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'承 担 人',
                                                  name:'g__levelachive__apply_user__1',
                                                  allowBlank:false,
                                                  anchor:'90%'
                                                }
                                            ]
                                        }
                                    ],
                                buttons: [{
                                    text: '继续添加',
                                    handler:function(){
                                        var f=Ext.getCmp('project_apply_pre_process_add');
                                        var index=f.items.length+1;
                                        if(index>10){
                                            alert('限填10项,无法继续添加信息了！');
                                            return;
                                        }
                                        f.add({
                                            xtype:'fieldset',
                                            title: '阶段性成果 '+index,
                                            anchor:'80%',
                                            items:[
                                                {
                                                    xtype: 'compositefield',
                                                    fieldLabel: '研究阶段(起止时间)',
                                                    msgTarget : 'side',
                                                    anchor    : '-20',
                                                    defaults: {
                                                        flex: 1
                                                    },
                                                    items: [
                                                        DefaultDateFeild({
                                                            name : 'g__levelachive__start_time__'+index,
                                                            id:'g__levelachive__start_time__'+index,
                                                            endDateField: 'g__levelachive__end_time__'+index,
                                                            vtype:'daterange'
                                                        }),
                                                        DefaultDateFeild({
                                                            vtype:'daterange',
                                                            id:'g__levelachive__end_time__'+index,
                                                            startDateField: 'g__levelachive__start_time__'+index,
                                                            name : 'g__levelachive__end_time__'+index
                                                        })
                                                        
                                                    ]
                                                },
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'阶 段 成 果 名 称',
                                                  allowBlank:false,
                                                  name:'g__levelachive__name__'+index,
                                                  anchor:'90%'
                                                },
                                                {
                                                  xtype : "textarea",
                                                  anchor:'90%',
                                                  allowBlank:false,
                                                  name:'g__levelachive__atype__'+index,
                                                  fieldLabel:'成果形式'
                                                },
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'承 担 人',
                                                  name:'g__levelachive__apply_user__'+index,
                                                  allowBlank:false,
                                                  anchor:'90%'
                                                }
                                            ]
                                        });
                                        f.doLayout(); 
                                    }
                                },{
                                    text: '移除',
                                    handler:function(){
                                        var f=Ext.getCmp('project_apply_pre_process_add');
                                        var index=f.items.length;
                                        if(index<=1)return;
                                        var cmp=f.items.items[index-1];
                                        f.remove(cmp,true);
                                    }
                                }]
                            },
                            {
                                xtype:'fieldset',
                                title: '最终研究成果(限制填2项)',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                id:'project_apply_final_process_add',
                                items:[
                                        {
                                            xtype:'fieldset',
                                            title: '最终成果 1',
                                            anchor:'80%',
                                            items:[
                                                DefaultDateFeild({
                                                  fieldLabel:'完成时间',
                                                  name:'g__finalachive__end_time__1',
                                                  anchor:'90%'
                                                })
                                                ,
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'最 终 成 果 名称',
                                                  name:'g__finalachive__name__1',
                                                  allowBlank:false,
                                                  anchor:'90%'
                                                },
                                                {
                                                  xtype : "textarea",
                                                  anchor:'90%',
                                                  allowBlank:false,
                                                  name:'g__finalachive__atype__1',
                                                  fieldLabel:'成果形式'
                                                },
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'预计字数',
                                                  name:'g__finalachive__font_num__1',
                                                  allowBlank:false,
                                                  vtype:'positive',
                                                  anchor:'90%'
                                                },
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'参 加 人',
                                                  name:'g__finalachive__actor__1',
                                                  allowBlank:false,
                                                  anchor:'90%'
                                                }
                                            ]
                                        }
                                    ],
                                buttons: [{
                                    text: '继续添加',
                                    handler:function(){
                                        var f=Ext.getCmp('project_apply_final_process_add');
                                        var index=f.items.length+1;
                                        if(index>2){
                                            alert('限填2项,无法继续添加信息了！');
                                            return;
                                        }
                                        f.add({
                                            xtype:'fieldset',
                                            title: '最终成果 '+index,
                                            anchor:'80%',
                                            items:[
                                                DefaultDateFeild({
                                                  fieldLabel:'完成时间',
                                                  name:'g__finalachive__end_time__'+index,
                                                  anchor:'90%'
                                                }),
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'最 终 成 果 名称',
                                                  name:'g__finalachive__name__'+index,
                                                  allowBlank:false,
                                                  anchor:'90%'
                                                },
                                                {
                                                  xtype : "textarea",
                                                  anchor:'90%',
                                                  allowBlank:false,
                                                  name:'g__finalachive__atype__'+index,
                                                  fieldLabel:'成果形式'
                                                },
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'预计字数',
                                                  name:'g__finalachive__font_num__'+index,
                                                  vtype:'positive',
                                                  allowBlank:false,
                                                  anchor:'90%'
                                                },
                                                {
                                                  xtype : "textfield",
                                                  fieldLabel:'参 加 人',
                                                  name:'g__finalachive__actor__'+index,
                                                  allowBlank:false,
                                                  anchor:'90%'
                                                }
                                            ]
                                        });
                                        f.doLayout(); 
                                    }
                                },{
                                    text: '移除',
                                    handler:function(){
                                        var f=Ext.getCmp('project_apply_final_process_add');
                                        var index=f.items.length;
                                        if(index<=1)return;
                                        var cmp=f.items.items[index-1];
                                        f.remove(cmp,true);
                                    }
                                }]
                            },
                            {
                                xtype:'fieldset',
                                title: '经费预算',
                                collapsible: true,
                               
                                labelWidth:200,
                                autoHeight:true,
                                items :[

                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "资料费金额(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'book_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "资料费描述",
                                                  allowBlank:false,
                                                  name:'book_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                  
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "国内调研差旅费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'reserch_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "国内调研差旅费描述",
                                                  allowBlank:false,
                                                  name:'reserch_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "小型会议费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'meet_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "小型会议费描述",
                                                  allowBlank:false,
                                                  name:'meet_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "计算机使用费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'computer_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "计算机使用费描述",
                                                  allowBlank:false,
                                                  name:'computer_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "印刷补助费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'print_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "印刷补助费描述",
                                                  allowBlank:false,
                                                  name:'print_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "管理费(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'manage_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "管理费描述",
                                                  allowBlank:false,
                                                  name:'manage_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[
                                            {
                                                columnWidth :.3, 
                                                layout : "form", 
                                                border:false,
                                                labelWidth:140,
                                                items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "其他费用(万元)",
                                                  allowBlank:false,
                                                  vtype:'natural',
                                                  name:'other_money',
                                                  anchor:'90%'
                                               
                                                }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               labelWidth:130,
                                               items : [{
                                                  xtype : "textarea",
                                                  fieldLabel : "其他费用描述",
                                                  allowBlank:false,
                                                  name:'other_money_dec',
                                                  anchor:'85%'
                                               }]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '附件',
                                collapsible: true,
                                labelWidth:300,
                                autoHeight:true,
                                items :[{
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[{
                                            columnWidth :.6, 
                                            layout : "form", 
                                            border:false,
                                            items : [{
                                              xtype : "textfield",
                                              id:'project_apply_file_code',
                                              fieldLabel : '文档编号(上传项目申请书后自动生成)',
                                              allowBlank:false,
                                              width:250,
                                              readOnly:true,
                                              name:'file_code'
                                            }]
                                        },
                                        {
                                            columnWidth :.2, 
                                            layout : "form", 
                                            border:false,
                                            items : [
                                                {
                                                    xtype : "button",
                                                    text : "上传项目申请书",
                                                    handler:function(){
                                                        var form = new Ext.form.FormPanel({
                                                            baseCls: 'x-plain',
                                                            labelWidth: 80,
                                                            fileUpload:true,
                                                            items: [{
                                                                xtype: 'fileuploadfield',
                                                                anchor: '90%',
                                                                name: 'file',  
                                                                allowBlank:false,
                                                                listeners:{ 
                                                                    fileselected:function(input,value){
                                                                        var ext=/\.[^\.]+$/.exec(value);
                                                                        if(ext!='.doc'&&ext!='.docx'){
                                                                             alert('请选择有效的Word文件！');
                                                                             input.reset();
                                                                        }
                                                                       
                                                                    }
                                                                }
                                                            }]
                                                        });

                                                        var win = new Ext.Window({
                                                            title: '上传填写完整的Word文档',
                                                            width: 400,
                                                            height:200,
                                                            minWidth: 300,
                                                            minHeight: 100,
                                                            layout: 'fit',
                                                            plain:true,
                                                            bodyStyle:'padding:5px;',
                                                            items: form,
                                                            buttons: [
                                                                {
                                                                  xtype : "button",
                                                                  text : "上传",
                                                                  handler:function(){
                                                                    if(!form.getForm().isValid())return;
                                                                    var ext=/\.[^\.]+$/.exec(form.items.items[0].value);
                                                                    if(isArrary(ext))ext=ext[0];
                                                                    form.getForm().submit({
                                                                        clientValidation:true,
                                                                        method:"post",
                                                                        params: {
                                                                          'ext':ext,
                                                                          'csrf_token': Ext.util.Cookies.get('csrftoken'),
                                                                          'csrf_name': 'csrftoken',
                                                                          'csrf_xname': 'X-CSRFToken'
                                                                        },
                                                                        url:'/project/apply/doc/upload/',
                                                                        success:function (form, action) {
                                                                            alert('上传成功！');
                                                                            var txt=Ext.getCmp('project_apply_file_code');
                                                                            txt.setValue(action.result.code);
                                                                            
                                                                            form.reset();
                                                                            win.close();
                                                                        },
                                                                        failure:function (form, action) {
                                                                            if (action
                                                                                && action.hasOwnProperty('result')
                                                                                && action.result.hasOwnProperty('msg')
                                                                                && action.result.msg) {
                                                                                error(action.result.msg);
                                                                            }
                                                                            else {
                                                                                error('发生异常！');
                                                                            }
                        
                                                                            form.reset();
                                                                            win.close();
                                                                        }
                                                                    });
                                                                  }  
                                                                },
                                                                {
                                                                    text: '关闭',
                                                                    handler:function(){win.close();}
                                                                }
                                                            ]
                                                        });
                                                        win.show();
                                                    }

                                                } 
                                            ]
                                        } ]
                                }]
                            }
                        ],
                        buttons:[
                            {
                                text: '保存记录',
                                handler:function(){
                                    var frm=Ext.getCmp('prject_apply_add');
                                    // debugform(frm);
                                    // return;
                                    if (!frm.getForm().isValid()) return; 
                                    frm.getForm().submit({
                                         waitMsg: '正在提交数据',
                                         waitTitle: '提示',
                                         url: '/projectapply/add/',
                                         success: function(form, action) {
                                            if (action.result.msg != 'OK') {
                                                alert(action.result.msg);
                                            }
                                            else
                                            {
                                                alert('保存成功！')
                                            }
                                            form.reset();
                                            Main.tab_panel.remove(exisTab.id);
                                         },
                                         failure: function(form, action) {
                                            if (action
                                                && action.hasOwnProperty('result')
                                                && action.result.hasOwnProperty('msg')
                                                && action.result.msg) {
                                                error(action.result.msg);
                                            }
                                            else {
                                                error('发生异常！');
                                            }
                                            form.reset();
                                            Main.tab_panel.remove(exisTab.id);
                                         }
                                    });
                                }
                            },
                            {
                                text: '清空表单',
                                handler:function(){
                                    var from=Ext.getCmp('prject_apply_add');
                                    from.getForm().reset();
                                }
                            }
                        ]
                    }]
                });
                exisTab.show();
            }
            Main.tab_panel.setActiveTab(exisTab);
        }
        
        Main.ModifyProjectApply=function(json){
            Main.ClearTab();
            Ext.Ajax.request({
                method:'post',
                url:'/project/apply/details/',
                params:{
                    pk:json.pk
                },
                success:function(response){
                    var obj=Ext.decode(response.responseText);
                    var root = Main.tree.getRootNode();
                    Main.ShowProjectApply(obj);
                    var form=Ext.getCmp('prject_apply_add');
                    var items=form.getForm().items.items;

                    var apply=obj.apply;
                    var levelachives=obj.levelachives;
                    var finalachives=obj.finalachives;
                    var actors=obj.actors;

                    for (var i = items.length - 1; i >= 0; i--) {
                        var item=items[i];
                        if(!apply.hasOwnProperty(item.name))continue;
                        item.setValue(apply[item.name]);
                    };

                    //参与者
                    var f=Ext.getCmp('project_apply_user_add'),index;
                    for (index=1;index<actors.length;index++){
                        f.add({
                            xtype:'fieldset',
                            title: '参加者信息 '+index,
                            anchor:'80%',
                            items:[
                                {
                                  xtype : "textfield",
                                  fieldLabel:'姓名',
                                  allowBlank:false,
                                  name:'g__actor__name__'+index,
                                  anchor:'90%'
                                },
                                {
                                    xtype:'combo',
                                    mode:'local',
                                    editable:false,
                                    valueField:'name',
                                    displayField:   'name',
                                    fieldLabel : "职称",
                                    triggerAction:  'all',
                                    forceSelection: true,
                                    name: 'g__actor__job_zc__s'+index,
                                    hiddenName:'g__actor__job_zc__'+index,
                                    anchor:'50%',
                                    value:'讲师',
                                    store:new Ext.data.JsonStore({
                                        fields : ['name'],
                                        data:[
                                            {name:'讲师'},
                                            {name:'副研究员'},
                                            {name:'研究员'},
                                            {name:'副教授'},
                                            {name:'教授'}
                                        ]
                                    })
                                },
                                {
                                    xtype:'combo',
                                    mode:'local',
                                    editable:false,
                                    valueField:'name',
                                    displayField:   'name',
                                    fieldLabel : "职务",
                                    triggerAction:  'all',
                                    forceSelection: true,
                                    name: 'g__actor__job_zw__s'+index,
                                    hiddenName:'g__actor__job_zw__'+index,
                                    anchor:'50%',
                                    value:'讲师',
                                    store:new Ext.data.JsonStore({
                                        fields : ['name'],
                                        data:[
                                            {name:'司长'},
                                            {name:'副司长'},
                                            {name:'局长'},
                                            {name:'副局长'},
                                            {name:'厅长'},
                                            {name:'副厅长'}
                                        ]
                                    })
                                },
                                {
                                    xtype:'combo',
                                    mode:'local',
                                    editable:false,
                                    valueField:'name',
                                    displayField:   'name',
                                    fieldLabel : "学位",
                                    triggerAction:  'all',
                                    forceSelection: true,
                                    name: 'g__actor__degree__s'+index,
                                    hiddenName:'g__actor__degree__'+index,
                                    anchor:'50%',
                                    value:'学士',
                                    store:new Ext.data.JsonStore({
                                        fields : ['name'],
                                        data:[
                                            {name:'学士'},
                                            {name:'硕士'},
                                            {name:'博士'},
                                            {name:'博士后'}
                                        ]
                                    })
                                },
                                {
                                  xtype : "textarea",
                                  anchor:'90%',
                                  name:'g__actor__desc__'+index,
                                  allowBlank:false,
                                  fieldLabel:'近几年与本课题相关的研究成果'
                                }
                            ]
                        });
                    };
                    f.doLayout(); 

                    //最终成果
                    f=Ext.getCmp('project_apply_final_process_add');           
                    for (index=1;index<finalachives.length;index++){
                        f.add({
                            xtype:'fieldset',
                            title: '最终成果 '+index,
                            anchor:'80%',
                            items:[
                                DefaultDateFeild({
                                  fieldLabel:'完成时间',
                                  name:'g__finalachive__end_time__1',
                                  anchor:'90%'
                                }),
                                {
                                  xtype : "textfield",
                                  fieldLabel:'最 终 成 果 名称',
                                  name:'g__finalachive__name_'+index,
                                  allowBlank:false,
                                  anchor:'90%'
                                },
                                {
                                  xtype : "textarea",
                                  anchor:'90%',
                                  allowBlank:false,
                                  name:'g__finalachive__atype_'+index,
                                  fieldLabel:'成果形式'
                                },
                                {
                                  xtype : "textfield",
                                  fieldLabel:'预计字数',
                                  name:'g__finalachive__font_num_'+index,
                                  allowBlank:false,
                                  vtype:'positive',
                                  anchor:'90%'
                                },
                                {
                                  xtype : "textfield",
                                  fieldLabel:'参 加 人',
                                  name:'g__finalachive__actor_'+index,
                                  allowBlank:false,
                                  anchor:'90%'
                                }
                            ]
                        });
                    };
                    f.doLayout(); 

                    //阶段性成果 
                    f=Ext.getCmp('project_apply_pre_process_add');
                    for (index=1;index<levelachives.length;index++){                   
                        f.add({
                            xtype:'fieldset',
                            title: '阶段性成果 '+index,
                            anchor:'80%',
                            items:[
                                {
                                    xtype: 'compositefield',
                                    fieldLabel: '研究阶段(起止时间)',
                                    msgTarget : 'side',
                                    anchor    : '-20',
                                    defaults: {
                                        flex: 1
                                    },
                                    items: [
                                        DefaultDateFeild({
                                            name : 'g__levelachive__start_time__'+index,
                                            id:'papa_startdt_1',
                                            endDateField: 'papa_enddt__'+index,
                                            vtype:'daterange'
                                        }),
                                        DefaultDateFeild({
                                            vtype:'daterange',
                                            id:'papa_enddt__'+index,
                                            startDateField: 'papa_startdt__'+index,
                                            name : 'g__levelachive__end_time__'+index
                                        })
                                        
                                    ]
                                },
                                {
                                  xtype : "textfield",
                                  fieldLabel:'阶 段 成 果 名 称',
                                  allowBlank:false,
                                  name:'g__levelachive__name__'+index,
                                  anchor:'90%'
                                },
                                {
                                  xtype : "textarea",
                                  anchor:'90%',
                                  allowBlank:false,
                                  name:'g__levelachive__atype__'+index,
                                  fieldLabel:'成果形式'
                                },
                                {
                                  xtype : "textfield",
                                  fieldLabel:'承 担 人',
                                  name:'g__levelachive__apply_user__'+index,
                                  allowBlank:false,
                                  anchor:'90%'
                                }
                            ]
                        });
                    }            
                    f.doLayout(); 
                }
            })
        }

        Main.ShowProjectChangeApply=function(json){
            Main.ClearTab();
            var id='项目变更申请';
            var from_id=Ext.id();
            var exisTab = Main.tab_panel.findById(id);
            if(!exisTab) {
                exisTab = Main.tab_panel.add({
                    closable: true,
                    id: id,
                    title: id,
                    layout: {
                        type: 'fit'
                    },
                    items:[{
                        xtype:'form',
                        id:from_id,
                        anchor:'100%',
                        labelWidth: 150,
                        autoScroll: true,
                        autoHeight:true,
                        defaultType: 'textfield',
                        items:[
                            {
                                xtype:'textfield',
                                fieldLabel:'项目名称',
                                value:json.project_name,
                                readOnly:true
                            },
                            {
                                xtype:'textfield',
                                fieldLabel:'项目编号',
                                value:json.project_no,
                                readOnly:true
                            },
                            {
                                xtype:'hidden',
                                name:'pk',
                                value:json.pk,
                                readOnly:true
                            },
                            {
                                fieldLabel: '项目变更状态',
                                xtype:'localcombo',
                                name:'forward_status',
                                data:[[-6,'延期'],
                                    [-5,'撤项'],
                                    [0,'正常']],
                                listeners:{
                                    select:function(box, record, index){
                                        var show=(index==0);
                                        if(show){
                                            Ext.getCmp('project_exchage_add_date').show();
                                         }else{
                                            Ext.getCmp('project_exchage_add_date').hide();
                                         }
                                       
                                    }
                                }
                            },
                            DefaultDateFeild({
                                name : 'project_exchage_add_date',
                                id:'project_exchage_add_date',
                                vtype:'future_date'
                            }),
                            {
                                xtype:'textarea',
                                fieldLabel: '项目变更原因(限200字)',
                                name: 'applicant_opinion',
                                anchor:'85%',
                                maxLength:200
                            }
                        ],
                        buttons:[
                            {
                                text: '提交项目变更申请',
                                handler:function(){
                                    var frm=Ext.getCmp(from_id);
                                    if (!frm.getForm().isValid()) return;
                                    frm.getForm().submit({
                                         waitMsg: '正在提交数据',
                                         waitTitle: '提示',
                                         url: '/project/exchange/add/',
                                         success: function(form, action) {
                                            if (action.result.msg != 'OK') {
                                                alert(action.result.msg);
                                            }
                                            else
                                            {
                                                alert('项目变更申请已经提交');
                                            }
                                            Main.tab_panel.remove(exisTab.id);
                                         },
                                         failure: function(form, action) {
                                            if (action
                                                && action.hasOwnProperty('result')
                                                && action.result.hasOwnProperty('msg')
                                                && action.result.msg) {
                                                error(action.result.msg);
                                            }
                                            else {
                                                error('发生异常！');
                                            }
                                            //form.getForm().reset();
                                         }
                                    });
                                }
                            },
                            {
                                text: '清空表单',
                                handler:function(){
                                    var from=Ext.getCmp('prject_apply_add');
                                    from.getForm().reset();
                                }
                            }
                        ]
                    }]
                   });
                exisTab.show();
            }
            Main.tab_panel.setActiveTab(exisTab);
        }

        Main.ShowProjectRollbackApply=function(json){
            Main.ClearTab();
            var id='项目退回申请';
            var from_id=Ext.id();
            var exisTab = Main.tab_panel.findById(id);
            if(!exisTab) {
                exisTab = Main.tab_panel.add({
                    closable: true,
                    id: id,
                    title: id,
                    layout: {
                        type: 'fit'
                    },
                    items:[{
                        xtype:'form',
                        id:from_id,
                        anchor:'100%',
                        labelWidth: 150,
                        autoScroll: true,
                        autoHeight:true,
                        defaultType: 'textfield',
                        items:[
                            {
                                xtype:'textfield',
                                fieldLabel:'项目名称',
                                value:json.project_name,
                                readOnly:true
                            },
                            {
                                xtype:'textfield',
                                fieldLabel:'项目编号',
                                value:json.project_no,
                                readOnly:true
                            },
                            {
                                xtype:'hidden',
                                name:'pk',
                                value:json.pk,
                                readOnly:true
                            },
                            {
                                xtype:'hidden',
                                name:'forward_status',
                                value:-7,
                                readOnly:true
                            },
                            {
                                xtype:'textarea',
                                fieldLabel: '项目退回原因(限200字)',
                                name: 'applicant_opinion',
                                anchor:'85%',
                                maxLength:200
                            }
                        ],
                        buttons:[
                            {
                                text: '提交项目退回申请',
                                handler:function(){
                                    var frm=Ext.getCmp(from_id);
                                    if (!frm.getForm().isValid()) return;
                                    frm.getForm().submit({
                                         waitMsg: '正在提交数据',
                                         waitTitle: '提示',
                                         url: '/project/rollback/add/',
                                         success: function(form, action) {
                                            if (action.result.msg != 'OK') {
                                                alert(action.result.msg);
                                            }
                                            else
                                            {
                                                alert('项目退回申请已经提交');
                                            }

                                            Main.tab_panel.remove(id);
                                         },
                                         failure: function(form, action) {
                                            if (action
                                                && action.hasOwnProperty('result')
                                                && action.result.hasOwnProperty('msg')
                                                && action.result.msg) {
                                                error(action.result.msg);
                                            }
                                            else {
                                                error('发生异常！');
                                            }
                                         }
                                    });
                                }
                            },
                            {
                                text: '清空表单',
                                handler:function(){
                                    var from=Ext.getCmp('prject_apply_add');
                                    from.getForm().reset();
                                }
                            }
                        ]
                    }]
                   });
                exisTab.show();
            }
            Main.tab_panel.setActiveTab(exisTab);
        }

        Main.ShowProjectEndingApply=function(josn){
            Main.ClearTab();
            var exisTab = Main.tab_panel.findById('项目结项申请');
            if(!exisTab) {
                exisTab = Main.tab_panel.add({
                    closable: true,
                    id: '项目结项申请',
                    title: '项目结项申请',
                    layout: {
                        type: 'fit'
                    },
                    items:[{
                        xtype:'form',
                        id:'prject_ending_add',
                        labelWidth: 100,
                        autoScroll: true,
                        defaultType: 'textfield',
                        items: [
                            {
                                name:'project_apply_id',
                                value:josn.pk,
                                readOnly:true,
                                xtype:'hidden'
                            },
                            {
                                xtype:'fieldset',
                                title: '数据表',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                defaults:{
                                    allowBlank:false
                                },
                                items :[
                                    {
                                       columnWidth :.33, // 该列有整行中所占百分比
                                       layout : "form", // 从上往下的布局
                                       border:false,
                                       items : [{
                                          xtype : "textfield",
                                          fieldLabel : "最终成果名称",
                                          name:'final_achieve_name',
                                          allowBlank:false,
                                          anchor:'75%'
                                       }]
                                    },
                                    {
                                       columnWidth :.33, // 该列有整行中所占百分比
                                       layout : "form", // 从上往下的布局
                                       border:false,
                                       items : [{
                                          xtype : "textfield",
                                          fieldLabel : "主要参加人",
                                          name:'main_user_name',
                                          allowBlank:false,
                                          anchor:'75%'
                                       }]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                                columnWidth :.5,
                                                layout : "form", 
                                                border:false,
                                                items : [{
                                                    xtype : "textfield",
                                                    fieldLabel : "成果形式",
                                                    allowBlank:false,
                                                    anchor:'90%',
                                                    name:'achive_fomat'
                                                }]
                                            },
                                            {
                                                columnWidth :.5, 
                                                layout : "form", 
                                                border:false,
                                                items : [
                                                {
                                                    xtype:'combo',
                                                    mode:'local',
                                                    editable:false,
                                                    valueField:'name',
                                                    displayField:   'name',
                                                    fieldLabel : "研究类别",
                                                    triggerAction:  'all',
                                                    forceSelection: true,
                                                    name: 'study_type_name_s',
                                                    hiddenName:'study_type_name',
                                                    anchor:'55%',
                                                    value:'基础研究',
                                                    store:new Ext.data.JsonStore({
                                                        fields : ['name'],
                                                        data:[
                                                            {name:'基础研究'},
                                                            {name:'应用研究'},
                                                            {name:'综合研究'},
                                                            {name:'其它研究'}
                                                        ]
                                                    })
                                               }]
                                            }
                                           
                                        ]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                        items:[
                                            {
                                                columnWidth :.5,
                                                layout : "form", 
                                                border:false,
                                                items : [
                                                    DefaultDateFeild({
                                                      vtype:'future_date',
                                                      name:'plain_end_time',
                                                      fieldLabel : "计划完成时间",
                                                      anchor:'78%'
                                                   })]
                                            },
                                            {
                                                columnWidth :.5, 
                                                layout : "form", 
                                                border:false,
                                                items : [
                                                    DefaultDateFeild({
                                                      vtype:'future_date',
                                                      name:'real_end_time',
                                                      fieldLabel : "实际完成时间",
                                                      anchor:'78%'
                                                   })]
                                        }]
                                    },
                                    {
                                        layout:'column',
                                        border:false,
                                 
                                        items:[
                                            {
                                               columnWidth :.3, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "字数",
                                                  name:'font_num',
                                                  vtype:'positive',
                                                  allowBlank:false,
                                                  anchor:'85%'
                                               }]
                                            },
                                            {
                                               columnWidth :.7, // 该列有整行中所占百分比
                                               layout : "form", // 从上往下的布局
                                               border:false,
                                               items : [{
                                                  xtype : "textfield",
                                                  fieldLabel : "出版单位和时间",
                                                  name:'unit_and_time',
                                                  allowBlank:false,
                                                  anchor:'85%'

                                               }]
                                            }
                                            
                                        ]
                                    },
                                    {
                                        xtype:'textarea',
                                        fieldLabel : "使用范围去向(限400字)",
                                        anchor:'90%',
                                        name:'go_where',
                                        allowBlank:false,
                                        height:150,
                                        maxLength:400
                                    },
                                    {   
                                        xtype:'fieldset',
                                        title: '一、项目承担人的主要成果(注：成果形式为“研究报告”者填“使用单位”,限填10项)',
                                        collapsible: true,
                                        anchor:'100%',
                                        layout:"form",
                                        id:'project_end_apply_applicant_achieve_add',
                                        items:[
                                            {
                                                xtype:'fieldset',
                                                title: '成果 1',
                                                anchor:'100%',
                                                items:[
                                                    {
                                                      xtype : "textfield",
                                                      fieldLabel:'成果名称',
                                                      allowBlank:false,
                                                      name:'g__achieves__name__1',
                                                      anchor:'78%'
                                                    },
                                                    {
                                                      xtype : "textfield",
                                                      fieldLabel:'刊物年期、出版社和出版日期、使用单位',
                                                      allowBlank:false,
                                                      name:'g__achieves__unit_and_time__1',
                                                      anchor:'78%'
                                                    },
                                                    {
                                                      xtype : "textarea",
                                                      anchor:'78%',
                                                      name:'g__achieves__desc__1',
                                                      allowBlank:false,
                                                      fieldLabel:'近几年与本课题相关的研究成果'
                                                    }
                                                ]
                                            }
                                        ],
                                        buttons: [{
                                            text: '继续添加',
                                            handler:function(){
                                                var f=Ext.getCmp('project_end_apply_applicant_achieve_add');
                                                var index=f.items.length+1;
                                                if(index>10){
                                                    alert('限填10项,无法继续添加信息了！');
                                                    return;
                                                }
                                                f.add({
                                                    xtype:'fieldset',
                                                    title: '成果 '+index,
                                                    anchor:'80%',
                                                    items:[
                                                        {
                                                            xtype:'fieldset',
                                                            title: '成果 1',
                                                            anchor:'100%',
                                                            items:[
                                                                {
                                                                  xtype : "textfield",
                                                                  fieldLabel:'成果名称',
                                                                  allowBlank:false,
                                                                  name:'g__achieves__name__'+index,
                                                                  anchor:'78%'
                                                                },
                                                                {
                                                                  xtype : "textfield",
                                                                  fieldLabel:'刊物年期、出版社和出版日期、使用单位',
                                                                  allowBlank:false,
                                                                  name:'g__achieves__unit_and_time__'+index,
                                                                  anchor:'78%'
                                                                },
                                                                {
                                                                  xtype : "textarea",
                                                                  anchor:'78%',
                                                                  name:'g__achieves__desc__'+index,
                                                                  allowBlank:false,
                                                                  fieldLabel:'近几年与本课题相关的研究成果'
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                });
                                                f.doLayout(); 
                                            }

                                        },{
                                            text: '移除',
                                            handler:function(){
                                                var f=Ext.getCmp('project_end_apply_applicant_achieve_add');
                                                var index=f.items.length;
                                                if(index<=1)return;
                                                var cmp=f.items.items[index-1];
                                                f.remove(cmp,true);
                                            }
                                        }]
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '二、最终成果内容简介 ',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                items :[
                                    {
                                        xtype:'panel',
                                        border:false,
                                        html:'项目依托单位意见（意见分为四种：A、同意结项；B、未达到要求，不同意结项；C、经项目组申请，延期一年结项； D、建议撤销项目。）'
                                    },
                                    {
                                        xtype:'textarea',
                                        anchor:'100%',
                                        fieldLabel:'内容(限500字)',
                                        allowBlank:false,
                                        height:250,
                                        maxLength:500,
                                        name:'final_desc'
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '国家民委教育科技司意见 ',
                                collapsible: true,
                                collapsed:false,
                                anchor:'100%',
                                items :[
                                    {
                                        xtype:'textarea',
                                        anchor:'100%',
                                        fieldLabel:'内容(限500字)',
                                        allowBlank:false,
                                        height:250,
                                        maxLength:500,
                                        name:'mingwei_option'
                                    }
                                ]
                            },
                            {
                                xtype:'fieldset',
                                title: '附件',
                                collapsible: true,
                                labelWidth:300,
                                autoHeight:true,
                                items :[{
                                        layout:'column',
                                        border:false,
                                        anchor:'100%',
                                        items:[{
                                            columnWidth :.6, 
                                            layout : "form", 
                                            border:false,
                                            items : [{
                                              xtype : "textfield",
                                              id:'project_end_apply_file_code',
                                              fieldLabel : '文档编号(上传项目申请书后自动生成)',
                                              allowBlank:false,
                                              width:250,
                                              readOnly:true,
                                              name:'file_code'
                                            }]
                                        },
                                        {
                                            columnWidth :.4, 
                                            layout : "form", 
                                            border:false,
                                            items : [
                                                {
                                                    xtype : "button",
                                                    text : "上传项目结项申请书",
                                                    handler:function(){
                                                        var form = new Ext.form.FormPanel({
                                                            baseCls: 'x-plain',
                                                            labelWidth: 80,
                                                            fileUpload:true,
                                                            items: [{
                                                                xtype: 'fileuploadfield',
                                                                anchor: '90%',
                                                                name: 'file',  
                                                                allowBlank:false,
                                                                listeners:{ 
                                                                    fileselected:function(input,value){
                                                                        var ext=/\.[^\.]+$/.exec(value);
                                                                        if(ext!='.doc'&&ext!='.docx'){
                                                                             alert('请选择有效的Word文件！');
                                                                             input.reset();
                                                                        }
                                                                       
                                                                    }
                                                                }
                                                            }]
                                                        });

                                                        var win = new Ext.Window({
                                                            title: '上传填写完整的Word文档',
                                                            width: 400,
                                                            height:200,
                                                            minWidth: 300,
                                                            minHeight: 100,
                                                            layout: 'fit',
                                                            plain:true,
                                                            bodyStyle:'padding:5px;',
                                                            items: form,
                                                            buttons: [
                                                                {
                                                                  xtype : "button",
                                                                  text : "上传",
                                                                  handler:function(){
                                                                    if(!form.getForm().isValid())return;
                                                                    var ext=/\.[^\.]+$/.exec(form.items.items[0].value);
                                                                    if(isArrary(ext))ext=ext[0];
                                                                    form.getForm().submit({
                                                                        clientValidation:true,
                                                                        method:"post",
                                                                        params: {
                                                                          'ext':ext,
                                                                          'csrf_token': Ext.util.Cookies.get('csrftoken'),
                                                                          'csrf_name': 'csrftoken',
                                                                          'csrf_xname': 'X-CSRFToken'
                                                                        },
                                                                        url:'/project/apply/doc/upload/',
                                                                        success:function (form, action) {
                                                                            alert('上传成功！');
                                                                            var txt=Ext.getCmp('project_end_apply_file_code');
                                                                            txt.setValue(action.result.code);
                                                                            
                                                                            form.reset();
                                                                            win.close();
                                                                        },
                                                                        failure:function (form, action) {
                                                                            if (action
                                                                                && action.hasOwnProperty('result')
                                                                                && action.result.hasOwnProperty('msg')
                                                                                && action.result.msg) {
                                                                                error(action.result.msg);
                                                                            }
                                                                            else {
                                                                                error('发生异常！');
                                                                            }
                        
                                                                            form.reset();
                                                                            win.close();
                                                                        }
                                                                    });
                                                                  }  
                                                                },
                                                                {
                                                                    text: '关闭',
                                                                    handler:function(){win.close();}
                                                                }
                                                            ]
                                                        });
                                                        win.show();
                                                    }
                                                } 
                                            ]
                                        }]
                                }]
                            }
                        ],
                        buttons:[
                            {
                                text: '提交项目结项申请',
                                handler:function(){
                                    var frm=Ext.getCmp('prject_ending_add');
                                    // debugform(frm);
                                    // return;
                                    if (!frm.getForm().isValid()) return; 
                                    frm.getForm().submit({
                                         waitMsg: '正在提交数据',
                                         waitTitle: '提示',
                                         url: '/project/end/add/',
                                         success: function(form, action) {
                                            if (action.result.msg != 'OK') {
                                                alert(action.result.msg);
                                            }
                                            else{
                                                alert('保存成功！')
                                            }
                                            Main.tab_panel.remove(exisTab.id);
                                         },
                                         failure: function(form, action) {
                                            if (action
                                                && action.hasOwnProperty('result')
                                                && action.result.hasOwnProperty('msg')
                                                && action.result.msg) {
                                                error(action.result.msg);
                                            }
                                            else {
                                                error('发生异常！');
                                            }
                                         }
                                    });
                                }
                            },
                            {
                                text: '清空表单',
                                handler:function(){
                                    var from=Ext.getCmp('prject_ending_add');
                                    from.getForm().reset();
                                }
                            }
                        ]
                    }]
                   });
                exisTab.show();
            }
            Main.tab_panel.setActiveTab(exisTab);
        }

        root.appendChild({
            text:'我的项目',
            leaf:true,
            list:{
                id:'my_project_grid',
                url:"/project/apply/list/",
                columes:[
                    {
                        header:'项目名称',
                        dataIndex:'project_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {
                        header:'结项时间',
                        dataIndex:'project_comple_time',
                        flex:1,
                        renderer:function(value, cellmeta, record, rowIndex, columnIndex, store){
                            return record.data.status==1?value:'';
                        }
                    },
                    {header:'审核状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {
                        header:'预警状态',
                        dataIndex:'pk',
                        flex:1,
                        renderer:function(value, cellmeta, record, rowIndex, columnIndex, store){
                            for (var i = Main.WaringProjects.length - 1; i >= 0; i--) {
                                if(Main.WaringProjects[i]==value){
                                    return "预警";
                                }
                            };
                        }
                    },
                    {header:'学科分类', dataIndex:'study_type_name', flex:1},
                    {header:'PDF',flex:1,dataIndex:'pk', width:50,
                        renderer:function(value){
                           return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    }
                ],
                listeners:{
                    cellclick:DefaultCellHanlder({
                        applyPdfIdx:7,
                        applyIdx:1
                    })
                },
                tbar:[
                    {
                        text:'项目退回申请',
                        iconCls:'Applicationadd',
                        handler:function () {
                            var grid=Ext.getCmp('my_project_grid');
                            var sel= grid.getJsonArr();
                            if(sel&&sel.length!=1){
                                alert('请单选需要退回的项目！');
                                return;
                            }
                            var json=sel[0].json;
                            if(json.status==-2||json.status==-1)
                            {
                                Main.ShowProjectRollbackApply(sel[0].json);
                            }
                            else
                            {
                                alert('无法对项目执行退回操作！');
                            }
                        }
                    },
                    {
                        text:'项目变更申请',
                        iconCls:'Applicationedit',
                        handler:function () {
                            var grid=Ext.getCmp('my_project_grid');
                            var sel= grid.getJsonArr();
                            if(sel.length!=1){
                                alert('请单选需要变更的项目！');
                                return;
                            }

                            if(sel[0].json.status!=1)
                            {
                                alert('必须立项的项目方可进行该操作！');
                                return;
                            }

                            Main.ShowProjectChangeApply(sel[0].json);
                        }
                    },
                    {
                        text:'项目结项申请',
                        iconCls:'Applicationget',
                        handler:function () {
                            var grid=Ext.getCmp('my_project_grid');
                            var sel= grid.getJsonArr();
                            if(sel.length!=1){
                                alert('请单选需要退回的项目！');
                                return;
                            }

                            if(sel[0].json.status!=1)
                            {
                                alert('必须立项的项目方可进行该操作！');
                                return;
                            }
                            Main.ShowProjectEndingApply(sel[0].json);
                        }
                    },
                    {
                        text:'查看审核历史记录',
                        iconCls:'Bookopen',
                        handler:function(){
                            var grid=Ext.getCmp('my_project_grid');
                            Main.ShowProjectEndApproveHistroy(grid);
                        }
                    }
                ]
            }
        });

        root.appendChild({
            text:'新建项目',
            leaf:true,
            list:{
                url:"/project/apply/list/",
                baseParams:{
                    waitsubmit:true
                },
                id:'my_project_apply_id',
                columes:[
                    {
                        header:'项目名称',
                        dataIndex:'project_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {header:'学科分类', dataIndex:'study_type_name', flex:1},
                    {header:'PDF',flex:1,dataIndex:'pk', width:50,
                        renderer:function(value){
                           return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    }
                ],
                listeners:{
                    cellclick:DefaultCellHanlder({
                        applyPdfIdx:7,
                        applyIdx:1
                    })
                },
                tbar:[
                    {
                        text:'项目立项申请',
                        iconCls:'Applicationadd',
                        handler:function () {
                            Main.ShowProjectApply();
                        }
                    },
                    {
                        text:'项目修改',
                        iconCls:'Applicationedit',
                        handler:function () {
                            var grid=Main.CurrentGrid();
                            var sel= grid.getIdArr();
                            if(sel.length!=1){
                                alert('请单选需要修改的项目！');
                                return;
                            }
                            var json=sel[0].json;
                            Main.ModifyProjectApply(json);
                        }
                    },
                    {
                        text:'提交项目申请',
                        iconCls:'Applicationget',
                        handler:function () {
                            var grid=Main.CurrentGrid();
                            var sel= grid.getIdArr();
                            Ext.Ajax.request({
                                url:"/project/apply/submit/",
                                method:'post',
                                params:{
                                    ids:sel.join()
                                },
                                success:function(response){
                                    alert('项目已经提交，等待二级管理员审核！');
                                    grid.getStore().reload();
                                }
                            });
                        }
                    }
                ]
            }
        });
        
        node = {
            text:'事务记录',
            expanded:true,
            leaf:false,
            children:[]
        };

        node.children.push({
            text:'变更',
            leaf:true,
            list:{
                id:'applicant_project_exchange_gird',
                url:"/project/exchange/list/",
                columes:[
          
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'项目状态', dataIndex:'project_status', flex:1, renderer:XG.Render.ProjectStatus },
                    {header:'申请变更状态', dataIndex:'forward_status', flex:1, renderer:XG.Render.ProjectStatus },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {dataIndex:'applicant_opinion'}
                ],

                tbar:[{
                    text:'查看审核历史记录',
                    iconCls:'Bookopen',
                    handler:function(){
                        var grid=Ext.getCmp('applicant_project_exchange_gird');
                        Main.ShowProjectExchangeApproveHistory(grid);
                    }
                }],
                viewConfig:{
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>申请原因: '+record.data.applicant_opinion+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                }
            }
            
        });
        


        node.children.push({
            text:'结项',
            leaf:true,
            list:{
                id:'applicant_project_end_gird',
                url:"/project/end/list/",
                columes:[
                    {
                        header:'最终成果名称', 
                        dataIndex:'final_achieve_name', 
                        flex:1,
                        renderer:function(value){
                           return '<img src="/static/icons/zoom.png"/>'+value;
                        }.createDelegate(this)
                    },
                    {header:'项目编号', dataIndex:'project__no', flex:1},
                    {header:'主要参加人', dataIndex:'main_user_name', flex:1 },
                    {header:'计划完成时间', dataIndex:'plain_end_time', flex:1 },
                    {header:'实际完成时间', dataIndex:'real_end_time', flex:1 },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {header:'PDF',flex:1,dataIndex:'document_id', width:50,
                        renderer:function(value){
                           return '<img src="/static/icons/page_white_acrobat.png"/>';
                        }.createDelegate(this)
                    }
                ],
                listeners:{
                    cellclick:DefaultCellHanlder({
                        pdfIdx:7,
                        applyIdx:1
                    })
                },
                tbar:[{
                    text:'查看审核历史记录',
                    iconCls:'Bookopen',
                    handler:function(){
                        var grid=Ext.getCmp('applicant_project_end_gird');
                        Main.ShowProjectEndApproveHistroy(grid);
                    }
                }]
            }
        });
        

        node.children.push({
            text:'退回',
            leaf:true,
            list:{
                id:'applicant_project_back_gird',
                url:"/project/rollback/list/",
                columes:[
                    {header:'项目名称', dataIndex:'project_name', flex:1},
                    {header:'项目类型', dataIndex:'project_type__name', flex:1 },
                    {header:'项目编号', dataIndex:'project_no', flex:1 },
                    {header:'申请时间', dataIndex:'applicant_time', flex:1 },
                    {header:'状态', dataIndex:'status', flex:1, renderer:XG.Render.ApproveStatus},
                    {dataIndex:'applicant_opinion'}
                ],

                viewConfig:{
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>申请原因: '+record.data.applicant_opinion+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                },
                tbar:[{
                    text:'查看审核历史记录',
                    iconCls:'Bookopen',
                    handler:function(){
                        var grid=Ext.getCmp('applicant_project_back_gird');
                        Main.ShowProjectRollbackApproveHistroy(grid);
                    }
                }]
            }
        });

        root.appendChild(node);

        node = {
            text:'消息管理',
            expanded:true,
            leaf:false,
            children:[]
        };

   

        node.children.push({
            text:'系统消息',
            leaf:true,
            list:{
                id:'wait_pub_message_list',
                url:"/message/list/",
                columes:[
                    {header:'消息标题', dataIndex:'title', flex:1},
                    {header:'消息摘要', dataIndex:'abstract', flex:1 },
                    {header:'发送时间', dataIndex:'send_time', flex:1 },
                    {header:'发送人', dataIndex:'sender_name', flex:1 },
                    {header:'发送人姓名', dataIndex:'sender_real_name', flex:1 },
                    {header:'发送人部门', dataIndex:'sender_unit__name', flex:1 },
                    {dataIndex:'content'}
                ],
                viewConfig: {
                    forceFit:true,
                    enableRowBody:true,
                    showPreview:true,
                    getRowClass : function(record, rowIndex, p, store){
                        if(this.showPreview){
                            p.body = '<p>消息内容: '+record.data.content+'</p>';
                            return 'x-grid3-row-expanded';
                        }
                        return 'x-grid3-row-collapsed';
                    }
                }
            }
        });

        root.appendChild(node);
    });
</script>
{%endifequal%}
{% endblock %}

